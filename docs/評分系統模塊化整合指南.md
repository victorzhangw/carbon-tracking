# 📦 評分系統模塊化整合指南

## 🎯 模塊化結構

評分系統已經模塊化為以下文件：

```
static/
├── css/
│   └── score_report.css          # 評分報告樣式
└── js/
    └── score_manager.js           # 評分管理器

templates/
└── score_report_modal.html        # 評分報告彈窗 HTML
```

## 🔧 整合步驟

### 步驟 1: 在 `emotion_analysis.html` 的 `<head>` 中添加 CSS

**位置**: `<head>` 標籤內，其他 CSS 之後

```html
<!-- 評分系統樣式 -->
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/score_report.css') }}"
/>
```

### 步驟 2: 在錄音控制區域添加停止對話按鈕

**位置**: 找到 `id="stopRecord"` 的按鈕，在其後添加

**原代碼**（約第 434-437 行）:

```html
<button id="stopRecord" class="btn btn-danger" disabled>⏹️ 停止錄音</button>
```

**添加**:

```html
<button id="stopRecord" class="btn btn-danger" disabled>⏹️ 停止錄音</button>
<!-- 新增：停止對話按鈕 -->
<button id="endSession" class="btn btn-end-session" disabled>
  🏁 結束對話
</button>
```

### 步驟 3: 在 `</body>` 前引入評分報告彈窗

**位置**: `</body>` 標籤之前

```html
<!-- 評分報告彈窗 -->
{% include 'score_report_modal.html' %}

<!-- 評分系統 JS -->
<script src="{{ url_for('static', filename='js/score_manager.js') }}"></script>
```

### 步驟 4: 在現有 JavaScript 中初始化評分管理器

**位置**: 在 `<script>` 標籤內，所有變量聲明之後

**添加全局變量**:

```javascript
// 評分系統管理器
let scoreManager = null;
```

**在 DOMContentLoaded 事件中初始化**:

```javascript
window.addEventListener("DOMContentLoaded", () => {
  // 初始化評分管理器
  scoreManager = new ScoreManager();
  window.scoreManager = scoreManager; // 設為全局變量

  // 原有的初始化代碼
  showWeatherGreeting();
});
```

### 步驟 5: 在對話處理邏輯中添加記錄

**位置 A**: 在顯示用戶訊息後（約第 1189 行）

**原代碼**:

```javascript
if (result.transcript) {
  addUserMessage(result.transcript);
} else {
  addUserMessage("（無法識別語音內容）");
}
```

**修改為**:

```javascript
if (result.transcript) {
  addUserMessage(result.transcript);
  // 記錄用戶對話
  if (scoreManager) {
    scoreManager.recordConversation(
      "user",
      result.transcript,
      result.sentiment,
      0.8
    );
  }
} else {
  addUserMessage("（無法識別語音內容）");
}
```

**位置 B**: 在顯示 AI 回應後（約第 1210 行）

**原代碼**:

```javascript
const responseText = result.response || "抱歉，我現在無法回應。";

// 等待打字機效果完成
await addAIMessage(responseText, emotionInfo, true);
```

**修改為**:

```javascript
const responseText = result.response || "抱歉，我現在無法回應。";

// 等待打字機效果完成
await addAIMessage(responseText, emotionInfo, true);

// 記錄 AI 對話
if (scoreManager) {
  scoreManager.recordConversation("ai", responseText, result.sentiment, 0.9);
}
```

## 📝 完整的修改清單

### 1. 在 `<head>` 中添加（1 行）

```html
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/score_report.css') }}"
/>
```

### 2. 在錄音控制區域添加（3 行）

```html
<button id="endSession" class="btn btn-end-session" disabled>
  🏁 結束對話
</button>
```

### 3. 在 `</body>` 前添加（4 行）

```html
{% include 'score_report_modal.html' %}
<script src="{{ url_for('static', filename='js/score_manager.js') }}"></script>
```

### 4. 在 JavaScript 中添加（約 20 行）

#### 4.1 全局變量

```javascript
let scoreManager = null;
```

#### 4.2 初始化

```javascript
scoreManager = new ScoreManager();
window.scoreManager = scoreManager;
```

#### 4.3 記錄用戶對話（5 行）

```javascript
if (scoreManager) {
  scoreManager.recordConversation(
    "user",
    result.transcript,
    result.sentiment,
    0.8
  );
}
```

#### 4.4 記錄 AI 對話（5 行）

```javascript
if (scoreManager) {
  scoreManager.recordConversation("ai", responseText, result.sentiment, 0.9);
}
```

## 🧪 測試步驟

### 1. 重啟 Flask 服務器

```bash
# 停止當前服務器（Ctrl+C）
# 重新啟動
python app.py
```

### 2. 訪問情緒識別系統

```
http://localhost:5000/emotion-analysis
```

### 3. 測試流程

1. ✅ 頁面載入，檢查控制台是否有 "✅ 評分系統初始化完成"
2. ✅ 確認「結束對話」按鈕存在但禁用
3. ✅ 進行至少 1 輪對話
4. ✅ 確認「結束對話」按鈕已啟用
5. ✅ 點擊「結束對話」按鈕
6. ✅ 確認彈出確認對話框
7. ✅ 確認後查看評分報告彈窗
8. ✅ 檢查雷達圖、評分卡片、建議等是否正確顯示
9. ✅ 點擊「關閉」按鈕
10. ✅ 確認彈窗關閉，會話重新初始化

### 4. 檢查控制台日誌

應該看到類似的日誌：

```
📊 初始化評分系統...
✅ 評分系統初始化完成
✅ 會話已初始化: xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx
📝 記錄對話 #1: user - 你好，今天天氣很好...
📝 記錄對話 #2: ai - 您好！今天確實是個好天氣呢...
📊 顯示評分報告: {scores: {...}, ...}
```

## 🎯 功能驗證

### 必須通過的測試

- [ ] CSS 樣式正確載入
- [ ] 停止對話按鈕顯示
- [ ] 評分管理器初始化成功
- [ ] 對話記錄功能正常
- [ ] 停止對話按鈕在對話後啟用
- [ ] 點擊按鈕顯示確認對話框
- [ ] 評分報告正確生成
- [ ] 評分報告彈窗正確顯示
- [ ] 雷達圖正確繪製
- [ ] 評分卡片正確顯示
- [ ] 改進建議正確顯示
- [ ] 統計資訊正確顯示
- [ ] 關閉按鈕正常工作
- [ ] 會話重新初始化

## 🐛 常見問題

### 問題 1: 停止對話按鈕不顯示

**原因**: CSS 未正確載入  
**解決**: 檢查 CSS 文件路徑，確認 Flask 靜態文件配置

### 問題 2: 點擊按鈕沒有反應

**原因**: JavaScript 未正確載入或初始化失敗  
**解決**:

1. 檢查瀏覽器控制台是否有錯誤
2. 確認 `scoreManager` 已正確初始化
3. 檢查 `score_manager.js` 文件路徑

### 問題 3: 評分報告不顯示

**原因**: API 請求失敗或彈窗 HTML 未載入  
**解決**:

1. 檢查 Network 標籤，確認 `/api/end-session` 請求成功
2. 確認 `score_report_modal.html` 已正確引入
3. 檢查控制台錯誤訊息

### 問題 4: 雷達圖不顯示

**原因**: Canvas 元素未找到或繪製失敗  
**解決**:

1. 確認 `<canvas id="scoreRadarChart"></canvas>` 存在
2. 檢查控制台是否有 Canvas 相關錯誤

## 📊 模塊化優勢

### 優點

✅ **代碼分離**: CSS、JS、HTML 分別管理  
✅ **易於維護**: 修改某個模塊不影響其他部分  
✅ **可重用**: 評分系統可用於其他頁面  
✅ **文件大小**: 主 HTML 文件保持精簡  
✅ **緩存友好**: 靜態資源可被瀏覽器緩存  
✅ **團隊協作**: 不同人可以同時修改不同模塊

### 文件大小對比

- **原方案**: emotion_analysis.html ~3000+ 行
- **模塊化後**:
  - emotion_analysis.html ~2500 行（減少 500 行）
  - score_report.css ~300 行
  - score_manager.js ~400 行
  - score_report_modal.html ~80 行

## 🎉 完成標誌

當你看到以下內容時，表示整合成功：

1. ✅ 頁面正常載入，無控制台錯誤
2. ✅ 停止對話按鈕正確顯示
3. ✅ 對話後按鈕啟用
4. ✅ 點擊按鈕顯示評分報告
5. ✅ 評分報告內容完整且美觀
6. ✅ 所有交互功能正常

---

**文檔版本**: 1.0  
**創建日期**: 2025-11-21  
**狀態**: 待整合  
**預計整合時間**: 10-15 分鐘
