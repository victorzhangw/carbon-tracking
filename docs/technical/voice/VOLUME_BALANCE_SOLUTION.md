# 音量忽高忽低問題解決方案

## 🎯 問題分析

### 為什麼分離出來的個人音量忽高忽低？

1. **簡單頻率分割的問題**：

   - 之前的方法只是基於頻率範圍分割
   - 沒有考慮每個說話者的實際音量特性
   - 分離遮罩過於粗糙，導致音量不穩定

2. **缺乏音量正規化**：

   - 沒有對分離後的音頻進行音量平衡
   - 不同時間段的能量差異很大
   - 缺少動態範圍控制

3. **遮罩切換過於突兀**：
   - 說話者切換時音量突然變化
   - 沒有平滑的過渡處理
   - 背景能量保留不足

## ✅ 解決方案

### 🔊 音量平衡版本的改進

#### 1. **智能說話者分離**

```python
# 使用多維特徵進行聚類
features = [MFCC, F0, 頻譜重心, RMS能量]
# 基於能量閾值的語音活動檢測
# K-means 聚類識別說話者
```

#### 2. **音量正規化處理**

```python
def normalize_speaker_volume(audio, target_rms=0.02):
    current_rms = np.sqrt(np.mean(audio ** 2))
    normalization_factor = target_rms / current_rms
    normalized_audio = audio * normalization_factor
```

#### 3. **動態範圍壓縮**

```python
def apply_dynamic_range_compression(y, threshold=0.1, ratio=3.0):
    # 壓縮超過閾值的音量
    # 平滑音量變化
    # 保持自然動態
```

#### 4. **音量平滑處理**

```python
def apply_volume_smoothing(y, sr, window_size=0.1):
    # 計算短時 RMS 包絡
    # 平滑音量變化
    # 限制增益變化範圍 (0.5-2.0)
```

#### 5. **平滑遮罩創建**

```python
# 使用 sigmoid 函數創建平滑過渡
mask = 1 / (1 + np.exp(-8 * (mask - 0.5)))
# 確保最小背景保留 (5%)
mask = np.maximum(mask, 0.05)
```

## 📊 技術對比

| 處理方面       | 原始方法     | 音量平衡版本          |
| -------------- | ------------ | --------------------- |
| **分離方法**   | 簡單頻率分割 | 多維特徵聚類          |
| **音量處理**   | 無           | RMS 正規化 + 動態壓縮 |
| **遮罩平滑**   | 基本平滑     | Sigmoid + 背景保留    |
| **音量穩定性** | 忽高忽低     | 穩定平衡              |
| **過渡效果**   | 突兀切換     | 平滑過渡              |

## 🎵 輸出檔案說明

### 📁 `TTS/volume_balanced_audio/`

#### 🎯 **推薦使用**：

1. **`04_speaker_1_volume_balanced.wav`** - 說話者 1 音量平衡版

   - ✅ 穩定的音量水平
   - ✅ 平滑的音量過渡
   - ✅ 動態範圍壓縮

2. **`04_speaker_2_volume_balanced.wav`** - 說話者 2 音量平衡版

   - ✅ 同樣的音量平衡處理
   - ✅ 消除突兀變化

3. **`05_all_speakers_volume_balanced.wav`** - 整體音量平衡版
   - ✅ 兩個說話者的平衡混合
   - ✅ 統一的音量水平

#### 📊 **對比檔案**：

- `03_speaker_X_raw.wav` - 原始分離版本（音量不穩定）
- `02_noise_reduced.wav` - 去噪版本
- `01_original.wav` - 原始檔案

## 🔧 技術細節

### 音量平衡處理流程：

1. **特徵提取** → 多維語音特徵分析
2. **智能分離** → 基於特徵的說話者聚類
3. **遮罩創建** → 平滑的說話者遮罩
4. **音頻分離** → 應用遮罩分離音頻
5. **音量正規化** → 統一 RMS 能量水平
6. **動態壓縮** → 控制動態範圍
7. **音量平滑** → 消除突兀變化

### 關鍵參數：

- **目標 RMS**: 0.02 (統一音量水平)
- **壓縮比**: 3:1 (動態範圍控制)
- **平滑窗口**: 0.1 秒 (音量過渡)
- **增益限制**: 0.5-2.0 (防止過度調整)

## 💡 使用建議

### 🎯 **最佳選擇**：

**`04_speaker_X_volume_balanced.wav`**

### 🔍 **效果驗證**：

1. 試聽原始分離版本 (`03_speaker_X_raw.wav`)
2. 對比音量平衡版本 (`04_speaker_X_volume_balanced.wav`)
3. 注意音量穩定性的改善

### 📈 **預期改善**：

- ✅ 音量不再忽高忽低
- ✅ 說話者切換更平滑
- ✅ 整體聽感更舒適
- ✅ 動態範圍適中

## 🎉 結論

**音量平衡版本成功解決了分離後個人音量忽高忽低的問題**，通過：

1. **智能分離算法** - 更準確的說話者識別
2. **音量正規化** - 統一的音量水平
3. **動態範圍壓縮** - 控制音量變化幅度
4. **平滑處理** - 消除突兀的音量跳躍

現在的 `04_speaker_X_volume_balanced.wav` 檔案應該具有穩定、平衡的音量特性！
