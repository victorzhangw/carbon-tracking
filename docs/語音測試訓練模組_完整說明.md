# 語音測試訓練模組 - 完整說明文檔

**模組版本**: 1.0  
**文檔日期**: 2025-11-21  
**模組狀態**: ✅ 已部署運行

---

## 📋 模組概述

語音測試訓練模組是專為語音技術開發和測試設計的工具集，提供語音分析和聲音模擬兩大核心功能。本模組主要供開發人員和技術人員使用，用於語音模型的評估、優化和測試。

### 核心定位

- 🔬 **技術工具** - 面向開發人員和技術人員
- 🧪 **測試平台** - 用於語音技術的測試和驗證
- 📊 **分析工具** - 提供語音特徵分析和評估
- 🎛️ **訓練輔助** - 協助語音模型的訓練和優化

### 與其他模組的區別

| 模組             | 定位     | 目標用戶 | 主要用途         |
| ---------------- | -------- | -------- | ---------------- |
| 語音測試訓練模組 | 技術工具 | 開發人員 | 測試、分析、訓練 |
| 智慧語音關懷系統 | 業務應用 | 終端用戶 | 長者關懷服務     |
| 語音互動系統     | 用戶服務 | 終端用戶 | 即時語音對話     |
| 語音克隆系統     | 技術應用 | 技術人員 | 語音模型生成     |

---

## 🏗️ 模組架構

### 整體結構

```
語音測試訓練模組
│
├── 語音分析
│   ├── 情緒識別（基礎）
│   │   └── 基於 librosa 的特徵分析
│   ├── 情緒識別（進階）
│   │   └── 基於 Wav2Vec2 的深度學習
│   ├── 批次分析
│   │   └── 多檔案批量處理
│   └── 即時分析
│       └── 上傳即時分析
│
└── 聲音模擬
    ├── TTS 生成
    │   └── GPT-SoVITS 語音合成
    ├── 參考音頻管理
    │   └── 音頻文件選擇和管理
    └── 語速控制
        └── 可調整的語音參數
```

---

## 🎯 功能一：語音分析

### 1.1 情緒識別（基礎版）

**技術基礎**: librosa 音頻特徵提取

**分析維度**:

- 音調（Pitch）
- 能量（Energy）
- 語速（Speaking Rate）
- 音色（Timbre）

**支援的情緒類型**:

- 😊 快樂（Happy）
- 😢 悲傷（Sad）
- 😠 憤怒（Angry）
- 😐 中性（Neutral）
- 😨 恐懼（Fear）

**API 端點**:

```
POST /api/emotion/analyze/<audio_id>
Body: { "method": "basic" }
```

**使用場景**:

- 快速情緒評估
- 輕量級分析需求
- 不需要深度學習模型的場景

**優點**:

- ✅ 快速（< 1 秒）
- ✅ 輕量級（無需 GPU）
- ✅ 穩定可靠

**限制**:

- ⚠️ 準確度中等（約 70-75%）
- ⚠️ 對複雜情緒識別能力有限

### 1.2 情緒識別（進階版）

**技術基礎**: Wav2Vec2 深度學習模型

**模型特點**:

- 預訓練的語音表示模型
- 端到端的情緒識別
- 更高的準確度

**支援的情緒類型**:

- 😊 快樂（Happy）
- 😢 悲傷（Sad）
- 😠 憤怒（Angry）
- 😐 中性（Neutral）
- 😨 恐懼（Fear）
- 😲 驚訝（Surprise）
- 🤢 厭惡（Disgust）

**API 端點**:

```
POST /api/emotion/analyze/<audio_id>
Body: { "method": "advanced" }
```

**使用場景**:

- 高精度情緒識別需求
- 複雜情緒分析
- 研究和開發用途

**優點**:

- ✅ 高準確度（約 85-90%）
- ✅ 支援更多情緒類型
- ✅ 對複雜情緒識別能力強

**限制**:

- ⚠️ 需要較長處理時間（2-5 秒）
- ⚠️ 需要較多計算資源
- ⚠️ 模型需要預先載入

### 1.3 批次分析

**功能描述**: 一次性分析多個音頻文件

**API 端點**:

```
POST /api/emotion/batch-analyze
Body: {
  "audio_ids": ["id1", "id2", "id3"],
  "method": "basic" | "advanced"
}
```

**使用場景**:

- 大量音頻文件的情緒分析
- 數據集標註
- 批量質量檢查

**特點**:

- 支援任意數量的音頻文件
- 自動錯誤處理
- 返回詳細的分析結果

### 1.4 即時分析

**功能描述**: 上傳音頻文件並立即進行分析

**API 端點**:

```
POST /api/emotion/upload-and-analyze
Form Data:
  - file: 音頻文件
  - method: "basic" | "advanced"
```

**使用場景**:

- 快速測試
- 臨時音頻分析
- 不需要保存音頻文件的場景

**特點**:

- 無需預先上傳到系統
- 分析後自動清理臨時文件
- 支援多種音頻格式

### 1.5 模型管理

**功能描述**: 管理情緒識別模型的載入和狀態

**API 端點**:

```
GET  /api/emotion/models/status        # 獲取模型狀態
POST /api/emotion/models/load-advanced # 載入進階模型
```

**模型狀態**:

- 基礎模型：始終可用
- 進階模型：需要手動載入

---

## 🎨 功能二：聲音模擬

### 2.1 TTS 生成

**技術基礎**: GPT-SoVITS v4

**功能描述**: 將文字轉換為自然流暢的語音

**API 端點**:

```
POST /simple_tts/generate
Body: {
  "text": "要轉換的文字",
  "ref_audio_path": "參考音頻路徑",
  "ref_text": "參考文字",
  "speed": 1.0
}
```

**參數說明**:

- `text`: 要合成的文字內容
- `ref_audio_path`: 參考音頻文件路徑（用於聲音克隆）
- `ref_text`: 參考音頻的文字內容
- `speed`: 語速調整（0.5 - 2.0）

**使用場景**:

- 語音合成測試
- 音色效果評估
- TTS 模型驗證

**特點**:

- ✅ 高品質語音合成
- ✅ 支援聲音克隆
- ✅ 可調整語速
- ✅ 多語言支援

### 2.2 參考音頻管理

**功能描述**: 管理和選擇參考音頻文件

**API 端點**:

```
GET /simple_tts/list_ref_audio
```

**返回資訊**:

```json
{
  "status": "success",
  "audio_files": [
    {
      "path": "路徑",
      "name": "檔名",
      "type": "mockvoice | uploaded"
    }
  ],
  "total": 10
}
```

**音頻來源**:

1. **mockvoice 目錄**: 預設的參考音頻
2. **audio_uploads 目錄**: 用戶上傳的音頻

**使用場景**:

- 選擇合適的參考音頻
- 管理音頻資源
- 測試不同音色效果

### 2.3 語速控制

**功能描述**: 調整生成語音的語速

**參數範圍**: 0.5 - 2.0

- 0.5: 慢速（適合學習）
- 1.0: 正常速度
- 1.5: 快速
- 2.0: 極快

**實現方式**:

- 通過調整 GPT-SoVITS 的 temperature 參數
- `temperature = 1.0 + (speed - 1.0) * 0.5`

**使用場景**:

- 測試不同語速效果
- 適應不同用戶需求
- 語音品質評估

### 2.4 演示頁面

**路徑**: `/simple_tts/demo`  
**模板**: `templates/simple_tts_demo.html`

**功能**:

- 文字輸入
- 參考音頻選擇
- 語速調整
- 即時生成和播放

---

## 📊 技術規格

### 語音分析技術規格

#### 基礎情緒識別

| 項目         | 規格                     |
| ------------ | ------------------------ |
| 技術         | librosa + 機器學習       |
| 處理時間     | < 1 秒                   |
| 準確度       | 70-75%                   |
| 支援格式     | WAV, MP3, OGG, FLAC, M4A |
| 最大文件大小 | 50 MB                    |
| 最短音頻長度 | 1 秒                     |
| 最長音頻長度 | 300 秒                   |

#### 進階情緒識別

| 項目         | 規格                     |
| ------------ | ------------------------ |
| 技術         | Wav2Vec2 深度學習        |
| 處理時間     | 2-5 秒                   |
| 準確度       | 85-90%                   |
| 支援格式     | WAV, MP3, OGG, FLAC, M4A |
| 最大文件大小 | 50 MB                    |
| 模型大小     | ~300 MB                  |
| GPU 加速     | 支援（可選）             |

### 聲音模擬技術規格

| 項目         | 規格                     |
| ------------ | ------------------------ |
| 技術         | GPT-SoVITS v4            |
| 處理時間     | 3-8 秒（取決於文字長度） |
| 音頻格式     | WAV (16-bit PCM, 32kHz)  |
| 最大文字長度 | 500 字符                 |
| 語速範圍     | 0.5 - 2.0                |
| 支援語言     | 中文、英文、日文、韓文   |
| 音色克隆     | 支援                     |

---

## 🚀 使用指南

### 快速開始

#### 1. 啟動服務

```bash
# 使用啟動腳本
bStart.bat

# 或手動啟動
python app.py
```

#### 2. 訪問演示頁面

```
# 聲音模擬演示
http://localhost:5000/simple_tts/demo
```

### API 使用示例

#### 情緒分析示例

```python
import requests

# 基礎情緒分析
response = requests.post(
    'http://localhost:5000/api/emotion/analyze/audio_id_123',
    json={'method': 'basic'}
)
result = response.json()
print(f"情緒: {result['emotion']}")
print(f"信心度: {result['confidence']}")

# 進階情緒分析
response = requests.post(
    'http://localhost:5000/api/emotion/analyze/audio_id_123',
    json={'method': 'advanced'}
)
result = response.json()
print(f"情緒: {result['emotion']}")
print(f"所有情緒分數: {result['scores']}")
```

#### 批次分析示例

```python
import requests

response = requests.post(
    'http://localhost:5000/api/emotion/batch-analyze',
    json={
        'audio_ids': ['id1', 'id2', 'id3'],
        'method': 'basic'
    }
)
results = response.json()
for result in results['results']:
    print(f"{result['audio_name']}: {result['emotion']}")
```

#### TTS 生成示例

```python
import requests

response = requests.post(
    'http://localhost:5000/simple_tts/generate',
    json={
        'text': '這是一段測試語音',
        'ref_audio_path': './mockvoice/sample.wav',
        'ref_text': '參考文字',
        'speed': 1.0
    }
)
result = response.json()
print(f"音頻 URL: {result['audio_url']}")
```

---

## 🔧 配置說明

### 環境變數

```bash
# GPT-SoVITS 服務地址（如果使用外部服務）
GPT_SOVITS_URL=http://localhost:9880

# 音頻文件存儲路徑
AUDIO_UPLOAD_DIR=./audio_uploads
MOCKVOICE_DIR=./mockvoice
OUTPUT_DIR=./genvoice
```

### 模型配置

```python
# 情緒識別模型配置
EMOTION_MODEL_BASIC = "librosa"
EMOTION_MODEL_ADVANCED = "wav2vec2"

# TTS 模型配置
TTS_MODEL = "gpt-sovits-v4"
TTS_SAMPLE_RATE = 32000
TTS_MAX_TEXT_LENGTH = 500
```

---

## 📈 性能指標

### 語音分析性能

| 指標         | 基礎版 | 進階版 |
| ------------ | ------ | ------ |
| 平均處理時間 | 0.8 秒 | 3.5 秒 |
| 準確度       | 72%    | 87%    |
| CPU 使用率   | 低     | 中-高  |
| 記憶體使用   | 100 MB | 500 MB |
| 並發能力     | 10+    | 5+     |

### 聲音模擬性能

| 指標         | 數值           |
| ------------ | -------------- |
| 平均處理時間 | 5 秒（100 字） |
| 音頻品質     | 高（32kHz）    |
| CPU 使用率   | 中-高          |
| 記憶體使用   | 800 MB         |
| 並發能力     | 3-5            |

---

## 🔐 安全性

### 文件安全

- ✅ 文件類型驗證
- ✅ 文件大小限制（50 MB）
- ✅ 安全的文件名處理
- ✅ 臨時文件自動清理

### API 安全

- ⚠️ 建議添加認證機制（規劃中）
- ⚠️ 建議添加速率限制（規劃中）
- ✅ 輸入驗證
- ✅ 錯誤處理

---

## 🧪 測試指南

### 情緒識別測試

1. **準備測試音頻**

   - 不同情緒的音頻樣本
   - 不同長度的音頻（1-300 秒）
   - 不同格式的音頻

2. **測試基礎版**

   ```bash
   curl -X POST http://localhost:5000/api/emotion/analyze/test_id \
     -H "Content-Type: application/json" \
     -d '{"method": "basic"}'
   ```

3. **測試進階版**

   ```bash
   curl -X POST http://localhost:5000/api/emotion/analyze/test_id \
     -H "Content-Type: application/json" \
     -d '{"method": "advanced"}'
   ```

4. **比較結果**
   - 準確度對比
   - 處理時間對比
   - 信心度對比

### TTS 生成測試

1. **準備測試文字**

   - 短文字（< 50 字）
   - 中等文字（50-200 字）
   - 長文字（200-500 字）

2. **測試不同語速**

   ```python
   for speed in [0.5, 1.0, 1.5, 2.0]:
       response = requests.post(
           'http://localhost:5000/simple_tts/generate',
           json={'text': '測試文字', 'speed': speed}
       )
   ```

3. **測試不同參考音頻**
   - 男聲
   - 女聲
   - 不同音色

---

## 🐛 故障排除

### 問題 1：情緒識別失敗

**症狀**: API 返回錯誤  
**可能原因**:

- 音頻文件不存在
- 音頻格式不支援
- 音頻文件損壞

**解決方案**:

1. 檢查音頻文件是否存在
2. 確認音頻格式（WAV, MP3, OGG, FLAC, M4A）
3. 使用音頻播放器測試文件是否正常

### 問題 2：進階模型載入失敗

**症狀**: 進階情緒識別不可用  
**可能原因**:

- 模型文件缺失
- 記憶體不足
- 依賴套件未安裝

**解決方案**:

1. 檢查模型文件是否存在
2. 確認系統記憶體充足（建議 4GB+）
3. 安裝必要的依賴：`pip install transformers torch`

### 問題 3：TTS 生成失敗

**症狀**: 語音生成失敗  
**可能原因**:

- GPT-SoVITS 服務未啟動
- 參考音頻不存在
- 文字長度超過限制

**解決方案**:

1. 確認 GPT-SoVITS 服務運行中
2. 檢查參考音頻文件路徑
3. 確認文字長度 < 500 字符

---

## 📚 相關文檔

### 技術文檔

- [情緒識別技術文檔](docs/technical/emotion_recognition.md)
- [TTS 技術文檔](docs/technical/tts.md)
- [GPT-SoVITS 整合指南](docs/technical/gpt_sovits.md)

### API 文檔

- [情緒識別 API](docs/api/emotion_api.md)
- [TTS API](docs/api/tts_api.md)

### 優化方案

- [架構優化方案](docs/最終優化/AI語音互動平台_架構優化方案.md)

---

## 🎯 未來規劃

### 短期目標（1-3 個月）

- [ ] 添加更多情緒類型支援
- [ ] 優化模型載入速度
- [ ] 添加批次 TTS 生成
- [ ] 改善 API 文檔

### 中期目標（3-6 個月）

- [ ] 支援即時語音分析
- [ ] 添加語音品質評估
- [ ] 支援更多語言
- [ ] 添加 Web UI 界面

### 長期目標（6-12 個月）

- [ ] 自定義情緒模型訓練
- [ ] 語音特徵可視化
- [ ] 模型性能優化
- [ ] 分散式處理支援

---

## 📞 技術支援

**開發團隊**: AI 開發團隊  
**維護負責人**: 系統優化小組  
**問題回報**: 專案 Issue 系統

---

## 📝 版本歷史

| 版本 | 日期       | 說明                     |
| ---- | ---------- | ------------------------ |
| 1.0  | 2025-11-21 | 初始文檔化，模組重新定位 |
| 0.9  | 2025-11-01 | 功能整合和優化           |
| 0.5  | 2025-10-01 | 基礎功能實現             |

---

**最後更新**: 2025-11-21  
**文檔狀態**: ✅ 已完成  
**模組狀態**: ✅ 生產環境運行中
