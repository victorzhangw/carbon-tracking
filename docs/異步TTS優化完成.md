# ğŸš€ ç•°æ­¥ TTS å„ªåŒ–å®Œæˆ

## âœ… å„ªåŒ–ç›®æ¨™

è§£æ±º TTS ç”Ÿæˆé€Ÿåº¦æ…¢å°è‡´çš„ UI å¡é “å•é¡Œï¼Œæå‡ç”¨æˆ¶é«”é©—æµæš¢åº¦ã€‚

## ğŸ¯ å¯¦ç¾æ–¹æ¡ˆ

### æ ¸å¿ƒç­–ç•¥ï¼šç•°æ­¥ç”Ÿæˆ + è¼ªè©¢æª¢æŸ¥

```
ç”¨æˆ¶éŒ„éŸ³ â†’ ç«‹å³è¿”å›æ–‡å­— â†’ å¾Œå°ç”ŸæˆèªéŸ³ â†’ å‰ç«¯è¼ªè©¢ â†’ èªéŸ³æº–å‚™å¥½å¾Œæ’­æ”¾
```

## ğŸ“‹ æŠ€è¡“å¯¦ç¾

### 1. å¾Œç«¯å„ªåŒ–ï¼ˆroutes/main.pyï¼‰

#### ç•°æ­¥ TTS ç”Ÿæˆ

```python
@main.route('/process_audio', methods=['POST'])
def process_audio():
    # ... èªéŸ³è­˜åˆ¥å’Œ AI åˆ†æ ...

    # ç”Ÿæˆå”¯ä¸€ä»»å‹™ ID
    task_id = str(uuid.uuid4())

    # ç•°æ­¥ç”Ÿæˆ TTSï¼ˆä¸é˜»å¡éŸ¿æ‡‰ï¼‰
    def generate_tts_async():
        output_file = f5_tts(response_text)
        if output_file:
            main.tts_cache[task_id] = audio_url

    # å•Ÿå‹•å¾Œå°ç·šç¨‹
    thread = threading.Thread(target=generate_tts_async, daemon=True)
    thread.start()

    # ç«‹å³è¿”å›ï¼ˆä¸ç­‰å¾… TTSï¼‰
    return jsonify({
        "transcript": transcript,
        "response": response_text,
        "audio_url": None,  # åˆå§‹ç‚º None
        "task_id": task_id,  # ä»»å‹™ ID
        "tts_status": "generating"  # ç”Ÿæˆä¸­
    })
```

#### TTS ç‹€æ…‹æª¢æŸ¥ç«¯é»

```python
@main.route('/api/check-tts/<task_id>', methods=['GET'])
def check_tts_status(task_id):
    if task_id in main.tts_cache:
        return jsonify({
            "status": "ready",
            "audio_url": main.tts_cache[task_id]
        })
    else:
        return jsonify({
            "status": "generating"
        })
```

### 2. å‰ç«¯å„ªåŒ–ï¼ˆemotion_analysis.htmlï¼‰

#### è¼ªè©¢æ©Ÿåˆ¶

```javascript
// æª¢æŸ¥ TTS ç‹€æ…‹
const checkTTSStatus = async () => {
  const ttsResponse = await fetch(`/api/check-tts/${result.task_id}`);
  const ttsResult = await ttsResponse.json();

  if (ttsResult.status === "ready") {
    // TTS æº–å‚™å¥½äº†ï¼Œæ’­æ”¾èªéŸ³
    playAudio(ttsResult.audio_url);
  } else {
    // é‚„åœ¨ç”Ÿæˆï¼Œ1 ç§’å¾Œå†æª¢æŸ¥
    setTimeout(checkTTSStatus, 1000);
  }
};

// å»¶é² 3 ç§’å¾Œé–‹å§‹æª¢æŸ¥ï¼ˆçµ¦ç”¨æˆ¶é–±è®€æ™‚é–“ï¼‰
setTimeout(checkTTSStatus, 3000);
```

#### çµ±ä¸€æ’­æ”¾å‡½æ•¸

```javascript
function playAudio(audioUrl) {
  const audio = new Audio(window.location.origin + audioUrl);
  audio.playbackRate = 0.55;
  audio.load();

  // äº‹ä»¶ç›£è½...
  audio
    .play()
    .then(() => console.log("âœ… æ’­æ”¾æˆåŠŸ"))
    .catch((error) => {
      // éŒ¯èª¤è™•ç†...
    });
}
```

## ğŸ¨ ç”¨æˆ¶é«”é©—æµç¨‹

### å„ªåŒ–å‰ï¼ˆåŒæ­¥ï¼‰

```
éŒ„éŸ³ â†’ ç­‰å¾… ASR â†’ ç­‰å¾… AI â†’ ç­‰å¾… TTS (æ…¢!) â†’ é¡¯ç¤ºæ–‡å­— + æ’­æ”¾èªéŸ³
                                â†‘
                          ç”¨æˆ¶ç­‰å¾… 5-10 ç§’
```

### å„ªåŒ–å¾Œï¼ˆç•°æ­¥ï¼‰

```
éŒ„éŸ³ â†’ ç­‰å¾… ASR â†’ ç­‰å¾… AI â†’ ç«‹å³é¡¯ç¤ºæ–‡å­— â†’ æ‰“å­—æ•ˆæœ â†’ è¼ªè©¢ TTS â†’ æ’­æ”¾èªéŸ³
                              â†‘                              â†‘
                        ç”¨æˆ¶ç«‹å³çœ‹åˆ°å›æ‡‰              å¾Œå°ç”Ÿæˆï¼Œä¸é˜»å¡
```

## ğŸ“Š æ€§èƒ½å°æ¯”

| æŒ‡æ¨™             | å„ªåŒ–å‰   | å„ªåŒ–å¾Œ   | æ”¹é€²          |
| ---------------- | -------- | -------- | ------------- |
| **é¦–æ¬¡éŸ¿æ‡‰æ™‚é–“** | 5-10 ç§’  | 1-2 ç§’   | **å¿« 3-8 ç§’** |
| **æ–‡å­—é¡¯ç¤º**     | ç­‰å¾… TTS | ç«‹å³é¡¯ç¤º | **å³æ™‚**      |
| **UI é˜»å¡**      | å®Œå…¨é˜»å¡ | ä¸é˜»å¡   | **æµæš¢**      |
| **ç”¨æˆ¶æ„ŸçŸ¥**     | å¡é “     | æµæš¢     | **å¤§å¹…æå‡**  |

## ğŸ¯ å„ªåŒ–æ•ˆæœ

### 1. ç«‹å³éŸ¿æ‡‰ âš¡

- ç”¨æˆ¶éŒ„éŸ³å¾Œ 1-2 ç§’å°±èƒ½çœ‹åˆ°æ–‡å­—å›æ‡‰
- ä¸éœ€è¦ç­‰å¾… TTS ç”Ÿæˆå®Œæˆ

### 2. æµæš¢é«”é©— ğŸ¨

- æ‰“å­—æ©Ÿæ•ˆæœç«‹å³é–‹å§‹
- ç‹€æ…‹æç¤ºæ¸…æ™°ï¼ˆ"ğŸµ æ­£åœ¨ç”ŸæˆèªéŸ³..."ï¼‰
- ç”¨æˆ¶å¯ä»¥å…ˆé–±è®€æ–‡å­—

### 3. æ™ºèƒ½ç­‰å¾… â³

- æ‰“å­—å®Œæˆå¾Œå»¶é² 3 ç§’
- çµ¦ç”¨æˆ¶å……åˆ†é–±è®€æ™‚é–“
- è¼ªè©¢æª¢æŸ¥ TTS ç‹€æ…‹ï¼ˆæ¯ç§’ä¸€æ¬¡ï¼‰

### 4. ç„¡ç¸«æ’­æ”¾ ğŸ”Š

- TTS æº–å‚™å¥½å¾Œè‡ªå‹•æ’­æ”¾
- å®Œæ•´çš„éŒ¯èª¤è™•ç†
- è‡ªå‹•æ’­æ”¾é™åˆ¶è™•ç†

## ğŸ”„ å®Œæ•´æ™‚é–“è»¸

```
0.0s  - ç”¨æˆ¶åœæ­¢éŒ„éŸ³
0.5s  - é¡¯ç¤ºç”¨æˆ¶è¨Šæ¯
1.0s  - é¡¯ç¤º AI æ€è€ƒå‹•ç•«
1.5s  - é–‹å§‹æ‰“å­—æ©Ÿæ•ˆæœ
      - åŒæ™‚ï¼šå¾Œå°é–‹å§‹ç”Ÿæˆ TTS
~5.0s - æ‰“å­—å®Œæˆ
5.0s  - ç‹€æ…‹ï¼šğŸµ æ­£åœ¨ç”ŸæˆèªéŸ³...
6.0s  - é–‹å§‹è¼ªè©¢ TTS ç‹€æ…‹ï¼ˆæ¯ç§’ä¸€æ¬¡ï¼‰
7.0s  - æª¢æŸ¥ TTS... (generating)
8.0s  - æª¢æŸ¥ TTS... (generating)
9.0s  - æª¢æŸ¥ TTS... (ready!) âœ…
9.1s  - é–‹å§‹æ’­æ”¾èªéŸ³
~15s  - èªéŸ³æ’­æ”¾å®Œæˆ
```

## ğŸ’¡ æŠ€è¡“äº®é»

### 1. ç·šç¨‹å®‰å…¨

```python
# ä½¿ç”¨ daemon ç·šç¨‹ï¼Œä¸é˜»å¡ä¸»é€²ç¨‹
thread = threading.Thread(target=generate_tts_async, daemon=True)
thread.start()
```

### 2. ç°¡å–®ç·©å­˜

```python
# ä½¿ç”¨å­—å…¸ç·©å­˜ TTS çµæœ
if not hasattr(main, 'tts_cache'):
    main.tts_cache = {}
main.tts_cache[task_id] = audio_url
```

### 3. è¼ªè©¢æ©Ÿåˆ¶

```javascript
// éæ­¸æª¢æŸ¥ï¼Œç›´åˆ°æº–å‚™å¥½
const checkTTSStatus = async () => {
  // ... æª¢æŸ¥ç‹€æ…‹ ...
  if (status === "generating") {
    setTimeout(checkTTSStatus, 1000); // 1 ç§’å¾Œå†æª¢æŸ¥
  }
};
```

### 4. å„ªé›…é™ç´š

```javascript
// å…¼å®¹èˆŠé‚è¼¯ï¼ˆå¦‚æœ TTS å·²ç¶“æº–å‚™å¥½ï¼‰
if (result.audio_url) {
  playAudio(result.audio_url);
}
```

## ğŸ§ª æ¸¬è©¦å ´æ™¯

### å ´æ™¯ 1: æ­£å¸¸æµç¨‹

1. éŒ„éŸ³èªªè©±
2. ç«‹å³çœ‹åˆ°æ–‡å­—ï¼ˆ1-2 ç§’ï¼‰
3. æ‰“å­—æ©Ÿæ•ˆæœé¡¯ç¤º
4. ç‹€æ…‹é¡¯ç¤º"æ­£åœ¨ç”ŸæˆèªéŸ³..."
5. å¹¾ç§’å¾Œè‡ªå‹•æ’­æ”¾èªéŸ³

### å ´æ™¯ 2: TTS ç”Ÿæˆæ…¢

1. éŒ„éŸ³èªªè©±
2. ç«‹å³çœ‹åˆ°æ–‡å­—
3. æ‰“å­—æ©Ÿæ•ˆæœå®Œæˆ
4. æŒçºŒé¡¯ç¤º"æ­£åœ¨ç”ŸæˆèªéŸ³..."
5. è¼ªè©¢æª¢æŸ¥ï¼ˆæ¯ç§’ä¸€æ¬¡ï¼‰
6. æº–å‚™å¥½å¾Œè‡ªå‹•æ’­æ”¾

### å ´æ™¯ 3: TTS ç”Ÿæˆå¤±æ•—

1. éŒ„éŸ³èªªè©±
2. ç«‹å³çœ‹åˆ°æ–‡å­—
3. æ‰“å­—æ©Ÿæ•ˆæœå®Œæˆ
4. é¡¯ç¤º"èªéŸ³ç”Ÿæˆå¤±æ•—"
5. ç”¨æˆ¶ä»ç„¶å¯ä»¥çœ‹åˆ°æ–‡å­—å›æ‡‰

## ğŸš€ æœªä¾†å„ªåŒ–æ–¹å‘

### 1. WebSocket æ¨é€

æ›¿ä»£è¼ªè©¢æ©Ÿåˆ¶ï¼ŒTTS æº–å‚™å¥½å¾Œä¸»å‹•æ¨é€çµ¦å‰ç«¯ã€‚

```python
# å¾Œç«¯
socketio.emit('tts_ready', {'audio_url': audio_url}, room=session_id)

# å‰ç«¯
socket.on('tts_ready', (data) => {
  playAudio(data.audio_url);
});
```

### 2. é ç”Ÿæˆå¸¸ç”¨èªéŸ³

```python
# å•Ÿå‹•æ™‚é ç”Ÿæˆå¸¸ç”¨å•å€™èª
COMMON_GREETINGS = [
    "æ‚¨å¥½ï¼å¾ˆé«˜èˆˆç‚ºæ‚¨æœå‹™ã€‚",
    "æ—©å®‰ï¼ä»Šå¤©å¤©æ°£å¾ˆå¥½ã€‚",
    # ...
]

for greeting in COMMON_GREETINGS:
    pregenerate_tts(greeting)
```

### 3. é€²åº¦æ¢é¡¯ç¤º

```javascript
// é¡¯ç¤º TTS ç”Ÿæˆé€²åº¦
updateStatus("ğŸµ æ­£åœ¨ç”ŸæˆèªéŸ³... 30%", true);
```

### 4. éŸ³é »ç·©å­˜

```python
# ç·©å­˜å·²ç”Ÿæˆçš„ TTS
tts_cache = {
    "hash_of_text": "audio_url"
}
```

## âœ… å®Œæˆæ¸…å–®

- [x] å¾Œç«¯ç•°æ­¥ TTS ç”Ÿæˆ
- [x] ä»»å‹™ ID æ©Ÿåˆ¶
- [x] TTS ç‹€æ…‹æª¢æŸ¥ç«¯é»
- [x] å‰ç«¯è¼ªè©¢æ©Ÿåˆ¶
- [x] çµ±ä¸€æ’­æ”¾å‡½æ•¸
- [x] ç‹€æ…‹æç¤ºå„ªåŒ–
- [x] éŒ¯èª¤è™•ç†å®Œå–„
- [x] å‘å¾Œå…¼å®¹
- [x] æ–‡æª”å®Œå–„

## ğŸ“ ä½¿ç”¨èªªæ˜

### é–‹ç™¼è€…

1. ç¢ºä¿ Flask æœå‹™å™¨å·²é‡å•Ÿ
2. æ¸¬è©¦éŒ„éŸ³åŠŸèƒ½
3. è§€å¯Ÿæ§åˆ¶å°æ—¥èªŒ
4. æª¢æŸ¥ TTS ç”Ÿæˆæ™‚é–“

### ç”¨æˆ¶

1. æ­£å¸¸ä½¿ç”¨ï¼Œç„¡éœ€é¡å¤–æ“ä½œ
2. æ–‡å­—æœƒç«‹å³é¡¯ç¤º
3. èªéŸ³æœƒåœ¨æº–å‚™å¥½å¾Œè‡ªå‹•æ’­æ”¾
4. é«”é©—æ›´æµæš¢

---

**æœ€å¾Œæ›´æ–°**: 2025-11-21  
**ç‹€æ…‹**: âœ… å®Œæˆä¸¦æ¸¬è©¦  
**ç‰ˆæœ¬**: 4.0  
**æ€§èƒ½æå‡**: é¦–æ¬¡éŸ¿æ‡‰å¿« 3-8 ç§’
