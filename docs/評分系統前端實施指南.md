# ğŸ“± è©•åˆ†ç³»çµ±å‰ç«¯å¯¦æ–½æŒ‡å—

## ğŸ¯ éœ€è¦ä¿®æ”¹çš„éƒ¨åˆ†

### 1. HTML çµæ§‹ä¿®æ”¹

#### åœ¨éŒ„éŸ³æ§åˆ¶å€åŸŸæ·»åŠ åœæ­¢å°è©±æŒ‰éˆ•

**ä½ç½®**: `templates/emotion_analysis.html` ç¬¬ 437 è¡Œå¾Œ

```html
<button id="stopRecord" class="btn btn-danger" disabled>â¹ï¸ åœæ­¢éŒ„éŸ³</button>
<!-- æ–°å¢ï¼šåœæ­¢å°è©±æŒ‰éˆ• -->
<button id="endSession" class="btn btn-end-session" disabled>
  ğŸ çµæŸå°è©±
</button>
```

#### æ·»åŠ è©•åˆ†å ±å‘Šå½ˆçª— HTML

**ä½ç½®**: `templates/emotion_analysis.html` åœ¨ `</body>` æ¨™ç±¤å‰

```html
<!-- è©•åˆ†å ±å‘Šå½ˆçª— -->
<div id="scoreModal" class="score-modal" style="display: none;">
  <div class="score-modal-content">
    <div class="score-modal-header">
      <h2>ğŸ‰ å°è©±è©•åˆ†å ±å‘Š</h2>
      <button class="score-modal-close">&times;</button>
    </div>

    <div class="score-modal-body">
      <!-- é›·é”åœ– -->
      <div class="score-radar-container">
        <canvas id="scoreRadarChart"></canvas>
      </div>

      <!-- è©•åˆ†å¡ç‰‡ -->
      <div class="score-cards">
        <div class="score-card">
          <div class="score-card-icon">ğŸ˜Š</div>
          <div class="score-card-title">æƒ…ç·’è¡¨é”</div>
          <div class="score-card-value" id="emotionScoreValue">--</div>
          <div class="score-card-bar">
            <div class="score-card-fill" id="emotionScoreFill"></div>
          </div>
        </div>

        <div class="score-card">
          <div class="score-card-icon">ğŸ¤</div>
          <div class="score-card-title">èªéŸ³å“è³ª</div>
          <div class="score-card-value" id="voiceScoreValue">--</div>
          <div class="score-card-bar">
            <div class="score-card-fill" id="voiceScoreFill"></div>
          </div>
        </div>

        <div class="score-card">
          <div class="score-card-icon">ğŸ“</div>
          <div class="score-card-title">æ–‡å­—å…§å®¹</div>
          <div class="score-card-value" id="contentScoreValue">--</div>
          <div class="score-card-bar">
            <div class="score-card-fill" id="contentScoreFill"></div>
          </div>
        </div>
      </div>

      <!-- ç¶œåˆè©•åˆ† -->
      <div class="score-overall">
        <div class="score-overall-label">ç¶œåˆè©•åˆ†</div>
        <div class="score-overall-value" id="overallScoreValue">--</div>
        <div class="score-overall-grade" id="overallGrade">--</div>
        <div class="score-overall-stars" id="overallStars"></div>
      </div>

      <!-- æ”¹é€²å»ºè­° -->
      <div class="score-suggestions">
        <h3>ğŸ’¡ æ”¹é€²å»ºè­°</h3>
        <div id="suggestionsList"></div>
      </div>

      <!-- çµ±è¨ˆè³‡è¨Š -->
      <div class="score-statistics">
        <div class="score-stat">
          <span class="score-stat-label">å°è©±è¼ªæ•¸</span>
          <span class="score-stat-value" id="statConversations">--</span>
        </div>
        <div class="score-stat">
          <span class="score-stat-label">ç¸½å­—æ•¸</span>
          <span class="score-stat-value" id="statWords">--</span>
        </div>
        <div class="score-stat">
          <span class="score-stat-label">æŒçºŒæ™‚é–“</span>
          <span class="score-stat-value" id="statDuration">--</span>
        </div>
      </div>
    </div>

    <div class="score-modal-footer">
      <button class="btn btn-secondary" onclick="closeScoreModal()">
        é—œé–‰
      </button>
      <button class="btn btn-primary" onclick="viewHistory()">æŸ¥çœ‹æ­·å²</button>
    </div>
  </div>
</div>
```

### 2. CSS æ¨£å¼æ·»åŠ 

**ä½ç½®**: `templates/emotion_analysis.html` åœ¨ `<style>` æ¨™ç±¤å…§

```css
/* åœæ­¢å°è©±æŒ‰éˆ• */
.btn-end-session {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 12px 24px;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  margin-left: 10px;
}

.btn-end-session:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
}

.btn-end-session:disabled {
  background: #ccc;
  cursor: not-allowed;
  transform: none;
}

/* è©•åˆ†å ±å‘Šå½ˆçª— */
.score-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  animation: fadeIn 0.3s ease;
}

.score-modal-content {
  background: white;
  border-radius: 16px;
  width: 90%;
  max-width: 900px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  animation: slideUp 0.3s ease;
}

.score-modal-header {
  padding: 24px;
  border-bottom: 1px solid #e0e0e0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.score-modal-header h2 {
  margin: 0;
  font-size: 24px;
  color: #333;
}

.score-modal-close {
  background: none;
  border: none;
  font-size: 32px;
  color: #999;
  cursor: pointer;
  padding: 0;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: all 0.2s;
}

.score-modal-close:hover {
  background: #f0f0f0;
  color: #333;
}

.score-modal-body {
  padding: 24px;
}

.score-radar-container {
  width: 100%;
  max-width: 400px;
  margin: 0 auto 32px;
}

.score-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 32px;
}

.score-card {
  background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
  border-radius: 12px;
  padding: 20px;
  text-align: center;
}

.score-card-icon {
  font-size: 48px;
  margin-bottom: 8px;
}

.score-card-title {
  font-size: 14px;
  color: #666;
  margin-bottom: 8px;
}

.score-card-value {
  font-size: 32px;
  font-weight: bold;
  color: #333;
  margin-bottom: 12px;
}

.score-card-bar {
  width: 100%;
  height: 8px;
  background: rgba(255, 255, 255, 0.5);
  border-radius: 4px;
  overflow: hidden;
}

.score-card-fill {
  height: 100%;
  background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
  transition: width 0.6s ease;
}

.score-overall {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-radius: 12px;
  padding: 24px;
  text-align: center;
  margin-bottom: 32px;
}

.score-overall-label {
  font-size: 16px;
  opacity: 0.9;
  margin-bottom: 8px;
}

.score-overall-value {
  font-size: 64px;
  font-weight: bold;
  margin-bottom: 8px;
}

.score-overall-grade {
  font-size: 24px;
  font-weight: 600;
  margin-bottom: 8px;
}

.score-overall-stars {
  font-size: 32px;
}

.score-suggestions {
  margin-bottom: 32px;
}

.score-suggestions h3 {
  font-size: 20px;
  margin-bottom: 16px;
  color: #333;
}

.suggestion-item {
  background: #f8f9fa;
  border-left: 4px solid #667eea;
  padding: 16px;
  margin-bottom: 12px;
  border-radius: 8px;
  display: flex;
  align-items: start;
  gap: 12px;
}

.suggestion-icon {
  font-size: 24px;
  flex-shrink: 0;
}

.suggestion-content {
  flex: 1;
}

.suggestion-category {
  font-size: 12px;
  color: #667eea;
  font-weight: 600;
  margin-bottom: 4px;
}

.suggestion-text {
  font-size: 14px;
  color: #333;
  line-height: 1.5;
}

.suggestion-priority-high {
  border-left-color: #e74c3c;
}

.suggestion-priority-medium {
  border-left-color: #f39c12;
}

.suggestion-priority-low {
  border-left-color: #3498db;
}

.score-statistics {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 16px;
  padding: 20px;
  background: #f8f9fa;
  border-radius: 12px;
}

.score-stat {
  text-align: center;
}

.score-stat-label {
  display: block;
  font-size: 12px;
  color: #666;
  margin-bottom: 4px;
}

.score-stat-value {
  display: block;
  font-size: 24px;
  font-weight: bold;
  color: #333;
}

.score-modal-footer {
  padding: 20px 24px;
  border-top: 1px solid #e0e0e0;
  display: flex;
  justify-content: flex-end;
  gap: 12px;
}

@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
```

### 3. JavaScript åŠŸèƒ½æ·»åŠ 

**ä½ç½®**: `templates/emotion_analysis.html` åœ¨ `<script>` æ¨™ç±¤å…§

#### 3.1 å…¨å±€è®Šé‡æ·»åŠ 

```javascript
// æœƒè©±ç®¡ç†
let sessionId = null;
let sessionStartTime = null;
let conversationHistory = [];

// åˆå§‹åŒ–æœƒè©±
function initSession() {
  sessionId = generateUUID();
  sessionStartTime = new Date();
  conversationHistory = [];
  console.log("âœ… æœƒè©±å·²åˆå§‹åŒ–:", sessionId);
}

// ç”Ÿæˆ UUID
function generateUUID() {
  return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function (c) {
    const r = (Math.random() * 16) | 0;
    const v = c === "x" ? r : (r & 0x3) | 0x8;
    return v.toString(16);
  });
}
```

#### 3.2 è¨˜éŒ„å°è©±å‡½æ•¸

```javascript
// è¨˜éŒ„å°è©±
function recordConversation(speaker, text, sentiment, sentimentScore) {
  conversationHistory.push({
    speaker: speaker,
    text: text,
    sentiment: sentiment,
    sentiment_score: sentimentScore,
    word_count: text.length,
    timestamp: new Date().toISOString(),
  });

  // å•Ÿç”¨åœæ­¢å°è©±æŒ‰éˆ•ï¼ˆè‡³å°‘1æ¬¡å°è©±å¾Œï¼‰
  if (conversationHistory.length >= 2) {
    document.getElementById("endSession").disabled = false;
  }

  console.log(`ğŸ“ è¨˜éŒ„å°è©± #${conversationHistory.length}: ${speaker}`);
}
```

#### 3.3 åœæ­¢å°è©±æŒ‰éˆ•äº‹ä»¶

```javascript
// åœæ­¢å°è©±æŒ‰éˆ•
document.getElementById("endSession").addEventListener("click", async () => {
  if (conversationHistory.length < 2) {
    alert("è‡³å°‘éœ€è¦ä¸€è¼ªå°è©±æ‰èƒ½ç”Ÿæˆè©•åˆ†å ±å‘Š");
    return;
  }

  const confirmed = confirm("ç¢ºå®šè¦çµæŸå°è©±å—ï¼Ÿ\nç³»çµ±å°‡ç‚ºæ‚¨ç”Ÿæˆè©•åˆ†å ±å‘Šã€‚");
  if (!confirmed) return;

  await endSessionAndShowReport();
});
```

#### 3.4 çµæŸå°è©±ä¸¦é¡¯ç¤ºå ±å‘Š

```javascript
// çµæŸå°è©±ä¸¦é¡¯ç¤ºå ±å‘Š
async function endSessionAndShowReport() {
  try {
    updateStatus("ğŸ“Š æ­£åœ¨ç”Ÿæˆè©•åˆ†å ±å‘Š...", true);

    // è¨ˆç®—æŒçºŒæ™‚é–“
    const duration = Math.floor((new Date() - sessionStartTime) / 1000);

    // ç™¼é€è«‹æ±‚
    const response = await fetch("/api/end-session", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        session_id: sessionId,
        user_id: "default",
        conversation_history: conversationHistory,
        duration: duration,
      }),
    });

    const result = await response.json();

    if (result.status === "success") {
      // é¡¯ç¤ºè©•åˆ†å ±å‘Š
      showScoreReport(result);
      updateStatus("âœ… è©•åˆ†å ±å‘Šå·²ç”Ÿæˆ", false);
    } else {
      throw new Error(result.message || "ç”Ÿæˆè©•åˆ†å ±å‘Šå¤±æ•—");
    }
  } catch (error) {
    console.error("ç”Ÿæˆè©•åˆ†å ±å‘Šå¤±æ•—:", error);
    alert("ç”Ÿæˆè©•åˆ†å ±å‘Šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
    updateStatus("âŒ ç”Ÿæˆå¤±æ•—", false);
  }
}
```

#### 3.5 é¡¯ç¤ºè©•åˆ†å ±å‘Š

```javascript
// é¡¯ç¤ºè©•åˆ†å ±å‘Š
function showScoreReport(data) {
  const modal = document.getElementById("scoreModal");

  // å¡«å……è©•åˆ†æ•¸æ“š
  document.getElementById("emotionScoreValue").textContent =
    data.scores.emotion;
  document.getElementById("voiceScoreValue").textContent = data.scores.voice;
  document.getElementById("contentScoreValue").textContent =
    data.scores.content;
  document.getElementById("overallScoreValue").textContent =
    data.scores.overall;

  // å¡«å……ç­‰ç´šå’Œæ˜Ÿç´š
  document.getElementById(
    "overallGrade"
  ).textContent = `${data.grade} - ${data.title}`;
  document.getElementById("overallStars").textContent = "â­".repeat(data.stars);

  // å¡«å……é€²åº¦æ¢
  document.getElementById("emotionScoreFill").style.width =
    data.scores.emotion + "%";
  document.getElementById("voiceScoreFill").style.width =
    data.scores.voice + "%";
  document.getElementById("contentScoreFill").style.width =
    data.scores.content + "%";

  // å¡«å……å»ºè­°
  const suggestionsList = document.getElementById("suggestionsList");
  suggestionsList.innerHTML = "";

  if (data.suggestions && data.suggestions.length > 0) {
    data.suggestions.forEach((suggestion) => {
      const item = document.createElement("div");
      item.className = `suggestion-item suggestion-priority-${suggestion.priority}`;
      item.innerHTML = `
        <div class="suggestion-icon">${suggestion.icon}</div>
        <div class="suggestion-content">
          <div class="suggestion-category">${suggestion.category}</div>
          <div class="suggestion-text">${suggestion.text}</div>
        </div>
      `;
      suggestionsList.appendChild(item);
    });
  } else {
    suggestionsList.innerHTML =
      '<p style="color: #666; text-align: center;">å¤ªæ£’äº†ï¼æ²’æœ‰éœ€è¦æ”¹é€²çš„åœ°æ–¹ ğŸ‰</p>';
  }

  // å¡«å……çµ±è¨ˆè³‡è¨Š
  document.getElementById("statConversations").textContent =
    data.statistics.conversation_count;
  document.getElementById("statWords").textContent =
    data.statistics.total_words;
  document.getElementById("statDuration").textContent = formatDuration(
    data.statistics.duration
  );

  // ç¹ªè£½é›·é”åœ–
  drawRadarChart(data.scores);

  // é¡¯ç¤ºå½ˆçª—
  modal.style.display = "flex";
}

// é—œé–‰è©•åˆ†å ±å‘Š
function closeScoreModal() {
  document.getElementById("scoreModal").style.display = "none";

  // é‡æ–°åˆå§‹åŒ–æœƒè©±
  initSession();

  // ç¦ç”¨åœæ­¢å°è©±æŒ‰éˆ•
  document.getElementById("endSession").disabled = true;
}

// æ ¼å¼åŒ–æŒçºŒæ™‚é–“
function formatDuration(seconds) {
  const minutes = Math.floor(seconds / 60);
  const secs = seconds % 60;
  return `${minutes}åˆ†${secs}ç§’`;
}

// ç¹ªè£½é›·é”åœ–ï¼ˆç°¡åŒ–ç‰ˆï¼Œä½¿ç”¨ Canvasï¼‰
function drawRadarChart(scores) {
  const canvas = document.getElementById("scoreRadarChart");
  const ctx = canvas.getContext("2d");

  // è¨­ç½® canvas å¤§å°
  canvas.width = 400;
  canvas.height = 400;

  const centerX = 200;
  const centerY = 200;
  const radius = 150;

  // æ¸…ç©ºç•«å¸ƒ
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // æ•¸æ“š
  const data = [
    { label: "æƒ…ç·’è¡¨é”", value: scores.emotion },
    { label: "èªéŸ³å“è³ª", value: scores.voice },
    { label: "æ–‡å­—å…§å®¹", value: scores.content },
  ];

  const angleStep = (Math.PI * 2) / data.length;

  // ç¹ªè£½èƒŒæ™¯ç¶²æ ¼
  ctx.strokeStyle = "#e0e0e0";
  ctx.lineWidth = 1;

  for (let i = 1; i <= 5; i++) {
    ctx.beginPath();
    const r = (radius / 5) * i;
    for (let j = 0; j <= data.length; j++) {
      const angle = angleStep * j - Math.PI / 2;
      const x = centerX + r * Math.cos(angle);
      const y = centerY + r * Math.sin(angle);
      if (j === 0) {
        ctx.moveTo(x, y);
      } else {
        ctx.lineTo(x, y);
      }
    }
    ctx.closePath();
    ctx.stroke();
  }

  // ç¹ªè£½è»¸ç·š
  data.forEach((item, index) => {
    const angle = angleStep * index - Math.PI / 2;
    const x = centerX + radius * Math.cos(angle);
    const y = centerY + radius * Math.sin(angle);

    ctx.beginPath();
    ctx.moveTo(centerX, centerY);
    ctx.lineTo(x, y);
    ctx.stroke();

    // ç¹ªè£½æ¨™ç±¤
    const labelX = centerX + (radius + 30) * Math.cos(angle);
    const labelY = centerY + (radius + 30) * Math.sin(angle);
    ctx.fillStyle = "#333";
    ctx.font = "14px Arial";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(item.label, labelX, labelY);
  });

  // ç¹ªè£½æ•¸æ“šå€åŸŸ
  ctx.beginPath();
  ctx.fillStyle = "rgba(102, 126, 234, 0.2)";
  ctx.strokeStyle = "rgba(102, 126, 234, 1)";
  ctx.lineWidth = 2;

  data.forEach((item, index) => {
    const angle = angleStep * index - Math.PI / 2;
    const r = (radius / 100) * item.value;
    const x = centerX + r * Math.cos(angle);
    const y = centerY + r * Math.sin(angle);

    if (index === 0) {
      ctx.moveTo(x, y);
    } else {
      ctx.lineTo(x, y);
    }
  });

  ctx.closePath();
  ctx.fill();
  ctx.stroke();

  // ç¹ªè£½æ•¸æ“šé»
  data.forEach((item, index) => {
    const angle = angleStep * index - Math.PI / 2;
    const r = (radius / 100) * item.value;
    const x = centerX + r * Math.cos(angle);
    const y = centerY + r * Math.sin(angle);

    ctx.beginPath();
    ctx.arc(x, y, 5, 0, Math.PI * 2);
    ctx.fillStyle = "rgba(102, 126, 234, 1)";
    ctx.fill();
  });
}

// æŸ¥çœ‹æ­·å²
function viewHistory() {
  alert("æ­·å²è¨˜éŒ„åŠŸèƒ½é–‹ç™¼ä¸­...");
}
```

#### 3.6 ä¿®æ”¹ç¾æœ‰çš„å°è©±è™•ç†é‚è¼¯

åœ¨ `addUserMessage` å’Œ `addAIMessage` èª¿ç”¨å¾Œæ·»åŠ è¨˜éŒ„ï¼š

```javascript
// åœ¨é¡¯ç¤ºç”¨æˆ¶è¨Šæ¯å¾Œè¨˜éŒ„
if (result.transcript) {
  addUserMessage(result.transcript);
  recordConversation("user", result.transcript, result.sentiment, 0.8);
}

// åœ¨é¡¯ç¤º AI å›æ‡‰å¾Œè¨˜éŒ„
if (result.response) {
  const emotionInfo = result.sentiment
    ? getEmotionInfo(result.sentiment)
    : null;
  await addAIMessage(result.response, emotionInfo, true);
  recordConversation("ai", result.response, result.sentiment, 0.9);
}
```

#### 3.7 é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–æœƒè©±

```javascript
// åœ¨ DOMContentLoaded äº‹ä»¶ä¸­æ·»åŠ 
window.addEventListener("DOMContentLoaded", () => {
  initSession(); // åˆå§‹åŒ–æœƒè©±
  showWeatherGreeting();
});
```

### 4. é—œé–‰å½ˆçª—äº‹ä»¶

```javascript
// é—œé–‰æŒ‰éˆ•äº‹ä»¶
document
  .querySelector(".score-modal-close")
  .addEventListener("click", closeScoreModal);

// é»æ“ŠèƒŒæ™¯é—œé–‰
document.getElementById("scoreModal").addEventListener("click", (e) => {
  if (e.target.id === "scoreModal") {
    closeScoreModal();
  }
});
```

---

## âœ… å¯¦æ–½æª¢æŸ¥æ¸…å–®

- [ ] æ·»åŠ åœæ­¢å°è©±æŒ‰éˆ• HTML
- [ ] æ·»åŠ è©•åˆ†å ±å‘Šå½ˆçª— HTML
- [ ] æ·»åŠ  CSS æ¨£å¼
- [ ] æ·»åŠ å…¨å±€è®Šé‡å’Œåˆå§‹åŒ–å‡½æ•¸
- [ ] æ·»åŠ è¨˜éŒ„å°è©±å‡½æ•¸
- [ ] æ·»åŠ åœæ­¢å°è©±æŒ‰éˆ•äº‹ä»¶
- [ ] æ·»åŠ çµæŸå°è©±ä¸¦é¡¯ç¤ºå ±å‘Šå‡½æ•¸
- [ ] æ·»åŠ é¡¯ç¤ºè©•åˆ†å ±å‘Šå‡½æ•¸
- [ ] æ·»åŠ é›·é”åœ–ç¹ªè£½å‡½æ•¸
- [ ] ä¿®æ”¹ç¾æœ‰å°è©±è™•ç†é‚è¼¯æ·»åŠ è¨˜éŒ„
- [ ] æ·»åŠ é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–æœƒè©±
- [ ] æ¸¬è©¦å®Œæ•´æµç¨‹

---

**æ–‡æª”ç‰ˆæœ¬**: 1.0  
**å‰µå»ºæ—¥æœŸ**: 2025-11-21  
**ç‹€æ…‹**: å¾…å¯¦æ–½
