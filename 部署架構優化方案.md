# 🏗️ 系統部署架構優化方案

## 📊 現況分析

### 當前問題

- ✅ 系統包含：語音識別（ASR、情緒識別）+ 碳排放追蹤
- ❌ requirements.txt 太大（包含 torch、transformers 等重量級套件）
- ❌ Render Free 方案記憶體不足
- ❌ 部署失敗：metadata-generation-failed

### 套件大小分析

```
重量級套件（語音相關）：
- torch: ~800MB
- transformers: ~500MB
- librosa: ~200MB
- scikit-learn: ~100MB
總計：~1.6GB+

輕量級套件（碳排放）：
- Flask: ~5MB
- openpyxl: ~3MB
總計：~10MB
```

## 🎯 解決方案：微服務架構

### 方案 A：分離部署（推薦）

```
┌─────────────────────────────────────────┐
│         主系統 (Render Free)             │
│  - 碳排放追蹤                            │
│  - 後台管理                              │
│  - 輕量級功能                            │
│  URL: carbon-tracking.onrender.com      │
└─────────────────────────────────────────┘
              ↓ API 呼叫
┌─────────────────────────────────────────┐
│      語音服務 (本地或雲端 GPU)           │
│  - ASR 語音識別                          │
│  - 情緒識別                              │
│  - 需要 GPU 加速                         │
│  URL: 本地或專用伺服器                   │
└─────────────────────────────────────────┘
```

### 優點

1. ✅ 碳排放系統可立即部署（輕量）
2. ✅ 語音服務獨立運行（需要時才啟動）
3. ✅ 節省成本（語音服務只在需要時運行）
4. ✅ 易於維護和擴展

## 🚀 立即行動方案

### Step 1: 建立碳排放專用 requirements.txt

我會建立一個最小化版本，只包含碳排放需要的套件。

### Step 2: 更新 app.py

讓語音相關的路由變成可選的（如果套件不存在就不載入）。

### Step 3: 重新部署

推送更新後，Render 會自動重新部署。

## 📋 詳細實作步驟

### 1. 建立條件式導入

```python
# app.py
# 碳排放系統（必要）
from routes.carbon_tracking import carbon_bp
app.register_blueprint(carbon_bp)

# 語音系統（可選）
try:
    from routes.asr import asr_bp
    from routes.emotion import emotion_bp
    app.register_blueprint(asr_bp)
    app.register_blueprint(emotion_bp)
    print("✅ 語音服務已啟用")
except ImportError:
    print("⚠️ 語音服務未安裝（僅碳排放模式）")
```

### 2. 建立多個 requirements 檔案

```
requirements.txt              # 基礎套件（碳排放）
requirements_voice.txt        # 語音相關套件
requirements_full.txt         # 完整套件（本地開發用）
```

### 3. 部署策略

```
Render (碳排放)：
- 使用 requirements.txt
- 只部署輕量級功能
- Free 方案足夠

本地/專用伺服器 (語音)：
- 使用 requirements_full.txt
- 需要 GPU 支援
- 提供 API 給主系統呼叫
```

## 🔧 未來擴展方案

### 當語音服務需要上線時

#### 選項 1：升級 Render 方案

```
Render Starter ($7/月)：
- 512MB RAM → 可能還是不夠
- 建議：Pro ($25/月) 2GB RAM
```

#### 選項 2：使用專門的 AI 平台

```
- Hugging Face Spaces (免費 GPU)
- Google Cloud Run (按使用付費)
- AWS Lambda (Serverless)
- Railway (更大記憶體)
```

#### 選項 3：混合部署

```
- 碳排放：Render Free
- 語音識別：Hugging Face Spaces
- 情緒識別：本地伺服器
```

## 💡 建議的最終架構

```
生產環境：
┌──────────────────────────────────────────┐
│  前端 (Vercel/Netlify - 免費)             │
│  - 靜態檔案                               │
│  - PWA                                    │
└──────────────────────────────────────────┘
         ↓
┌──────────────────────────────────────────┐
│  API Gateway (Render Free)                │
│  - 路由分發                               │
│  - 認證授權                               │
└──────────────────────────────────────────┘
    ↓                    ↓
┌─────────────┐    ┌──────────────────────┐
│ 碳排放服務   │    │   語音服務            │
│ (Render)    │    │   (HF Spaces/本地)   │
│ - 輕量級    │    │   - GPU 加速         │
└─────────────┘    └──────────────────────┘
```

## 🎯 當前優先順序

### 第一階段（現在）：碳排放系統上線

1. ✅ 使用最小化 requirements.txt
2. ✅ 部署到 Render
3. ✅ 建置 Android APK
4. ✅ 上架 Google Play

### 第二階段（未來）：語音服務上線

1. 評估使用量
2. 選擇合適的部署平台
3. 整合 API
4. 更新 Android App

## 📝 實作檢查清單

- [ ] 建立 requirements.txt（最小化）
- [ ] 建立 requirements_full.txt（完整版）
- [ ] 更新 app.py（條件式導入）
- [ ] 測試本地運行
- [ ] 推送到 GitHub
- [ ] Render 重新部署
- [ ] 測試部署成功
- [ ] 建置 Android APK

## 🚀 開始實作

準備好了嗎？我現在就幫你：

1. 建立最小化的 requirements.txt
2. 更新 app.py 支援條件式導入
3. 推送更新並重新部署

這樣碳排放系統就能立即上線，語音服務可以之後再整合！
