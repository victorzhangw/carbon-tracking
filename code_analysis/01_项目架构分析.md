# Flask-AICares 項目架構分析

## 一、專案概述

本專案為**多功能 AI 客服平台**，整合了五大核心功能模組，基於 Flask 框架構建。

### 核心技術棧
- **後端框架**: Flask (Python 3.8+)
- **前端**: PWA 漸進式網頁應用
- **數據庫**: SQLite (使用 SQLAlchemy)
- **AI服務**: DeepSeek-V3 (via SiliconFlow API)
- **語音處理**: 
  - GPT-SoVITS (語音克隆)
  - F5-TTS (語音合成)
  - Whisper & FunASR (語音識別)
- **音視頻處理**: FFmpeg

---

## 二、專案結構分析

### 2.1 核心入口文件

#### `app.py` (主應用入口)
```python
主要功能:
1. Flask 應用初始化
2. CORS 跨域配置
3. JWT 認證系統 (可選)
4. 模組化路由註冊 (條件式載入)
5. 應用初始化邏輯

核心模組載入順序:
✅ 碳排放追蹤系統 (必須)
⚠️  主頁面、員工管理、音訊處理、認證系統 (條件式)
⚠️  語音克隆、TTS、語音對話、情緒識別、ASR (條件式)
```

### 2.2 配置文件

#### `config.py`
- 數據庫路徑配置
- 音頻上傳目錄配置
- DeepSeek AI API 配置
- 目錄自動創建功能

#### `database.py` (699行 - 核心數據層)
```
數據表結構:
├── 用戶管理
│   ├── users (用戶表)
│   ├── roles (角色表)
│   ├── permissions (權限表)
│   ├── user_roles (用戶角色關聯)
│   └── role_permissions (角色權限關聯)
├── 業務數據
│   ├── staff (客服專員表)
│   └── audio (音頻記錄表)
└── 語音模型
    ├── voice_models (語音模型信息)
    └── voice_generations (語音生成記錄)

權限系統:
- 基於RBAC (角色-權限)
- 預設角色: admin, manager, staff, viewer
- 預設管理員: username=admin, password=admin123
```

#### `auth.py`
- JWT Token 驗證裝飾器
- 權限驗證裝飾器
- 角色驗證裝飾器
- 當前用戶獲取功能

#### `utils.py`
- 檔案大小格式化
- JSON 修復工具
- 檔案操作輔助函數

---

## 三、路由模組架構 (routes/)

### 3.1 核心業務路由

#### 1. `carbon_tracking.py` (419行) ✅ 核心模組
**碳排放追蹤系統**
```
功能端點:
├── 頁面路由
│   ├── / (首頁)
│   ├── /dashboard (儀表板)
│   ├── /visit-records (訪視記錄)
│   ├── /add-visit (新增訪視)
│   ├── /edit-visit (編輯訪視)
│   └── /statistics (統計報表)
├── API端點
│   ├── GET/POST /api/visit-records (訪視記錄CRUD)
│   ├── GET /api/monthly-statistics (月度統計)
│   ├── GET /api/statistics-summary (統計摘要)
│   ├── GET /api/transport-distribution (交通工具分布)
│   └── GET /api/social-workers (社工列表)
└── 資料匯出
    ├── /api/export/excel (Excel匯出)
    └── /api/export/csv (CSV匯出)

特色:
- 支持多條件搜尋篩選
- 實時計算碳排放量
- 完整的統計分析功能
- 數據匯出功能 (Excel/CSV)
```

#### 2. `voice_clone.py` (403行)
**語音克隆系統**
```
核心流程:
1. 生成閱讀文字 (/generate_reading_text)
2. 上傳語音樣本 (/upload_voice_sample)
   - 音頻處理 (切分/降噪)
   - 特徵提取
   - 模型設置
3. 生成語音回應 (/generate_response_voice)
   - 支持多輪對話
   - 上下文記憶
   - 情感分析
4. 語音模型管理
   - 模型列表查詢
   - 模型信息查詢
   - 測試語音生成

多輪對話支持:
- conversation_context: 對話歷史
- response_style: 回應風格 (friendly/professional/casual/detailed)
- conversation_mode: 對話模式 (continuous/qa/creative)
- conversation_round: 對話輪次
```

#### 3. `voice_chat.py` (333行)
**語音互動聊天系統**
```
完整流程:
語音輸入 → 語音識別 → AI分析 → 文字回應 → 語音合成 → 語音輸出

端點:
├── /recognize_speech (語音識別)
│   └── 使用 Google Speech Recognition (zh-TW)
├── /get_ai_response (AI回應生成)
├── /generate_response_voice (語音合成)
├── /full_conversation (完整對話流程)
└── /get_available_voices (可用語音列表)
```

#### 4. `asr.py` (290行)
**ASR 語音識別系統**
```
雙引擎架構:
├── Whisper 引擎 (主引擎)
└── FunASR 引擎 (可選)

優化功能:
├── 閩南語檢測與優化
├── 長者語音檢測
├── 融合策略 (雙引擎結果融合)
└── 批次識別

API端點:
├── POST /api/asr/recognize (單音頻識別)
├── POST /api/asr/batch-recognize (批次識別)
├── GET /api/asr/status (系統狀態)
├── POST /api/asr/clear-cache (清理快取)
└── GET /api/asr/health (健康檢查)
```

### 3.2 支援路由

#### `main.py` (138行)
- 主頁面渲染
- 音頻處理端點
- TTS端點
- 靜態文件服務

#### `staff.py` (173行)
- 客服專員CRUD
- 權限控制
- 音頻目錄管理

#### `audio.py` (346行)
- 音頻上傳/下載/串流
- 情緒識別整合
- 音頻編輯功能

#### `auth.py` (150行)
- 登入/登出
- Token刷新
- 用戶註冊
- 個人資料查詢

#### `emotion.py` (186行)
- 單音頻情緒分析
- 批量情緒分析
- 上傳即時分析
- 模型狀態管理

#### `simple_tts.py` (159行)
- 簡單TTS生成
- 參考音頻列表
- GPT-SoVITS整合

---

## 四、服務層架構 (services/)

### 4.1 AI服務

#### `ai.py` (149行)
**DeepSeek AI 對話服務**
```python
核心功能:
1. analyze_and_respond_with_context()
   - 多輪對話支持
   - 上下文管理 (保留最近6條消息)
   - 動態提示詞構建
   - 情感分析

2. 提示詞策略:
   - 基礎提示: 專業社工角色設定
   - 風格調整: friendly/professional/casual/detailed
   - 模式調整: continuous/qa/creative
   - 輪次調整: 開始/前期/深度階段

3. Temperature 策略:
   - friendly: 0.8
   - professional: 0.5
   - casual: 0.9
   - detailed: 0.6
```

### 4.2 語音服務

#### `tts.py` (140行)
**新版 GPT-SoVITS TTS 服務**
```python
API地址: http://127.0.0.1:9880/tts

參數配置:
- text: 要轉換的文字
- ref_audio_path: 參考音頻
- prompt_text: 提示文字
- text_lang: zh (中文)
- temperature: 1.1
- batch_size: 20

特點:
- 本地API調用
- 自動回退機制
- 參考音頻智能查找
```

#### `gpt_sovits_service.py` (314行)
**GPT-SoVITS 語音克隆完整工作流**
```python
處理流程:
1. 生成閱讀文字 (generate_reading_text)
2. 音頻上傳處理 (process_uploaded_audio)
   - 簡化處理: 跳過切分和降噪
3. 語音模型設置 (setup_voice_model)
   - 創建標註文件
   - 簡化特徵提取
4. 語音回應生成 (generate_voice_response)
   - Gradio Client 調用
   - 自動回退到模擬模式

注意: 部分功能簡化以提高穩定性
```

#### `speech.py` (150行)
**語音識別與音頻處理**
```python
Python 3.13 兼容性處理:
- FFmpeg 音頻轉換 (替代 pydub)
- Google Speech Recognition
- 音頻時長獲取

語音識別:
- 語言: zh-TW (繁體中文)
- 動態能量閾值
- 環境噪音調整
```

### 4.3 情緒識別

#### `emotion_recognition.py` (123行)
**基礎情緒識別**
```python
特徵提取:
- MFCC (梅爾頻率倒譜係數)
- Spectral Centroid (光譜質心)
- Zero Crossing Rate (零交叉率)
- Tempo (節拍)

分類方法:
- 基於規則的簡單分類
- 情緒類別: neutral/happy/sad/angry/fear/surprise
```

#### `emotion_recognition_advanced.py`
- 基於 Wav2Vec2 的深度學習模型
- 更高精度的情緒識別

### 4.4 ASR 服務層

**ASR協調器架構** (`services/asr/`)
```
coordinator.py      # 主協調器
├── whisper_engine.py   # Whisper 引擎
├── funasr_engine.py    # FunASR 引擎
├── fusion.py           # 結果融合
├── minnan_detector.py  # 閩南語檢測
└── elderly_detector.py # 長者語音檢測
```

---

## 五、功能模組 (modules/)

### 5.1 碳排放追蹤模組

#### `carbon_tracking/database_carbon_tracking.py` (435行)
```python
資料表:
1. visit_records (訪視記錄)
2. elders (長者基本資料)
3. social_workers (社工基本資料)
4. ai_care_records (AI關懷記錄)
5. monthly_statistics (月度統計)
6. emission_coefficients (排放係數)

排放係數 (環保署6.0.4版):
- 機車: 0.0695 kg CO2e/km
- 汽車: 0.1850 kg CO2e/km
- 大眾運輸: 0.0295 kg CO2e/km

核心功能:
- 自動計算碳排放
- 月度統計分析
- 多條件搜尋
- 統計摘要生成
```

### 5.2 語音處理模組

**voice_processing/**
- `voice_config.py`: 語音配置
- `voice_synthesis_service.py`: 語音合成
- `voice_clone_service.py`: 語音克隆
- `simple_voice_api.py`: 簡化API

### 5.3 人才評鑑模組

**talent_assessment/**
- `talent_assessment_llm_query_generator.py`: LLM查詢生成
- `talent_assessment_query_validator.py`: 查詢驗證

### 5.4 ASR模組

**asr/**
- 雙引擎語音識別系統
- 閩南語優化
- 長者語音優化

---

## 六、項目特色功能

### 6.1 漸進式Web應用 (PWA)

**static/**
- `manifest.json`: PWA配置
- `sw.js`: Service Worker
- `pwa-register.js`: PWA註冊

**支持功能:**
- 離線使用
- 推送通知
- 桌面安裝
- Android App打包

### 6.2 Android應用

**android_app/**
- Gradle構建系統
- APK/AAB打包
- Google Play上架準備

### 6.3 測試系統

**tests/**
```
deployment/        # 部署測試
integration/       # 整合測試
performance/       # 性能測試
unit/             # 單元測試
```

---

## 七、數據與資產管理

### 7.1 數據庫

**data/databases/**
- `customer_service.db`: 主數據庫
- `carbon_tracking.db`: 碳排放數據庫

### 7.2 資產文件

**assets/**
- `audio/`: 音頻文件存儲
- `images/`: 圖片資源

### 7.3 配置文件

**config/**
```
api_specs/         # API規格文檔
deployment/        # 部署配置
requirements/      # 依賴管理
  ├── base.txt     # 基礎依賴
  ├── full.txt     # 完整依賴
  ├── minimal.txt  # 最小依賴
  ├── voice.txt    # 語音相關
  ├── asr.txt      # ASR相關
  └── carbon.txt   # 碳追蹤相關
```

---

## 八、腳本工具

### 8.1 啟動腳本 (scripts/startup/)
- `start_carbon_tracking.bat`: 碳追蹤系統
- `start-gpt-sovits.bat`: GPT-SoVITS服務
- `start-voice-api.bat`: 語音API
- `start-voice-clone-service.bat`: 語音克隆服務

### 8.2 數據生成 (scripts/data_generation/)
- 碳排放模擬數據生成
- 圖表生成
- PWA圖標生成

### 8.3 數據處理 (scripts/data_processing/)
- 音頻處理
- 語音分離
- 數據更新

### 8.4 監控工具 (scripts/monitoring/)
- 部署監控
- 語音模型調試
- 統計信息展示

### 8.5 驗證工具 (scripts/validation/)
- 音頻文件檢查
- 數據集驗證
- 標籤驗證

---

## 九、模板系統 (templates/)

### 9.1 碳排放追蹤模板
```
carbon_tracking/
├── index.html          # 首頁
├── dashboard.html      # 儀表板
├── visit_records.html  # 訪視記錄
├── add_visit.html      # 新增訪視
├── edit_visit.html     # 編輯訪視
├── statistics.html     # 統計報表
├── _pwa_head.html      # PWA頭部
└── _pwa_scripts.html   # PWA腳本
```

### 9.2 語音系統模板
- `voice_clone_demo.html`: 語音克隆演示
- `voice_interaction_enhanced.html`: 增強語音互動
- `voice_interaction_realtime.html`: 實時語音互動

### 9.3 其他模板
- `index.html`: 主頁
- `privacy_policy.html`: 隱私政策

---

## 十、前端應用

**webpage/ai-customer-service-frontend/**
- React/Next.js前端應用
- `package.json`: 前端依賴管理
- Node.js 14+ 環境

---

## 十一、文檔系統

### 11.1 專案文檔
- `README.md`: 專案說明
- `FILE_ORGANIZATION_STANDARD.md`: 文件組織標準
- `FILE_MIGRATION_LOG.md`: 文件遷移日誌
- `PROJECT_REORGANIZATION_SNAPSHOT.md`: 重組快照
- `REORGANIZATION_TEAM_GUIDE.md`: 團隊指南
- `REORGANIZATION_VERIFICATION_REPORT.md`: 驗證報告

### 11.2 期末報告
**期末報告/**
- 優化後模型成效比較
- 專業系統驗證及ASR改進
- 推廣成果摘要
- 碳排放減少效益分析
- 降低成本分析
- 人才評鑑系統設計

### 11.3 佐證資料
**佐證資料/**
- 官方文件
- 機構報表
- 系統截圖
- 操作指引

---

## 十二、歸檔系統

**archive/**
```
2025-11/
├── old_docs/          # 舊文檔
├── old_requirements/  # 舊依賴
├── old_scripts/       # 舊腳本
└── reorganization_artifacts/  # 重組產物
```

---

## 總結

本專案採用**模組化、可擴展**的架構設計：

### 優點：
1. ✅ 清晰的模組分離
2. ✅ 條件式模組載入
3. ✅ 完整的權限系統
4. ✅ PWA與移動端支持
5. ✅ 豐富的工具腳本
6. ✅ 詳細的文檔體系

### 技術亮點：
1. 🎯 多引擎ASR系統（Whisper + FunASR）
2. 🎯 語音克隆與合成（GPT-SoVITS + F5-TTS）
3. 🎯 碳排放追蹤與分析
4. 🎯 多輪對話AI客服
5. 🎯 情緒識別整合
6. 🎯 PWA離線功能

### 適用場景：
- 社會服務機構
- 長者關懷系統
- 碳排放管理
- AI語音客服
- 人才評鑑系統
