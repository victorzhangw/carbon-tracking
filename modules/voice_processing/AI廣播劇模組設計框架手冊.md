# AI廣播劇模組設計框架手冊

## 1. 概述

AI廣播劇模組是基於現有語音處理系統的擴展功能，旨在將EPUB電子書轉換為AI語音廣播劇。該模組利用現有的語音合成技術，結合EPUB文件解析，為用戶提供便捷的聽書體驗。

## 2. 功能特性

### 2.1 核心功能
- EPUB文件上傳與解析
- 自動提取章節內容
- AI語音合成生成MP3音頻
- 前端播放器界面
- 書籍管理與播放控制

### 2.2 技術特點
- 支持多章節自動分割
- 智能文本清理與格式化
- 音頻文件合併與壓縮
- 響應式前端設計
- RESTful API接口

## 3. 系統架構

### 3.1 模組結構
```
modules/voice_processing/
├── audiobook_service.py          # AI廣播劇核心服務
├── voice_synthesis_service.py    # 語音合成服務（現有）
├── voice_config.py              # 語音配置（現有）
└── database_emotion_extension.py # 數據庫擴展（現有）

routes/
├── audiobook.py                  # AI廣播劇路由處理

templates/
├── audiobook_player.html         # 前端播放器界面

static/
├── audiobooks/                   # 生成的音頻文件存儲目錄
└── uploads/audiobooks/           # 上傳的EPUB文件存儲目錄
```

### 3.2 依賴關係
- Flask Web框架
- EbookLib（EPUB解析）
- BeautifulSoup（HTML解析）
- PyDub（音頻處理）
- 現有語音合成服務

## 4. 核心組件設計

### 4.1 AudiobookService類

#### 4.1.1 初始化
```python
class AudiobookService:
    def __init__(self, output_dir: str = "audiobooks"):
        self.output_dir = output_dir
        self.voice_service = VoiceSynthesisService()
        self.voice_config = VoiceConfig()
```

#### 4.1.2 主要方法

**extract_text_from_epub()**
- 功能：從EPUB文件中提取文本內容
- 參數：EPUB文件路徑
- 返回：章節列表（標題和內容）

**generate_audiobook()**
- 功能：生成完整的AI廣播劇
- 參數：EPUB文件路徑、書籍ID
- 返回：書籍信息（ID、標題、章節數等）

**_generate_chapter_audio()**
- 功能：生成單個章節的音頻文件
- 參數：章節文本、章節ID、輸出目錄、標題
- 返回：音頻文件路徑

### 4.2 Audiobook路由

#### 4.2.1 API端點

**POST /api/audiobook/upload**
- 功能：上傳EPUB文件並生成廣播劇
- 請求：multipart/form-data格式的EPUB文件
- 響應：書籍ID和基本信息

**GET /api/audiobook/books**
- 功能：獲取已生成的廣播劇列表
- 響應：書籍列表（ID、標題、創建時間等）

**GET /api/audiobook/book/<book_id>**
- 功能：獲取特定廣播劇的詳細信息
- 參數：書籍ID
- 響應：書籍詳細信息和章節列表

**GET /api/audiobook/book/<book_id>/chapter/<chapter_id>/audio**
- 功能：獲取章節音頻文件
- 參數：書籍ID、章節ID
- 響應：MP3音頻文件

**DELETE /api/audiobook/book/<book_id>**
- 功能：刪除廣播劇
- 參數：書籍ID
- 響應：刪除結果

### 4.3 前端播放器

#### 4.3.1 主要組件
- 文件上傳區域
- 書籍庫展示
- 播放器界面
- 章節列表
- 播放控制（播放/暫停、上一首/下一首、進度條、音量控制）

#### 4.3.2 功能特性
- 拖拽上傳支持
- 響應式設計
- 音頻進度控制
- 章節切換
- 音量調節

## 5. 數據流設計

### 5.1 文件處理流程
1. 用戶上傳EPUB文件
2. 服務器接收並保存文件
3. 解析EPUB內容，提取章節
4. 分別生成各章節音頻
5. 合併並壓縮音頻文件
6. 保存生成結果到數據庫
7. 返回處理結果給前端

### 5.2 播放流程
1. 前端請求書籍列表
2. 服務器返回書籍信息
3. 用戶選擇書籍和章節
4. 前端請求音頻文件
5. 服務器返回音頻數據
6. 前端播放音頻

## 6. 錯誤處理

### 6.1 文件處理錯誤
- 不支持的文件格式
- 文件損壞或無法解析
- 存儲空間不足
- 音頻合成失敗

### 6.2 網絡錯誤
- 請求超時
- 網絡連接中斷
- 服務器內部錯誤

### 6.3 用戶操作錯誤
- 未選擇文件
- 選擇不存在的書籍或章節
- 不當的播放控制操作

## 7. 性能優化建議

### 7.1 音頻處理優化
- 使用多線程處理多個章節
- 實現音頻處理隊列
- 添加進度反饋機制

### 7.2 存儲優化
- 定期清理臨時文件
- 實現音頻文件壓縮
- 添加文件緩存機制

### 7.3 用戶體驗優化
- 添加處理進度顯示
- 實現斷點續傳功能
- 提供批量操作支持

## 8. 安全考慮

### 8.1 文件上傳安全
- 文件類型驗證
- 文件大小限制
- 惡意代碼檢測

### 8.2 數據安全
- 用戶數據隔離
- 敏感信息保護
- 訪問權限控制

### 8.3 系統安全
- API接口驗證
- 請求頻率限制
- 錯誤信息過濾

## 9. 部署與維護

### 9.1 環境要求
- Python 3.8+
- Flask框架
- 必要的Python依賴庫
- 足夠的存儲空間

### 9.2 配置參數
- 上傳文件大小限制
- 音頻輸出目錄
- 處理併發數限制
- 日誌級別設置

### 9.3 監控與日誌
- 處理進度監控
- 錯誤日誌記錄
- 性能指標收集
- 用戶行為分析

## 10. 未來擴展

### 10.1 功能擴展
- 支持更多電子書格式
- 添加書籤和筆記功能
- 實現個性化語音設置
- 添加社交分享功能

### 10.2 技術升級
- 集成更先進的語音合成技術
- 實現智能章節分割
- 添加語音識別互動功能
- 支持離線播放模式

---

*本手冊基於Flask-AICares項目現有架構設計，旨在為AI廣播劇模組的開發和維護提供指導。*