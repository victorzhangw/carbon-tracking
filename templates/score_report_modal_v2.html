<!-- è©•åˆ†å ±å‘Šå½ˆçª— V2 - ç”¨æˆ¶æ‰‹å‹•è©•åˆ†ç‰ˆæœ¬ -->
<div id="scoreModal" class="score-modal" style="display: none">
  <div class="score-modal-content">
    <div class="score-modal-header">
      <h2><span class="material-icons">edit_note</span> å°è©±è©•åˆ†è¡¨</h2>
      <button class="score-modal-close">&times;</button>
    </div>

    <div class="score-modal-body">
      <!-- çµ±è¨ˆè³‡è¨Šå€å¡Šï¼ˆé ‚éƒ¨ï¼‰ -->
      <div class="score-statistics-top">
        <h3><span class="material-icons">bar_chart</span> å°è©±çµ±è¨ˆ</h3>
        <div class="score-stats-grid">
          <div class="score-stat-card">
            <div class="score-stat-icon">
              <span class="material-icons">chat</span>
            </div>
            <div class="score-stat-content">
              <div class="score-stat-label">å°è©±è¼ªæ•¸</div>
              <div class="score-stat-value" id="statConversations">--</div>
            </div>
          </div>
          <div class="score-stat-card">
            <div class="score-stat-icon">
              <span class="material-icons">edit_note</span>
            </div>
            <div class="score-stat-content">
              <div class="score-stat-label">ç¸½å­—æ•¸</div>
              <div class="score-stat-value" id="statWords">--</div>
            </div>
          </div>
          <div class="score-stat-card">
            <div class="score-stat-icon">
              <span class="material-icons">schedule</span>
            </div>
            <div class="score-stat-content">
              <div class="score-stat-label">æŒçºŒæ™‚é–“</div>
              <div class="score-stat-value" id="statDuration">--</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ç¶œåˆè©•åˆ†é¡¯ç¤ºï¼ˆç§»åˆ°çµ±è¨ˆä¸‹æ–¹ï¼‰ -->
      <div class="score-overall-display">
        <span class="score-overall-label">ç¶œåˆè©•åˆ†</span>
        <span class="score-overall-value" id="overallScoreValue">50</span>
        <span class="score-overall-grade" id="overallGrade">C - å°šå¯</span>
      </div>

      <!-- è©•åˆ†è¼¸å…¥å€å¡Š -->
      <div class="score-input-section">
        <h3><span class="material-icons">star</span> è«‹ç‚ºæœ¬æ¬¡å°è©±è©•åˆ†</h3>
        <p class="score-input-hint">
          è«‹æ ¹æ“šæ‚¨çš„å¯¦éš›é«”é©—ï¼Œç‚ºä»¥ä¸‹ä¸‰å€‹ç¶­åº¦è©•åˆ†ï¼ˆ1-100åˆ†ï¼‰
        </p>

        <!-- æƒ…ç·’è¡¨é”è©•åˆ† -->
        <div class="score-input-group">
          <div class="score-input-header">
            <label class="score-input-label">
              <span class="score-input-icon"
                ><span class="material-icons">sentiment_satisfied</span></span
              >
              <span class="score-input-title">æƒ…ç·’è¡¨é”</span>
            </label>
            <span class="score-input-value" id="emotionScoreDisplay">50</span>
          </div>
          <input
            type="range"
            class="score-slider"
            id="emotionScoreSlider"
            min="1"
            max="100"
            value="50"
          />
          <div class="score-input-description">
            AI æ˜¯å¦èƒ½æº–ç¢ºè­˜åˆ¥ä¸¦å›æ‡‰æ‚¨çš„æƒ…ç·’ï¼Ÿèªæ°£æ˜¯å¦è‡ªç„¶è¦ªåˆ‡ï¼Ÿ
          </div>
        </div>

        <!-- èªéŸ³å“è³ªè©•åˆ† -->
        <div class="score-input-group">
          <div class="score-input-header">
            <label class="score-input-label">
              <span class="score-input-icon"
                ><span class="material-icons">mic</span></span
              >
              <span class="score-input-title">èªéŸ³å“è³ª</span>
            </label>
            <span class="score-input-value" id="voiceScoreDisplay">50</span>
          </div>
          <input
            type="range"
            class="score-slider"
            id="voiceScoreSlider"
            min="1"
            max="100"
            value="50"
          />
          <div class="score-input-description">
            èªéŸ³è­˜åˆ¥æ˜¯å¦æº–ç¢ºï¼ŸTTS èªéŸ³æ˜¯å¦æ¸…æ™°è‡ªç„¶ï¼Ÿ
          </div>
        </div>

        <!-- æ–‡å­—å…§å®¹è©•åˆ† -->
        <div class="score-input-group">
          <div class="score-input-header">
            <label class="score-input-label">
              <span class="score-input-icon"
                ><span class="material-icons">edit_note</span></span
              >
              <span class="score-input-title">æ–‡å­—å…§å®¹</span>
            </label>
            <span class="score-input-value" id="contentScoreDisplay">50</span>
          </div>
          <input
            type="range"
            class="score-slider"
            id="contentScoreSlider"
            min="1"
            max="100"
            value="50"
          />
          <div class="score-input-description">
            AI å›æ‡‰æ˜¯å¦åˆ‡é¡Œï¼Ÿå…§å®¹æ˜¯å¦æœ‰å¹«åŠ©ï¼Ÿæ˜¯å¦æä¾›äº†æœ‰åƒ¹å€¼çš„å»ºè­°ï¼Ÿ
          </div>
        </div>
      </div>

      <!-- æ”¹é€²å»ºè­°è¼¸å…¥ -->
      <div class="score-feedback-section">
        <h3><span class="material-icons">lightbulb</span> æ”¹é€²å»ºè­°</h3>
        <p class="score-feedback-hint">è«‹åˆ†äº«æ‚¨çš„ä½¿ç”¨é«”é©—å’Œæ”¹é€²å»ºè­°ï¼ˆé¸å¡«ï¼‰</p>
        <textarea
          id="feedbackText"
          class="score-feedback-textarea"
          placeholder="ä¾‹å¦‚ï¼šAI çš„å›æ‡‰é€Ÿåº¦å¯ä»¥æ›´å¿«ä¸€äº›ã€å¸Œæœ›èƒ½æ”¯æ´æ›´å¤šèªè¨€ã€èªéŸ³è­˜åˆ¥åœ¨å˜ˆé›œç’°å¢ƒä¸‹ä¸å¤ æº–ç¢º..."
          rows="3"
        ></textarea>
      </div>
    </div>

    <div class="score-modal-footer">
      <button class="btn btn-secondary" onclick="closeScoreModal()">
        å–æ¶ˆ
      </button>
      <button class="btn btn-primary" onclick="submitScoreReport()">
        æäº¤è©•åˆ†
      </button>
    </div>
  </div>
</div>

<style>
  /* çµ±è¨ˆè³‡è¨Šå€å¡Šï¼ˆé ‚éƒ¨ï¼‰ - ç·Šæ¹Šç‰ˆ */
  .score-statistics-top {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 16px;
  }

  .score-statistics-top h3 {
    margin: 0 0 12px 0;
    font-size: 16px;
    font-weight: 600;
    color: #333;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .score-statistics-top h3 .material-icons {
    font-size: 20px;
    color: #5b5bd6;
  }

  .score-stats-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
  }

  .score-stat-card {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    padding: 12px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .score-stat-icon {
    font-size: 24px;
    color: #5b5bd6;
  }

  .score-stat-content {
    flex: 1;
  }

  .score-stat-label {
    font-size: 11px;
    color: #666;
    margin-bottom: 2px;
  }

  .score-stat-value {
    font-size: 18px;
    font-weight: 700;
    color: #333;
  }

  /* è©•åˆ†è¼¸å…¥å€å¡Š - ç·Šæ¹Šç‰ˆ */
  .score-input-section {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 16px;
  }

  .score-input-section h3 {
    margin: 0 0 6px 0;
    font-size: 16px;
    font-weight: 600;
    color: #333;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .score-input-section h3 .material-icons {
    font-size: 20px;
    color: #5b5bd6;
  }

  .score-input-hint {
    margin: 0 0 12px 0;
    font-size: 13px;
    color: #666;
  }

  .score-input-group {
    margin-bottom: 16px;
    padding: 14px;
    background: white;
    border-radius: 6px;
    border: 1px solid #e9ecef;
    transition: border-color 0.2s ease;
  }

  .score-input-group:hover {
    border-color: #5b5bd6;
  }

  .score-input-group:last-of-type {
    margin-bottom: 0;
  }

  .score-input-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }

  .score-input-label {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 14px;
    font-weight: 600;
    color: #333;
    cursor: pointer;
  }

  .score-input-icon {
    font-size: 20px;
    color: #5b5bd6;
  }

  .score-input-value {
    font-size: 20px;
    font-weight: 700;
    color: #5b5bd6;
    min-width: 50px;
    text-align: right;
  }

  .score-slider {
    width: 100%;
    height: 6px;
    border-radius: 3px;
    background: #e9ecef;
    outline: none;
    -webkit-appearance: none;
    margin: 8px 0;
  }

  .score-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #5b5bd6;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
    transition: all 0.2s ease;
  }

  .score-slider::-webkit-slider-thumb:hover {
    transform: scale(1.1);
    box-shadow: 0 3px 8px rgba(91, 91, 214, 0.3);
  }

  .score-slider::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #5b5bd6;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
    border: none;
    transition: all 0.2s ease;
  }

  .score-input-description {
    font-size: 12px;
    color: #666;
    line-height: 1.4;
    margin-top: 6px;
  }

  /* ç¶œåˆè©•åˆ†é¡¯ç¤º - ä¸€è¡Œç‰ˆå‹ */
  .score-overall-display {
    background: #5b5bd6;
    border-radius: 8px;
    padding: 12px 16px;
    color: white;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
  }

  .score-overall-label {
    font-size: 14px;
    font-weight: 600;
    opacity: 0.95;
  }

  .score-overall-value {
    font-size: 28px;
    font-weight: 700;
    flex-shrink: 0;
  }

  .score-overall-grade {
    font-size: 14px;
    font-weight: 600;
    opacity: 0.95;
    text-align: right;
    flex: 1;
  }

  /* æ”¹é€²å»ºè­°å€å¡Š - ç·Šæ¹Šç‰ˆ */
  .score-feedback-section {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 16px;
  }

  .score-feedback-section h3 {
    margin: 0 0 6px 0;
    font-size: 16px;
    font-weight: 600;
    color: #333;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .score-feedback-section h3 .material-icons {
    font-size: 20px;
    color: #5b5bd6;
  }

  .score-feedback-hint {
    margin: 0 0 12px 0;
    font-size: 13px;
    color: #666;
  }

  .score-feedback-textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    font-size: 13px;
    font-family: inherit;
    resize: vertical;
    transition: border-color 0.2s ease;
  }

  .score-feedback-textarea:focus {
    outline: none;
    border-color: #5b5bd6;
  }

  .score-feedback-textarea::placeholder {
    color: #adb5bd;
  }

  /* Modal æŒ‰éˆ•æ¨£å¼ */
  .score-modal-footer .btn {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .score-modal-footer .btn-secondary {
    background: white;
    color: #666;
    border: 1px solid #e9ecef;
  }

  .score-modal-footer .btn-secondary:hover {
    background: #f8f9fa;
    border-color: #dee2e6;
  }

  .score-modal-footer .btn-primary {
    background: #5b5bd6;
    color: white;
  }

  .score-modal-footer .btn-primary:hover {
    background: #4a4ab8;
    box-shadow: 0 4px 8px rgba(91, 91, 214, 0.3);
  }
</style>

<script>
  // åˆå§‹åŒ–è©•åˆ†æ»‘æ¡¿
  document.addEventListener("DOMContentLoaded", function () {
    const sliders = [
      { slider: "emotionScoreSlider", display: "emotionScoreDisplay" },
      { slider: "voiceScoreSlider", display: "voiceScoreDisplay" },
      { slider: "contentScoreSlider", display: "contentScoreDisplay" },
    ];

    sliders.forEach((item) => {
      const slider = document.getElementById(item.slider);
      const display = document.getElementById(item.display);

      if (slider && display) {
        slider.addEventListener("input", function () {
          display.textContent = this.value;
          updateOverallScore();
        });
      }
    });
  });

  // æ›´æ–°ç¶œåˆè©•åˆ†
  function updateOverallScore() {
    const emotion = parseInt(
      document.getElementById("emotionScoreSlider")?.value || 50
    );
    const voice = parseInt(
      document.getElementById("voiceScoreSlider")?.value || 50
    );
    const content = parseInt(
      document.getElementById("contentScoreSlider")?.value || 50
    );

    const overall = Math.round((emotion + voice + content) / 3);

    const overallValue = document.getElementById("overallScoreValue");
    const overallGrade = document.getElementById("overallGrade");

    if (overallValue) {
      overallValue.textContent = overall;
    }

    if (overallGrade) {
      let grade, title;
      if (overall >= 90) {
        grade = "A+";
        title = "å„ªç§€";
      } else if (overall >= 80) {
        grade = "A";
        title = "è‰¯å¥½";
      } else if (overall >= 70) {
        grade = "B";
        title = "ä¸­ä¸Š";
      } else if (overall >= 60) {
        grade = "C";
        title = "å°šå¯";
      } else if (overall >= 50) {
        grade = "D";
        title = "å¾…æ”¹é€²";
      } else {
        grade = "F";
        title = "éœ€åŠ å¼·";
      }
      overallGrade.textContent = `${grade} - ${title}`;
    }
  }

  // æäº¤è©•åˆ†å ±å‘Š
  async function submitScoreReport() {
    const emotion = parseInt(
      document.getElementById("emotionScoreSlider")?.value || 50
    );
    const voice = parseInt(
      document.getElementById("voiceScoreSlider")?.value || 50
    );
    const content = parseInt(
      document.getElementById("contentScoreSlider")?.value || 50
    );
    const feedback = document.getElementById("feedbackText")?.value || "";

    const overall = Math.round((emotion + voice + content) / 3);

    // ç²å–ç•¶å‰ç”¨æˆ¶
    const currentUser = localStorage.getItem("currentUser");
    if (!currentUser) {
      alert("è«‹å…ˆç™»å…¥");
      return;
    }

    const userData = JSON.parse(currentUser);

    // ç²å–æœƒè©±è³‡è¨Š
    if (!window.scoreManager) {
      alert("è©•åˆ†ç³»çµ±æœªåˆå§‹åŒ–");
      return;
    }

    const sessionId = window.scoreManager.sessionId;
    const conversationHistory = window.scoreManager.conversationHistory;
    const duration = Math.floor(
      (new Date() - window.scoreManager.sessionStartTime) / 1000
    );

    try {
      const response = await fetch("/api/submit-user-score", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          session_id: sessionId,
          user_id: userData.id,
          user_name: userData.full_name || userData.username,
          scores: {
            emotion: emotion,
            voice: voice,
            content: content,
            overall: overall,
          },
          feedback: feedback,
          conversation_history: conversationHistory,
          statistics: {
            conversation_count: conversationHistory.length,
            total_words: conversationHistory.reduce(
              (sum, c) => sum + (c.word_count || 0),
              0
            ),
            duration: duration,
          },
        }),
      });

      const result = await response.json();

      if (result.status === "success") {
        alert("è©•åˆ†æäº¤æˆåŠŸï¼æ„Ÿè¬æ‚¨çš„åé¥‹ ğŸ‰");
        closeScoreModal();
      } else {
        throw new Error(result.message || "æäº¤å¤±æ•—");
      }
    } catch (error) {
      console.error("æäº¤è©•åˆ†å¤±æ•—:", error);
      alert("æäº¤è©•åˆ†å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
    }
  }
</script>
