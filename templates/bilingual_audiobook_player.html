<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>雙語AI廣播劇播放器</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Microsoft JhengHei", Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .header {
        text-align: center;
        color: white;
        margin-bottom: 30px;
        padding: 20px;
      }

      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
      }

      .header p {
        font-size: 1.2rem;
        opacity: 0.9;
      }

      .upload-section {
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        margin-bottom: 30px;
      }

      .upload-area {
        border: 3px dashed #ccc;
        border-radius: 10px;
        padding: 40px;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .upload-area:hover {
        border-color: #667eea;
        background-color: #f8f9ff;
      }

      .upload-area i {
        font-size: 3rem;
        color: #667eea;
        margin-bottom: 20px;
      }

      .upload-area h3 {
        color: #333;
        margin-bottom: 10px;
      }

      .upload-area p {
        color: #666;
        margin-bottom: 20px;
      }

      .file-input {
        display: none;
      }

      .upload-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 25px;
        font-size: 1rem;
        cursor: pointer;
        transition: transform 0.2s ease;
      }

      .upload-btn:hover {
        transform: translateY(-2px);
      }

      .library-section {
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        margin-bottom: 30px;
      }

      .section-title {
        color: #333;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #667eea;
      }

      .books-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
      }

      .book-card {
        border: 1px solid #eee;
        border-radius: 10px;
        padding: 20px;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        cursor: pointer;
      }

      .book-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      }

      .book-title {
        font-size: 1.3rem;
        color: #333;
        margin-bottom: 10px;
      }

      .book-meta {
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 15px;
      }

      .player-section {
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      .player-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .current-book {
        font-size: 1.5rem;
        color: #333;
      }

      .close-player {
        background: #ff6b6b;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 20px;
        cursor: pointer;
      }

      /* 雙語播放器特定樣式 */
      .bilingual-controls {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .lang-btn {
        background: #e9ecef;
        color: #495057;
        border: none;
        padding: 10px 20px;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: bold;
      }

      .lang-btn:hover {
        background: #dee2e6;
      }

      .lang-btn.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .sync-btn {
        background: #20c997;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: bold;
      }

      .sync-btn.active {
        background: #198754;
      }

      .players-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
      }

      @media (max-width: 768px) {
        .players-container {
          grid-template-columns: 1fr;
        }
      }

      .player-panel {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .player-title {
        text-align: center;
        color: #333;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #dee2e6;
      }

      .chapter-list {
        max-height: 200px;
        overflow-y: auto;
        margin-bottom: 20px;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 10px;
      }

      .chapter-item {
        padding: 10px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }

      .chapter-item:hover {
        background-color: #e9ecef;
      }

      .chapter-item.active {
        background-color: #667eea;
        color: white;
      }

      .audio-player {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .progress-container {
        margin-bottom: 20px;
      }

      .progress-bar {
        width: 100%;
        height: 8px;
        background: #ddd;
        border-radius: 4px;
        overflow: hidden;
        cursor: pointer;
      }

      .progress {
        height: 100%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        width: 0%;
        transition: width 0.1s ease;
      }

      .time-info {
        display: flex;
        justify-content: space-between;
        color: #666;
        font-size: 0.9rem;
        margin-top: 5px;
      }

      .controls {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        margin-bottom: 20px;
      }

      .control-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: #333;
        cursor: pointer;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s ease;
      }

      .control-btn:hover {
        background-color: #eee;
      }

      .play-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        width: 60px;
        height: 60px;
        font-size: 1.8rem;
      }

      .play-btn:hover {
        background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
      }

      .volume-container {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .volume-slider {
        width: 100px;
      }

      .loading {
        text-align: center;
        padding: 20px;
        color: #666;
      }

      .hidden {
        display: none;
      }

      @media (max-width: 768px) {
        .controls {
          gap: 10px;
        }

        .control-btn {
          width: 40px;
          height: 40px;
          font-size: 1.2rem;
        }

        .play-btn {
          width: 50px;
          height: 50px;
          font-size: 1.5rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1><i class="fas fa-podcast"></i> 雙語AI廣播劇播放器</h1>
        <p>普通話/閩南語對比學習，隨時隨地享受聽書樂趣</p>
      </div>

      <!-- 上傳區域 -->
      <div class="upload-section">
        <h2 class="section-title">上傳EPUB電子書</h2>
        <div class="upload-area" id="uploadArea">
          <i class="fas fa-cloud-upload-alt"></i>
          <h3>拖拽EPUB文件到此處或點擊上傳</h3>
          <p>支持.epub格式的電子書文件</p>
          <button class="upload-btn" id="uploadBtn">選擇文件</button>
          <input type="file" class="file-input" id="fileInput" accept=".epub" />
        </div>
      </div>

      <!-- 書庫區域 -->
      <div class="library-section">
        <h2 class="section-title">我的雙語廣播劇庫</h2>
        <div class="books-grid" id="booksGrid">
          <!-- 書籍卡片將在此處動態生成 -->
          <div class="loading">正在加載書籍列表...</div>
        </div>
      </div>

      <!-- 雙語播放器區域 -->
      <div class="player-section hidden" id="playerSection">
        <div class="player-header">
          <div class="current-book" id="currentBookTitle">書名</div>
          <button class="close-player" id="closePlayer">關閉播放器</button>
        </div>

        <!-- 雙語控制按鈕 -->
        <div class="bilingual-controls">
          <button class="lang-btn active" id="mandarinBtn" data-lang="mandarin">
            普通話
          </button>
          <button class="lang-btn" id="minanBtn" data-lang="minan">
            閩南語
          </button>
          <button class="sync-btn" id="syncBtn">同步播放</button>
        </div>

        <!-- 雙語播放器 -->
        <div class="players-container">
          <!-- 普通話播放器 -->
          <div class="player-panel">
            <h3 class="player-title">普通話版本</h3>
            <div class="chapter-list" id="mandarinChapterList">
              <!-- 章節列表將在此處動態生成 -->
            </div>
            <div class="audio-player">
              <div class="progress-container">
                <div class="progress-bar" id="mandarinProgressBar">
                  <div class="progress" id="mandarinProgress"></div>
                </div>
                <div class="time-info">
                  <span id="mandarinCurrentTime">00:00</span>
                  <span id="mandarinDuration">00:00</span>
                </div>
              </div>

              <div class="controls">
                <button class="control-btn" id="mandarinPrevBtn">
                  <i class="fas fa-step-backward"></i>
                </button>
                <button class="control-btn play-btn" id="mandarinPlayBtn">
                  <i class="fas fa-play"></i>
                </button>
                <button class="control-btn" id="mandarinNextBtn">
                  <i class="fas fa-step-forward"></i>
                </button>
              </div>

              <div class="volume-container">
                <i class="fas fa-volume-up"></i>
                <input
                  type="range"
                  class="volume-slider"
                  id="mandarinVolumeSlider"
                  min="0"
                  max="1"
                  step="0.1"
                  value="1"
                />
              </div>
            </div>
            <audio id="mandarinAudioPlayer"></audio>
          </div>

          <!-- 閩南語播放器 -->
          <div class="player-panel">
            <h3 class="player-title">閩南語版本</h3>
            <div class="chapter-list" id="minanChapterList">
              <!-- 章節列表將在此處動態生成 -->
            </div>
            <div class="audio-player">
              <div class="progress-container">
                <div class="progress-bar" id="minanProgressBar">
                  <div class="progress" id="minanProgress"></div>
                </div>
                <div class="time-info">
                  <span id="minanCurrentTime">00:00</span>
                  <span id="minanDuration">00:00</span>
                </div>
              </div>

              <div class="controls">
                <button class="control-btn" id="minanPrevBtn">
                  <i class="fas fa-step-backward"></i>
                </button>
                <button class="control-btn play-btn" id="minanPlayBtn">
                  <i class="fas fa-play"></i>
                </button>
                <button class="control-btn" id="minanNextBtn">
                  <i class="fas fa-step-forward"></i>
                </button>
              </div>

              <div class="volume-container">
                <i class="fas fa-volume-up"></i>
                <input
                  type="range"
                  class="volume-slider"
                  id="minanVolumeSlider"
                  min="0"
                  max="1"
                  step="0.1"
                  value="1"
                />
              </div>
            </div>
            <audio id="minanAudioPlayer"></audio>
          </div>
        </div>
      </div>
    </div>

    <script>
      class BilingualAudiobookPlayer {
        constructor() {
          this.currentBook = null;
          this.currentChapter = null;
          this.syncMode = false;

          // 普通話播放器元素
          this.mandarinAudio = document.getElementById("mandarinAudioPlayer");
          this.mandarinIsPlaying = false;

          // 閩南語播放器元素
          this.minanAudio = document.getElementById("minanAudioPlayer");
          this.minanIsPlaying = false;

          this.initElements();
          this.bindEvents();
          this.loadBooks();
        }

        initElements() {
          this.uploadArea = document.getElementById("uploadArea");
          this.fileInput = document.getElementById("fileInput");
          this.uploadBtn = document.getElementById("uploadBtn");
          this.booksGrid = document.getElementById("booksGrid");
          this.playerSection = document.getElementById("playerSection");
          this.currentBookTitle = document.getElementById("currentBookTitle");
          this.closePlayer = document.getElementById("closePlayer");

          // 語言切換按鈕
          this.mandarinBtn = document.getElementById("mandarinBtn");
          this.minanBtn = document.getElementById("minanBtn");
          this.syncBtn = document.getElementById("syncBtn");

          // 普通話播放器元素
          this.mandarinChapterList = document.getElementById(
            "mandarinChapterList"
          );
          this.mandarinProgressBar = document.getElementById(
            "mandarinProgressBar"
          );
          this.mandarinProgress = document.getElementById("mandarinProgress");
          this.mandarinCurrentTime = document.getElementById(
            "mandarinCurrentTime"
          );
          this.mandarinDuration = document.getElementById("mandarinDuration");
          this.mandarinPlayBtn = document.getElementById("mandarinPlayBtn");
          this.mandarinPrevBtn = document.getElementById("mandarinPrevBtn");
          this.mandarinNextBtn = document.getElementById("mandarinNextBtn");
          this.mandarinVolumeSlider = document.getElementById(
            "mandarinVolumeSlider"
          );

          // 閩南語播放器元素
          this.minanChapterList = document.getElementById("minanChapterList");
          this.minanProgressBar = document.getElementById("minanProgressBar");
          this.minanProgress = document.getElementById("minanProgress");
          this.minanCurrentTime = document.getElementById("minanCurrentTime");
          this.minanDuration = document.getElementById("minanDuration");
          this.minanPlayBtn = document.getElementById("minanPlayBtn");
          this.minanPrevBtn = document.getElementById("minanPrevBtn");
          this.minanNextBtn = document.getElementById("minanNextBtn");
          this.minanVolumeSlider = document.getElementById("minanVolumeSlider");
        }

        bindEvents() {
          // 上傳相關事件
          this.uploadArea.addEventListener("click", () =>
            this.fileInput.click()
          );
          this.uploadBtn.addEventListener("click", () =>
            this.fileInput.click()
          );
          this.fileInput.addEventListener("change", (e) =>
            this.handleFileUpload(e)
          );

          // 播放器相關事件
          this.closePlayer.addEventListener("click", () =>
            this.closePlayerSection()
          );

          // 語言切換事件
          this.mandarinBtn.addEventListener("click", () =>
            this.switchLanguage("mandarin")
          );
          this.minanBtn.addEventListener("click", () =>
            this.switchLanguage("minan")
          );
          this.syncBtn.addEventListener("click", () => this.toggleSyncMode());

          // 普通話播放器事件
          this.mandarinPlayBtn.addEventListener("click", () =>
            this.toggleMandarinPlay()
          );
          this.mandarinPrevBtn.addEventListener("click", () =>
            this.playMandarinPrevChapter()
          );
          this.mandarinNextBtn.addEventListener("click", () =>
            this.playMandarinNextChapter()
          );
          this.mandarinVolumeSlider.addEventListener("input", (e) =>
            this.setMandarinVolume(e.target.value)
          );
          this.mandarinAudio.addEventListener("timeupdate", () =>
            this.updateMandarinProgress()
          );
          this.mandarinAudio.addEventListener("loadedmetadata", () =>
            this.updateMandarinDuration()
          );
          this.mandarinAudio.addEventListener("ended", () =>
            this.onMandarinAudioEnded()
          );
          this.mandarinProgressBar.addEventListener("click", (e) =>
            this.seekMandarinAudio(e)
          );

          // 閩南語播放器事件
          this.minanPlayBtn.addEventListener("click", () =>
            this.toggleMinanPlay()
          );
          this.minanPrevBtn.addEventListener("click", () =>
            this.playMinanPrevChapter()
          );
          this.minanNextBtn.addEventListener("click", () =>
            this.playMinanNextChapter()
          );
          this.minanVolumeSlider.addEventListener("input", (e) =>
            this.setMinanVolume(e.target.value)
          );
          this.minanAudio.addEventListener("timeupdate", () =>
            this.updateMinanProgress()
          );
          this.minanAudio.addEventListener("loadedmetadata", () =>
            this.updateMinanDuration()
          );
          this.minanAudio.addEventListener("ended", () =>
            this.onMinanAudioEnded()
          );
          this.minanProgressBar.addEventListener("click", (e) =>
            this.seekMinanAudio(e)
          );
        }

        async handleFileUpload(event) {
          const file = event.target.files[0];
          if (!file) return;

          if (!file.name.toLowerCase().endsWith(".epub")) {
            alert("請選擇EPUB格式的文件");
            return;
          }

          const formData = new FormData();
          formData.append("file", file);

          try {
            // 生成雙語版本
            const response = await fetch("/api/audiobook/generate-bilingual", {
              method: "POST",
              body: formData,
            });

            const result = await response.json();

            if (result.success) {
              alert("文件上傳並處理成功！");
              this.loadBooks();
            } else {
              alert("上傳失敗：" + result.error);
            }
          } catch (error) {
            console.error("上傳錯誤:", error);
            alert("上傳過程中發生錯誤");
          }
        }

        async loadBooks() {
          try {
            const response = await fetch("/api/audiobook/books");
            const result = await response.json();

            if (result.success) {
              this.renderBooks(result.books);
            } else {
              this.booksGrid.innerHTML =
                '<div class="loading">加載失敗：' + result.error + "</div>";
            }
          } catch (error) {
            console.error("加載書籍列表錯誤:", error);
            this.booksGrid.innerHTML =
              '<div class="loading">加載失敗，請稍後重試</div>';
          }
        }

        renderBooks(books) {
          if (books.length === 0) {
            this.booksGrid.innerHTML =
              '<div class="loading">暫無廣播劇，請先上傳EPUB文件</div>';
            return;
          }

          this.booksGrid.innerHTML = books
            .map(
              (book) => `
                    <div class="book-card" data-book-id="${book.id}">
                        <div class="book-title">${
                          book.title || "未知書名"
                        }</div>
                        <div class="book-meta">
                            <div>章節數：${book.chapter_count || "未知"}</div>
                            <div>創建時間：${new Date(
                              book.created_at * 1000
                            ).toLocaleString()}</div>
                            <div>語言版本：普通話、閩南語</div>
                        </div>
                    </div>
                `
            )
            .join("");

          // 為每個書籍卡片添加點擊事件
          document.querySelectorAll(".book-card").forEach((card) => {
            card.addEventListener("click", (e) => {
              const bookId = card.getAttribute("data-book-id");
              this.loadBookDetails(bookId);
            });
          });
        }

        async loadBookDetails(bookId) {
          try {
            const response = await fetch(
              `/api/audiobook/book/${bookId}/bilingual-chapters`
            );
            const result = await response.json();

            if (result.success) {
              this.currentBook = result.book;
              this.showPlayer();
              this.renderBilingualChapters(
                result.book.mandarin_chapters,
                result.book.minan_chapters
              );
            } else {
              alert("加載書籍詳情失敗：" + result.error);
            }
          } catch (error) {
            console.error("加載書籍詳情錯誤:", error);
            alert("加載書籍詳情時發生錯誤");
          }
        }

        showPlayer() {
          this.playerSection.classList.remove("hidden");
          this.currentBookTitle.textContent =
            this.currentBook.title || "未知書名";
        }

        closePlayerSection() {
          this.playerSection.classList.add("hidden");
          this.currentBook = null;
          this.currentChapter = null;
          this.mandarinAudio.pause();
          this.mandarinAudio.src = "";
          this.minanAudio.pause();
          this.minanAudio.src = "";
        }

        renderBilingualChapters(mandarinChapters, minanChapters) {
          // 渲染普通話章節
          this.mandarinChapterList.innerHTML = mandarinChapters
            .map(
              (chapter, index) => `
                    <div class="chapter-item" data-chapter-id="${
                      chapter.id
                    }" data-index="${index}">
                        ${chapter.title || `第${index + 1}章`}
                    </div>
                `
            )
            .join("");

          // 渲染閩南語章節
          this.minanChapterList.innerHTML = minanChapters
            .map(
              (chapter, index) => `
                    <div class="chapter-item" data-chapter-id="${
                      chapter.id
                    }" data-index="${index}">
                        ${chapter.title || `第${index + 1}章`}
                    </div>
                `
            )
            .join("");

          // 為普通話章節添加點擊事件
          document
            .querySelectorAll("#mandarinChapterList .chapter-item")
            .forEach((item) => {
              item.addEventListener("click", (e) => {
                const chapterId = item.getAttribute("data-chapter-id");
                const index = parseInt(item.getAttribute("data-index"));
                this.playMandarinChapter(chapterId, index);
              });
            });

          // 為閩南語章節添加點擊事件
          document
            .querySelectorAll("#minanChapterList .chapter-item")
            .forEach((item) => {
              item.addEventListener("click", (e) => {
                const chapterId = item.getAttribute("data-chapter-id");
                const index = parseInt(item.getAttribute("data-index"));
                this.playMinanChapter(chapterId, index);
              });
            });
        }

        async playMandarinChapter(chapterId, index) {
          try {
            // 更新當前章節
            this.currentChapter = {
              id: chapterId,
              index: index,
            };

            // 更新UI
            document
              .querySelectorAll("#mandarinChapterList .chapter-item")
              .forEach((item) => {
                item.classList.remove("active");
              });
            document
              .querySelector(
                `#mandarinChapterList .chapter-item[data-chapter-id="${chapterId}"]`
              )
              .classList.add("active");

            // 獲取音頻文件
            const audioUrl = `/api/audiobook/book/${this.currentBook.id}/chapter/${chapterId}/audio/mandarin`;

            // 設置音頻源並播放
            this.mandarinAudio.src = audioUrl;
            await this.mandarinAudio.play();
            this.mandarinIsPlaying = true;
            this.updateMandarinPlayButton();
          } catch (error) {
            console.error("播放普通話章節錯誤:", error);
            alert("播放普通話章節時發生錯誤");
          }
        }

        async playMinanChapter(chapterId, index) {
          try {
            // 更新當前章節
            this.currentChapter = {
              id: chapterId,
              index: index,
            };

            // 更新UI
            document
              .querySelectorAll("#minanChapterList .chapter-item")
              .forEach((item) => {
                item.classList.remove("active");
              });
            document
              .querySelector(
                `#minanChapterList .chapter-item[data-chapter-id="${chapterId}"]`
              )
              .classList.add("active");

            // 獲取音頻文件
            const audioUrl = `/api/audiobook/book/${this.currentBook.id}/chapter/${chapterId}/audio/minan`;

            // 設置音頻源並播放
            this.minanAudio.src = audioUrl;
            await this.minanAudio.play();
            this.minanIsPlaying = true;
            this.updateMinanPlayButton();
          } catch (error) {
            console.error("播放閩南語章節錯誤:", error);
            alert("播放閩南語章節時發生錯誤");
          }
        }

        switchLanguage(lang) {
          // 移除所有激活狀態
          document.querySelectorAll(".lang-btn").forEach((btn) => {
            btn.classList.remove("active");
          });

          // 激活選定語言
          if (lang === "mandarin") {
            document.getElementById("mandarinBtn").classList.add("active");
            // 可以添加普通話專屬功能
          } else if (lang === "minan") {
            document.getElementById("minanBtn").classList.add("active");
            // 可以添加閩南語專屬功能
          }
        }

        toggleSyncMode() {
          this.syncMode = !this.syncMode;

          if (this.syncMode) {
            this.syncBtn.classList.add("active");
            this.syncBtn.textContent = "取消同步";
            // 啟用同步播放邏輯
          } else {
            this.syncBtn.classList.remove("active");
            this.syncBtn.textContent = "同步播放";
            // 關閉同步播放邏輯
          }
        }

        toggleMandarinPlay() {
          if (!this.currentChapter) {
            alert("請先選擇要播放的章節");
            return;
          }

          if (this.mandarinIsPlaying) {
            this.mandarinAudio.pause();
          } else {
            this.mandarinAudio.play();
          }

          this.mandarinIsPlaying = !this.mandarinIsPlaying;
          this.updateMandarinPlayButton();

          // 如果啟用同步模式，同步控制閩南語播放器
          if (this.syncMode) {
            if (this.mandarinIsPlaying) {
              this.minanAudio.play();
              this.minanIsPlaying = true;
            } else {
              this.minanAudio.pause();
              this.minanIsPlaying = false;
            }
            this.updateMinanPlayButton();
          }
        }

        toggleMinanPlay() {
          if (!this.currentChapter) {
            alert("請先選擇要播放的章節");
            return;
          }

          if (this.minanIsPlaying) {
            this.minanAudio.pause();
          } else {
            this.minanAudio.play();
          }

          this.minanIsPlaying = !this.minanIsPlaying;
          this.updateMinanPlayButton();

          // 如果啟用同步模式，同步控制普通話播放器
          if (this.syncMode) {
            if (this.minanIsPlaying) {
              this.mandarinAudio.play();
              this.mandarinIsPlaying = true;
            } else {
              this.mandarinAudio.pause();
              this.mandarinIsPlaying = false;
            }
            this.updateMandarinPlayButton();
          }
        }

        updateMandarinPlayButton() {
          const icon = this.mandarinPlayBtn.querySelector("i");
          if (this.mandarinIsPlaying) {
            icon.className = "fas fa-pause";
          } else {
            icon.className = "fas fa-play";
          }
        }

        updateMinanPlayButton() {
          const icon = this.minanPlayBtn.querySelector("i");
          if (this.minanIsPlaying) {
            icon.className = "fas fa-pause";
          } else {
            icon.className = "fas fa-play";
          }
        }

        playMandarinPrevChapter() {
          if (!this.currentBook || !this.currentChapter) return;

          const prevIndex = this.currentChapter.index - 1;
          if (prevIndex >= 0) {
            const prevChapter = this.currentBook.mandarin_chapters[prevIndex];
            this.playMandarinChapter(prevChapter.id, prevIndex);
          }
        }

        playMandarinNextChapter() {
          if (!this.currentBook || !this.currentChapter) return;

          const nextIndex = this.currentChapter.index + 1;
          if (nextIndex < this.currentBook.mandarin_chapters.length) {
            const nextChapter = this.currentBook.mandarin_chapters[nextIndex];
            this.playMandarinChapter(nextChapter.id, nextIndex);
          }
        }

        playMinanPrevChapter() {
          if (!this.currentBook || !this.currentChapter) return;

          const prevIndex = this.currentChapter.index - 1;
          if (prevIndex >= 0) {
            const prevChapter = this.currentBook.minan_chapters[prevIndex];
            this.playMinanChapter(prevChapter.id, prevIndex);
          }
        }

        playMinanNextChapter() {
          if (!this.currentBook || !this.currentChapter) return;

          const nextIndex = this.currentChapter.index + 1;
          if (nextIndex < this.currentBook.minan_chapters.length) {
            const nextChapter = this.currentBook.minan_chapters[nextIndex];
            this.playMinanChapter(nextChapter.id, nextIndex);
          }
        }

        setMandarinVolume(volume) {
          this.mandarinAudio.volume = volume;
        }

        setMinanVolume(volume) {
          this.minanAudio.volume = volume;
        }

        updateMandarinProgress() {
          const percent =
            (this.mandarinAudio.currentTime / this.mandarinAudio.duration) *
            100;
          this.mandarinProgress.style.width = percent + "%";
          this.mandarinCurrentTime.textContent = this.formatTime(
            this.mandarinAudio.currentTime
          );
        }

        updateMinanProgress() {
          const percent =
            (this.minanAudio.currentTime / this.minanAudio.duration) * 100;
          this.minanProgress.style.width = percent + "%";
          this.minanCurrentTime.textContent = this.formatTime(
            this.minanAudio.currentTime
          );
        }

        updateMandarinDuration() {
          this.mandarinDuration.textContent = this.formatTime(
            this.mandarinAudio.duration
          );
        }

        updateMinanDuration() {
          this.minanDuration.textContent = this.formatTime(
            this.minanAudio.duration
          );
        }

        formatTime(seconds) {
          if (isNaN(seconds)) return "00:00";

          const minutes = Math.floor(seconds / 60);
          const secs = Math.floor(seconds % 60);
          return `${minutes.toString().padStart(2, "0")}:${secs
            .toString()
            .padStart(2, "0")}`;
        }

        seekMandarinAudio(e) {
          const rect = this.mandarinProgressBar.getBoundingClientRect();
          const pos = (e.clientX - rect.left) / rect.width;
          this.mandarinAudio.currentTime = pos * this.mandarinAudio.duration;

          // 如果啟用同步模式，同步.seek閩南語播放器
          if (this.syncMode) {
            this.minanAudio.currentTime = pos * this.minanAudio.duration;
          }
        }

        seekMinanAudio(e) {
          const rect = this.minanProgressBar.getBoundingClientRect();
          const pos = (e.clientX - rect.left) / rect.width;
          this.minanAudio.currentTime = pos * this.minanAudio.duration;

          // 如果啟用同步模式，同步.seek普通話播放器
          if (this.syncMode) {
            this.mandarinAudio.currentTime = pos * this.mandarinAudio.duration;
          }
        }

        onMandarinAudioEnded() {
          this.mandarinIsPlaying = false;
          this.updateMandarinPlayButton();
          // 自動播放下一章
          this.playMandarinNextChapter();
        }

        onMinanAudioEnded() {
          this.minanIsPlaying = false;
          this.updateMinanPlayButton();
          // 自動播放下一章
          this.playMinanNextChapter();
        }
      }

      // 初始化播放器
      document.addEventListener("DOMContentLoaded", () => {
        new BilingualAudiobookPlayer();
      });
    </script>
  </body>
</html>
