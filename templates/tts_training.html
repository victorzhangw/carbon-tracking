<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TTS èªéŸ³åˆæˆè¨“ç·´</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
          "Microsoft JhengHei", sans-serif;
        background: #e8e8e8;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .header {
        background: white;
        padding: 15px 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .back-link {
        color: #0d6efd;
        text-decoration: none;
        font-size: 14px;
      }

      .back-link:hover {
        text-decoration: underline;
      }

      .header h1 {
        font-size: 20px;
        color: #333;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .status-indicator {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 16px;
        background: #f8f9fa;
        border-radius: 6px;
        font-size: 14px;
      }

      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #6c757d;
        animation: pulse 2s infinite;
      }

      .status-dot.loading {
        background: #ffc107;
      }

      .status-dot.running {
        background: #28a745;
      }

      .status-dot.error {
        background: #dc3545;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .loading-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: 20px;
        padding: 40px;
      }

      .loading-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #0d6efd;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .loading-text {
        font-size: 16px;
        color: #666;
      }

      .error-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: 20px;
        padding: 40px;
      }

      .error-icon {
        font-size: 64px;
      }

      .error-text {
        font-size: 18px;
        color: #dc3545;
        text-align: center;
      }

      .retry-btn {
        padding: 10px 24px;
        background: #0d6efd;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        transition: background 0.2s;
      }

      .retry-btn:hover {
        background: #0b5ed7;
      }

      .iframe-container {
        flex: 1;
        display: none;
        position: relative;
      }

      .iframe-container.show {
        display: block;
      }

      iframe {
        width: 100%;
        height: 100%;
        border: none;
      }

      .tips {
        background: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 6px;
        padding: 12px 16px;
        margin: 10px 20px;
        font-size: 14px;
        color: #856404;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <div class="header-left">
        <a href="/voice-testing" class="back-link">â† è¿”å›</a>
        <h1>ğŸ™ï¸ TTS èªéŸ³åˆæˆè¨“ç·´</h1>
      </div>
      <div class="status-indicator">
        <div class="status-dot loading" id="statusDot"></div>
        <span id="statusText">æ­£åœ¨å•Ÿå‹•...</span>
      </div>
    </div>

    <div class="tips" id="tips">
      ğŸ’¡ æç¤ºï¼šé¦–æ¬¡å•Ÿå‹•å¯èƒ½éœ€è¦ 20-30 ç§’ï¼Œè«‹è€å¿ƒç­‰å¾…...
    </div>

    <div class="loading-container" id="loadingContainer">
      <div class="loading-spinner"></div>
      <div class="loading-text">æ­£åœ¨å•Ÿå‹• GPT-SoVITS è¨“ç·´ç³»çµ±...</div>
      <div class="loading-text" style="font-size: 14px; color: #999">
        é€™å¯èƒ½éœ€è¦ä¸€äº›æ™‚é–“ï¼Œè«‹ç¨å€™
      </div>
    </div>

    <div class="error-container" id="errorContainer" style="display: none">
      <div class="error-icon">âš ï¸</div>
      <div class="error-text">
        ç„¡æ³•é€£æ¥åˆ° GPT-SoVITS æœå‹™<br />
        è«‹ç¢ºèªæœå‹™æ˜¯å¦æ­£å¸¸å•Ÿå‹•
      </div>
      <button class="retry-btn" onclick="retryConnection()">é‡è©¦</button>
    </div>

    <div class="iframe-container" id="iframeContainer">
      <iframe src="http://localhost:9874" id="gptsovitsFrame"></iframe>
    </div>

    <script>
      let checkInterval = null;
      let retryCount = 0;
      const maxRetries = 60; // æœ€å¤šé‡è©¦ 60 æ¬¡ï¼ˆ60 ç§’ï¼‰

      // æª¢æŸ¥æœå‹™ç‹€æ…‹
      async function checkStatus() {
        try {
          const response = await fetch("/api/gptsovits/status");
          const data = await response.json();

          if (data.running) {
            // æœå‹™å·²å•Ÿå‹•
            showIframe();
          } else {
            retryCount++;
            if (retryCount >= maxRetries) {
              showError();
            }
          }
        } catch (error) {
          console.error("æª¢æŸ¥ç‹€æ…‹å¤±æ•—:", error);
          retryCount++;
          if (retryCount >= maxRetries) {
            showError();
          }
        }
      }

      // é¡¯ç¤º iframe
      function showIframe() {
        clearInterval(checkInterval);

        document.getElementById("loadingContainer").style.display = "none";
        document.getElementById("errorContainer").style.display = "none";
        document.getElementById("iframeContainer").classList.add("show");
        document.getElementById("tips").style.display = "none";

        // æ›´æ–°ç‹€æ…‹
        const statusDot = document.getElementById("statusDot");
        const statusText = document.getElementById("statusText");
        statusDot.className = "status-dot running";
        statusText.textContent = "é‹è¡Œä¸­";

        console.log("âœ… GPT-SoVITS å·²å°±ç·’");
      }

      // é¡¯ç¤ºéŒ¯èª¤
      function showError() {
        clearInterval(checkInterval);

        document.getElementById("loadingContainer").style.display = "none";
        document.getElementById("errorContainer").style.display = "flex";
        document.getElementById("tips").style.display = "none";

        // æ›´æ–°ç‹€æ…‹
        const statusDot = document.getElementById("statusDot");
        const statusText = document.getElementById("statusText");
        statusDot.className = "status-dot error";
        statusText.textContent = "å•Ÿå‹•å¤±æ•—";
      }

      // é‡è©¦é€£æ¥
      function retryConnection() {
        retryCount = 0;
        document.getElementById("errorContainer").style.display = "none";
        document.getElementById("loadingContainer").style.display = "flex";
        document.getElementById("tips").style.display = "block";

        // æ›´æ–°ç‹€æ…‹
        const statusDot = document.getElementById("statusDot");
        const statusText = document.getElementById("statusText");
        statusDot.className = "status-dot loading";
        statusText.textContent = "æ­£åœ¨å•Ÿå‹•...";

        // é‡æ–°é–‹å§‹æª¢æŸ¥
        checkInterval = setInterval(checkStatus, 1000);
      }

      // é é¢è¼‰å…¥æ™‚é–‹å§‹æª¢æŸ¥
      window.addEventListener("DOMContentLoaded", () => {
        console.log("ğŸ“Š é–‹å§‹æª¢æŸ¥ GPT-SoVITS ç‹€æ…‹...");
        checkInterval = setInterval(checkStatus, 1000);

        // ç«‹å³æª¢æŸ¥ä¸€æ¬¡
        checkStatus();
      });

      // é é¢å¸è¼‰æ™‚æ¸…ç†
      window.addEventListener("beforeunload", () => {
        if (checkInterval) {
          clearInterval(checkInterval);
        }
      });
    </script>
  </body>
</html>
