<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å°è©±è©•åˆ†åˆ†æ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
          "Microsoft JhengHei", sans-serif;
        background: #e8e8e8;
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      .header {
        background: white;
        padding: 30px;
        border-radius: 8px;
        margin-bottom: 30px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      }

      .header h1 {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 12px;
        color: #1a1a1a;
      }

      .header p {
        font-size: 16px;
        color: #6c757d;
        line-height: 1.6;
      }

      .back-link {
        display: inline-block;
        margin-bottom: 20px;
        color: #0d6efd;
        text-decoration: none;
        font-size: 14px;
      }

      .back-link:hover {
        text-decoration: underline;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: white;
        padding: 24px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
      }

      .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
      }

      .stat-card-icon {
        font-size: 36px;
        margin-bottom: 12px;
      }

      .stat-card-label {
        font-size: 14px;
        color: #6c757d;
        margin-bottom: 8px;
        font-weight: 500;
      }

      .stat-card-value {
        font-size: 32px;
        font-weight: bold;
        color: #212529;
      }

      .chart-section {
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        margin-bottom: 30px;
      }

      .chart-section h2 {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 20px;
        color: #333;
      }

      .chart-container {
        position: relative;
        height: 400px;
        margin-bottom: 20px;
      }

      .history-section {
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        margin-bottom: 30px;
      }

      .history-section h2 {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 20px;
        color: #333;
      }

      .history-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }

      .history-table thead {
        background: #f8f9fa;
      }

      .history-table th {
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
      }

      .history-table td {
        padding: 12px;
        border-bottom: 1px solid #dee2e6;
      }

      .history-table tbody tr:hover {
        background: #f8f9fa;
      }

      .grade-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
      }

      .grade-S {
        background: #ffd700;
        color: #856404;
      }

      .grade-A {
        background: #28a745;
        color: white;
      }

      .grade-B {
        background: #17a2b8;
        color: white;
      }

      .grade-C {
        background: #ffc107;
        color: #856404;
      }

      .grade-D {
        background: #dc3545;
        color: white;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #6c757d;
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
      }

      .empty-state-icon {
        font-size: 64px;
        margin-bottom: 16px;
      }

      .filter-section {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .filter-btn {
        padding: 10px 20px;
        border: 2px solid #0d6efd;
        background: white;
        color: #0d6efd;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .filter-btn:hover {
        background: #0d6efd;
        color: white;
      }

      .filter-btn.active {
        background: #0d6efd;
        color: white;
      }

      .progress-indicator {
        margin-top: 20px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 12px;
      }

      .progress-indicator h3 {
        font-size: 18px;
        margin-bottom: 15px;
        color: #333;
      }

      .progress-bar-container {
        margin-bottom: 15px;
      }

      .progress-bar-label {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-size: 14px;
        color: #495057;
      }

      .progress-bar {
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
      }

      .progress-bar-fill {
        height: 100%;
        background: #0d6efd;
        border-radius: 4px;
        transition: width 0.5s ease;
      }

      /* åˆ†é æ¨£å¼ */
      .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
      }

      .pagination-info {
        color: #6c757d;
        font-size: 14px;
        margin-right: 20px;
      }

      .pagination-btn {
        padding: 8px 16px;
        border: 2px solid #dee2e6;
        background: white;
        color: #495057;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .pagination-btn:hover:not(:disabled) {
        background: #0d6efd;
        color: white;
        border-color: #0d6efd;
        transform: translateY(-2px);
      }

      .pagination-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .pagination-btn.active {
        background: #0d6efd;
        color: white;
        border-color: #0d6efd;
      }

      .pagination-pages {
        display: flex;
        gap: 5px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <a href="/voice-testing" class="back-link">â† è¿”å›èªéŸ³æ¸¬è©¦è¨“ç·´æ¨¡çµ„</a>

      <div class="header">
        <h1>ğŸ“Š å°è©±è©•åˆ†åˆ†æ</h1>
        <p>
          æŸ¥çœ‹æ‚¨çš„å°è©±è©•åˆ†æ­·å²ã€è¶¨å‹¢åˆ†æå’Œè©³ç´°çµ±è¨ˆè³‡è¨Šã€‚
          äº†è§£æ‚¨åœ¨æƒ…ç·’è¡¨é”ã€èªéŸ³å“è³ªã€æ–‡å­—å…§å®¹ç­‰æ–¹é¢çš„è¡¨ç¾èˆ‡é€²æ­¥ã€‚
        </p>
      </div>

      <!-- çµ±è¨ˆå¡ç‰‡ -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-card-icon">ğŸ“ˆ</div>
          <div class="stat-card-label">ç¸½å°è©±æ¬¡æ•¸</div>
          <div class="stat-card-value" id="totalSessions">--</div>
        </div>

        <div class="stat-card">
          <div class="stat-card-icon">â­</div>
          <div class="stat-card-label">å¹³å‡è©•åˆ†</div>
          <div class="stat-card-value" id="avgScore">--</div>
        </div>

        <div class="stat-card">
          <div class="stat-card-icon">ğŸ†</div>
          <div class="stat-card-label">æœ€ä½³è©•åˆ†</div>
          <div class="stat-card-value" id="bestScore">--</div>
        </div>

        <div class="stat-card">
          <div class="stat-card-icon">ğŸ“Š</div>
          <div class="stat-card-label">é€²æ­¥å¹…åº¦</div>
          <div class="stat-card-value" id="improvement">--</div>
        </div>
      </div>

      <!-- è¶¨å‹¢åœ–è¡¨ -->
      <div class="chart-section">
        <h2>ğŸ“ˆ è©•åˆ†è¶¨å‹¢åˆ†æ</h2>
        <div class="filter-section">
          <button class="filter-btn active" onclick="filterChart('all')">
            å…¨éƒ¨
          </button>
          <button class="filter-btn" onclick="filterChart('recent')">
            æœ€è¿‘30å¤©
          </button>
          <button class="filter-btn" onclick="filterChart('month')">
            æŒ‰æœˆçµ±è¨ˆ
          </button>
        </div>
        <div class="chart-container">
          <canvas id="trendChart"></canvas>
        </div>

        <!-- é€²æ­¥æŒ‡æ¨™ -->
        <div class="progress-indicator">
          <h3>ğŸ’ª å„ç¶­åº¦é€²æ­¥æƒ…æ³</h3>
          <div class="progress-bar-container">
            <div class="progress-bar-label">
              <span>ğŸ­ æƒ…ç·’è¡¨é”</span>
              <span id="emotionProgress">--</span>
            </div>
            <div class="progress-bar">
              <div
                class="progress-bar-fill"
                id="emotionBar"
                style="width: 0%"
              ></div>
            </div>
          </div>
          <div class="progress-bar-container">
            <div class="progress-bar-label">
              <span>ğŸ¤ èªéŸ³å“è³ª</span>
              <span id="voiceProgress">--</span>
            </div>
            <div class="progress-bar">
              <div
                class="progress-bar-fill"
                id="voiceBar"
                style="width: 0%"
              ></div>
            </div>
          </div>
          <div class="progress-bar-container">
            <div class="progress-bar-label">
              <span>ğŸ“ æ–‡å­—å…§å®¹</span>
              <span id="contentProgress">--</span>
            </div>
            <div class="progress-bar">
              <div
                class="progress-bar-fill"
                id="contentBar"
                style="width: 0%"
              ></div>
            </div>
          </div>
        </div>
      </div>

      <!-- è©•åˆ†æ­·å² -->
      <div class="history-section">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
          "
        >
          <h2 style="margin: 0">ğŸ“‹ è©•åˆ†æ­·å²è¨˜éŒ„</h2>
          <div style="display: flex; gap: 10px; align-items: center">
            <span style="color: #6c757d; font-size: 14px">æ¯é é¡¯ç¤º:</span>
            <select
              id="pageSize"
              style="
                padding: 8px 12px;
                border: 2px solid #dee2e6;
                border-radius: 6px;
                font-size: 14px;
                cursor: pointer;
              "
            >
              <option value="10">10 ç­†</option>
              <option value="20" selected>20 ç­†</option>
              <option value="50">50 ç­†</option>
              <option value="100">100 ç­†</option>
            </select>
          </div>
        </div>
        <div id="historyContent">
          <div class="loading">è¼‰å…¥ä¸­...</div>
        </div>
        <div id="pagination" style="margin-top: 20px"></div>
      </div>
    </div>

    <script>
      let allRecords = [];
      let trendChart = null;
      let currentFilter = "all";
      let currentPage = 1;
      let pageSize = 20;

      // è¼‰å…¥è©•åˆ†æ­·å²
      async function loadScoreHistory() {
        try {
          const response = await fetch(
            "/api/score-history?user_id=demo_user&limit=200"
          );
          const result = await response.json();

          if (result.status === "success") {
            allRecords = result.records;

            // æ›´æ–°çµ±è¨ˆå¡ç‰‡
            updateStatistics(result.statistics, allRecords);

            // æ¸²æŸ“æ­·å²è¨˜éŒ„è¡¨æ ¼ï¼ˆå¸¶åˆ†é ï¼‰
            renderHistoryTableWithPagination();

            // ç¹ªè£½è¶¨å‹¢åœ–
            drawTrendChart(allRecords);

            // æ›´æ–°é€²æ­¥æŒ‡æ¨™
            updateProgressIndicators(allRecords);
          } else {
            showError("è¼‰å…¥å¤±æ•—");
          }
        } catch (error) {
          console.error("è¼‰å…¥è©•åˆ†æ­·å²å¤±æ•—:", error);
          showError("è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
        }
      }

      // æ¸²æŸ“æ­·å²è¨˜éŒ„è¡¨æ ¼ï¼ˆå¸¶åˆ†é ï¼‰
      function renderHistoryTableWithPagination() {
        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = startIndex + pageSize;
        const pageRecords = allRecords.slice(startIndex, endIndex);

        renderHistoryTable(pageRecords);
        renderPagination();
      }

      // æ¸²æŸ“åˆ†é æ§ä»¶
      function renderPagination() {
        const totalPages = Math.ceil(allRecords.length / pageSize);
        const paginationContainer = document.getElementById("pagination");

        if (totalPages <= 1) {
          paginationContainer.innerHTML = "";
          return;
        }

        let paginationHTML = '<div class="pagination">';

        // é¡¯ç¤ºè³‡è¨Š
        const startIndex = (currentPage - 1) * pageSize + 1;
        const endIndex = Math.min(currentPage * pageSize, allRecords.length);
        paginationHTML += `
          <div class="pagination-info">
            é¡¯ç¤º ${startIndex}-${endIndex} ç­†ï¼Œå…± ${allRecords.length} ç­†
          </div>
        `;

        // ä¸Šä¸€é æŒ‰éˆ•
        paginationHTML += `
          <button class="pagination-btn" onclick="goToPage(${
            currentPage - 1
          })" ${currentPage === 1 ? "disabled" : ""}>
            â† ä¸Šä¸€é 
          </button>
        `;

        // é ç¢¼æŒ‰éˆ•
        paginationHTML += '<div class="pagination-pages">';

        // è¨ˆç®—é¡¯ç¤ºçš„é ç¢¼ç¯„åœ
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, currentPage + 2);

        // ç¢ºä¿è‡³å°‘é¡¯ç¤º 5 å€‹é ç¢¼ï¼ˆå¦‚æœç¸½é æ•¸è¶³å¤ ï¼‰
        if (endPage - startPage < 4) {
          if (startPage === 1) {
            endPage = Math.min(totalPages, startPage + 4);
          } else if (endPage === totalPages) {
            startPage = Math.max(1, endPage - 4);
          }
        }

        // ç¬¬ä¸€é 
        if (startPage > 1) {
          paginationHTML += `
            <button class="pagination-btn" onclick="goToPage(1)">1</button>
          `;
          if (startPage > 2) {
            paginationHTML += '<span style="padding: 8px;">...</span>';
          }
        }

        // ä¸­é–“é ç¢¼
        for (let i = startPage; i <= endPage; i++) {
          paginationHTML += `
            <button class="pagination-btn ${
              i === currentPage ? "active" : ""
            }" onclick="goToPage(${i})">
              ${i}
            </button>
          `;
        }

        // æœ€å¾Œä¸€é 
        if (endPage < totalPages) {
          if (endPage < totalPages - 1) {
            paginationHTML += '<span style="padding: 8px;">...</span>';
          }
          paginationHTML += `
            <button class="pagination-btn" onclick="goToPage(${totalPages})">${totalPages}</button>
          `;
        }

        paginationHTML += "</div>";

        // ä¸‹ä¸€é æŒ‰éˆ•
        paginationHTML += `
          <button class="pagination-btn" onclick="goToPage(${
            currentPage + 1
          })" ${currentPage === totalPages ? "disabled" : ""}>
            ä¸‹ä¸€é  â†’
          </button>
        `;

        paginationHTML += "</div>";
        paginationContainer.innerHTML = paginationHTML;
      }

      // è·³è½‰åˆ°æŒ‡å®šé 
      function goToPage(page) {
        const totalPages = Math.ceil(allRecords.length / pageSize);
        if (page < 1 || page > totalPages) return;

        currentPage = page;
        renderHistoryTableWithPagination();

        // æ»¾å‹•åˆ°è¡¨æ ¼é ‚éƒ¨
        document
          .querySelector(".history-section")
          .scrollIntoView({ behavior: "smooth" });
      }

      // æ”¹è®Šæ¯é é¡¯ç¤ºæ•¸é‡
      function changePageSize() {
        const pageSizeSelect = document.getElementById("pageSize");
        pageSize = parseInt(pageSizeSelect.value);
        currentPage = 1; // é‡ç½®åˆ°ç¬¬ä¸€é 
        renderHistoryTableWithPagination();
      }

      // æ›´æ–°çµ±è¨ˆè³‡è¨Š
      function updateStatistics(stats, records) {
        document.getElementById("totalSessions").textContent =
          stats.total_sessions || 0;
        document.getElementById("avgScore").textContent = (
          stats.average_score || 0
        ).toFixed(1);
        document.getElementById("bestScore").textContent = (
          stats.best_score || 0
        ).toFixed(1);

        // è¨ˆç®—é€²æ­¥å¹…åº¦ï¼ˆæœ€è¿‘10ç­† vs æœ€æ—©10ç­†ï¼‰
        if (records.length >= 20) {
          const recent10 = records.slice(0, 10);
          const early10 = records.slice(-10);
          const recentAvg =
            recent10.reduce((sum, r) => sum + r.overall_score, 0) / 10;
          const earlyAvg =
            early10.reduce((sum, r) => sum + r.overall_score, 0) / 10;
          const improvement = recentAvg - earlyAvg;
          document.getElementById("improvement").textContent =
            (improvement > 0 ? "+" : "") + improvement.toFixed(1);
        } else {
          document.getElementById("improvement").textContent = "--";
        }
      }

      // æ›´æ–°é€²æ­¥æŒ‡æ¨™
      function updateProgressIndicators(records) {
        if (records.length < 10) return;

        const recent = records.slice(0, 10);
        const early = records.slice(-10);

        const recentEmotion =
          recent.reduce((sum, r) => sum + r.emotion_score, 0) / 10;
        const earlyEmotion =
          early.reduce((sum, r) => sum + r.emotion_score, 0) / 10;
        const emotionImprovement = recentEmotion - earlyEmotion;

        const recentVoice =
          recent.reduce((sum, r) => sum + r.voice_score, 0) / 10;
        const earlyVoice =
          early.reduce((sum, r) => sum + r.voice_score, 0) / 10;
        const voiceImprovement = recentVoice - earlyVoice;

        const recentContent =
          recent.reduce((sum, r) => sum + r.content_score, 0) / 10;
        const earlyContent =
          early.reduce((sum, r) => sum + r.content_score, 0) / 10;
        const contentImprovement = recentContent - earlyContent;

        document.getElementById("emotionProgress").textContent =
          (emotionImprovement > 0 ? "+" : "") + emotionImprovement.toFixed(1);
        document.getElementById("emotionBar").style.width =
          Math.min(100, Math.max(0, (recentEmotion / 100) * 100)) + "%";

        document.getElementById("voiceProgress").textContent =
          (voiceImprovement > 0 ? "+" : "") + voiceImprovement.toFixed(1);
        document.getElementById("voiceBar").style.width =
          Math.min(100, Math.max(0, (recentVoice / 100) * 100)) + "%";

        document.getElementById("contentProgress").textContent =
          (contentImprovement > 0 ? "+" : "") + contentImprovement.toFixed(1);
        document.getElementById("contentBar").style.width =
          Math.min(100, Math.max(0, (recentContent / 100) * 100)) + "%";
      }

      // æ¸²æŸ“æ­·å²è¨˜éŒ„è¡¨æ ¼
      function renderHistoryTable(records) {
        const container = document.getElementById("historyContent");

        if (!records || records.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ“­</div>
              <p>é‚„æ²’æœ‰è©•åˆ†è¨˜éŒ„</p>
              <p style="font-size: 14px; margin-top: 8px;">
                å‰å¾€ <a href="/emotion-analysis">æƒ…ç·’è­˜åˆ¥ç³»çµ±</a> é–‹å§‹å°è©±
              </p>
            </div>
          `;
          return;
        }

        let tableHTML = `
          <table class="history-table">
            <thead>
              <tr>
                <th>æ—¥æœŸæ™‚é–“</th>
                <th>ç­‰ç´š</th>
                <th>ç¶œåˆè©•åˆ†</th>
                <th>æƒ…ç·’</th>
                <th>èªéŸ³</th>
                <th>æ–‡å­—</th>
                <th>å°è©±è¼ªæ•¸</th>
              </tr>
            </thead>
            <tbody>
        `;

        records.forEach((record) => {
          const date = new Date(record.created_at);
          const dateStr = date.toLocaleDateString("zh-TW", {
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
          });

          tableHTML += `
            <tr>
              <td>${dateStr}</td>
              <td>
                <span class="grade-badge grade-${record.grade}">
                  ${record.grade}
                </span>
              </td>
              <td><strong>${record.overall_score.toFixed(1)}</strong></td>
              <td>${record.emotion_score.toFixed(1)}</td>
              <td>${record.voice_score.toFixed(1)}</td>
              <td>${record.content_score.toFixed(1)}</td>
              <td>${record.conversation_count}</td>
            </tr>
          `;
        });

        tableHTML += `
            </tbody>
          </table>
        `;

        container.innerHTML = tableHTML;
      }

      // ç¹ªè£½è¶¨å‹¢åœ–ï¼ˆä½¿ç”¨ Chart.jsï¼‰
      function drawTrendChart(records) {
        if (!records || records.length === 0) return;

        // åè½‰è¨˜éŒ„é †åºï¼ˆå¾èˆŠåˆ°æ–°ï¼‰
        const sortedRecords = [...records].reverse();

        const labels = sortedRecords.map((r) => {
          const date = new Date(r.created_at);
          return date.toLocaleDateString("zh-TW", {
            month: "2-digit",
            day: "2-digit",
          });
        });

        const overallData = sortedRecords.map((r) => r.overall_score);
        const emotionData = sortedRecords.map((r) => r.emotion_score);
        const voiceData = sortedRecords.map((r) => r.voice_score);
        const contentData = sortedRecords.map((r) => r.content_score);

        const ctx = document.getElementById("trendChart");

        if (trendChart) {
          trendChart.destroy();
        }

        trendChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: "ç¶œåˆè©•åˆ†",
                data: overallData,
                borderColor: "#0d6efd",
                backgroundColor: "rgba(13, 110, 253, 0.1)",
                borderWidth: 3,
                tension: 0.4,
                fill: true,
              },
              {
                label: "æƒ…ç·’è¡¨é”",
                data: emotionData,
                borderColor: "#dc3545",
                backgroundColor: "rgba(220, 53, 69, 0.1)",
                borderWidth: 2,
                tension: 0.4,
                fill: false,
              },
              {
                label: "èªéŸ³å“è³ª",
                data: voiceData,
                borderColor: "#28a745",
                backgroundColor: "rgba(40, 167, 69, 0.1)",
                borderWidth: 2,
                tension: 0.4,
                fill: false,
              },
              {
                label: "æ–‡å­—å…§å®¹",
                data: contentData,
                borderColor: "#ffc107",
                backgroundColor: "rgba(255, 193, 7, 0.1)",
                borderWidth: 2,
                tension: 0.4,
                fill: false,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: "top",
              },
              tooltip: {
                mode: "index",
                intersect: false,
              },
            },
            scales: {
              y: {
                beginAtZero: false,
                min: 30,
                max: 100,
                ticks: {
                  stepSize: 10,
                },
              },
              x: {
                ticks: {
                  maxTicksLimit: 20,
                },
              },
            },
          },
        });
      }

      // ç¯©é¸åœ–è¡¨
      function filterChart(type) {
        currentFilter = type;

        // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
        document.querySelectorAll(".filter-btn").forEach((btn) => {
          btn.classList.remove("active");
        });
        event.target.classList.add("active");

        let filteredRecords = allRecords;

        if (type === "recent") {
          // æœ€è¿‘30å¤©
          const thirtyDaysAgo = new Date();
          thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
          filteredRecords = allRecords.filter(
            (r) => new Date(r.created_at) >= thirtyDaysAgo
          );
        } else if (type === "month") {
          // æŒ‰æœˆçµ±è¨ˆï¼ˆå–æ¯æœˆå¹³å‡ï¼‰
          const monthlyData = {};
          allRecords.forEach((r) => {
            const date = new Date(r.created_at);
            const monthKey = `${date.getFullYear()}-${String(
              date.getMonth() + 1
            ).padStart(2, "0")}`;
            if (!monthlyData[monthKey]) {
              monthlyData[monthKey] = [];
            }
            monthlyData[monthKey].push(r);
          });

          filteredRecords = Object.keys(monthlyData)
            .sort()
            .map((month) => {
              const records = monthlyData[month];
              return {
                created_at: `${month}-15`,
                overall_score:
                  records.reduce((sum, r) => sum + r.overall_score, 0) /
                  records.length,
                emotion_score:
                  records.reduce((sum, r) => sum + r.emotion_score, 0) /
                  records.length,
                voice_score:
                  records.reduce((sum, r) => sum + r.voice_score, 0) /
                  records.length,
                content_score:
                  records.reduce((sum, r) => sum + r.content_score, 0) /
                  records.length,
              };
            });
        }

        drawTrendChart(filteredRecords);
      }

      function showError(message) {
        document.getElementById("historyContent").innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">âŒ</div>
            <p>${message}</p>
          </div>
        `;
      }

      // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
      window.addEventListener("DOMContentLoaded", () => {
        loadScoreHistory();

        // ç›£è½é é¢å¤§å°é¸æ“‡å™¨è®ŠåŒ–
        document
          .getElementById("pageSize")
          .addEventListener("change", changePageSize);
      });
    </script>
  </body>
</html>
