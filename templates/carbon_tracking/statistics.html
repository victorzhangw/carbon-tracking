<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>çµ±è¨ˆå ±è¡¨ - ç¢³æ’æ”¾è¿½è¹¤ç³»çµ±</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="ç¤¾å·¥è¨ªè¦–ç¢³æ’æ”¾è¿½è¹¤èˆ‡ç®¡ç†ç³»çµ±" />
    <meta name="theme-color" content="#689F38" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <link rel="manifest" href="/static/manifest.json" />
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico" />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Microsoft JhengHei", Arial, sans-serif;
        background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
      }

      .navbar {
        background: linear-gradient(135deg, #2e7d32 0%, #388e3c 100%);
        color: white;
        padding: 10px 20px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .navbar h1 {
        font-size: 1.2em;
      }
      .navbar a {
        color: white;
        text-decoration: none;
        margin-left: 15px;
        opacity: 0.9;
        font-size: 0.9em;
      }
      .navbar a:hover {
        opacity: 1;
      }

      .container {
        max-width: 1600px;
        margin: 15px auto;
        padding: 0 15px;
      }

      .report-card {
        background: white;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 12px;
      }

      .report-card h2 {
        margin-bottom: 12px;
        color: #2e7d32;
        font-size: 1.1em;
        border-bottom: 2px solid #4caf50;
        padding-bottom: 8px;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 12px;
        margin-bottom: 15px;
      }

      .stat-box {
        background: #e8f5e9;
        padding: 12px;
        border-radius: 6px;
        text-align: center;
      }

      .stat-box .value {
        font-size: 1.4em;
        font-weight: bold;
        color: #2e7d32;
        margin-bottom: 3px;
      }

      .stat-box .label {
        color: #666;
        font-size: 0.8em;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 12px;
        font-size: 0.85em;
      }
      th {
        background: #e8f5e9;
        padding: 8px;
        text-align: left;
        font-weight: 600;
        color: #2e7d32;
        border-bottom: 2px solid #c8e6c9;
      }
      td {
        padding: 8px;
        border-bottom: 1px solid #e8f5e9;
      }
      .highlight {
        background: #fff9c4;
        font-weight: bold;
      }

      @media (max-width: 1200px) {
        .stats-grid {
          grid-template-columns: repeat(3, 1fr);
        }
      }
    </style>
  </head>
  <body>
    <div class="navbar">
      <h1>ğŸ“ˆ çµ±è¨ˆå ±è¡¨</h1>
      <div>
        <a href="/carbon/">â† é¦–é </a>
        <a href="/carbon/dashboard">å„€è¡¨æ¿</a>
        <button
          onclick="exportAllData()"
          style="
            background: white;
            color: #689f38;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
          "
        >
          ğŸ“Š åŒ¯å‡ºå®Œæ•´è³‡æ–™
        </button>
      </div>
    </div>

    <div class="container">
      <div class="report-card">
        <h2>ğŸ“Š ç¸½é«”çµ±è¨ˆï¼ˆ2024/06-09ï¼‰</h2>
        <div class="stats-grid">
          <div class="stat-box">
            <div class="value" id="totalVisits">-</div>
            <div class="label">ç¸½è¨ªè¦–æ¬¡æ•¸</div>
          </div>
          <div class="stat-box">
            <div class="value" id="totalElders">-</div>
            <div class="label">æœå‹™é•·è€…</div>
          </div>
          <div class="stat-box">
            <div class="value" id="totalDistance">-</div>
            <div class="label">ç¸½é‡Œç¨‹ï¼ˆå…¬é‡Œï¼‰</div>
          </div>
          <div class="stat-box">
            <div class="value" id="totalEmission">-</div>
            <div class="label">ç¢³æ’æ”¾ï¼ˆå…¬å™¸ï¼‰</div>
          </div>
          <div class="stat-box">
            <div class="value" id="avgDistance">-</div>
            <div class="label">å¹³å‡é‡Œç¨‹ï¼ˆå…¬é‡Œï¼‰</div>
          </div>
        </div>
      </div>

      <div class="report-card">
        <h2>ğŸ“… æœˆåº¦çµ±è¨ˆæ˜ç´°</h2>
        <table id="monthlyTable">
          <thead>
            <tr>
              <th>æœˆä»½</th>
              <th>è¨ªè¦–æ¬¡æ•¸</th>
              <th>ç¸½é‡Œç¨‹ï¼ˆå…¬é‡Œï¼‰</th>
              <th>ç¢³æ’æ”¾ï¼ˆkgï¼‰</th>
              <th>ç¢³æ’æ”¾ï¼ˆå…¬å™¸ï¼‰</th>
              <th>AIé—œæ‡·æ¬¡æ•¸</th>
            </tr>
          </thead>
          <tbody id="monthlyBody">
            <tr>
              <td colspan="6" style="text-align: center">è¼‰å…¥ä¸­...</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="report-card">
        <h2>ğŸš— äº¤é€šå·¥å…·çµ±è¨ˆ</h2>
        <table id="transportTable">
          <thead>
            <tr>
              <th>äº¤é€šå·¥å…·</th>
              <th>ä½¿ç”¨æ¬¡æ•¸</th>
              <th>ä½¿ç”¨æ¯”ä¾‹</th>
              <th>ç¸½é‡Œç¨‹ï¼ˆå…¬é‡Œï¼‰</th>
              <th>ç¢³æ’æ”¾ï¼ˆkgï¼‰</th>
            </tr>
          </thead>
          <tbody id="transportBody">
            <tr>
              <td colspan="5" style="text-align: center">è¼‰å…¥ä¸­...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <script>
      async function loadStatistics() {
        try {
          const summaryResponse = await fetch(
            "/carbon/api/statistics-summary?start_date=2024-06-01&end_date=2024-09-30"
          );
          const summaryResult = await summaryResponse.json();

          if (summaryResult.success) {
            const data = summaryResult.data;
            document.getElementById("totalVisits").textContent =
              data.total_visits.toLocaleString();
            document.getElementById("totalElders").textContent =
              data.unique_elders.toLocaleString();
            document.getElementById("totalDistance").textContent =
              data.total_distance.toLocaleString(undefined, {
                maximumFractionDigits: 0,
              });
            document.getElementById("totalEmission").textContent = (
              data.total_emission / 1000
            ).toFixed(2);
            document.getElementById("avgDistance").textContent =
              data.avg_distance.toFixed(1);
          }

          const periodResponse = await fetch(
            "/carbon/api/period-statistics?start_date=2024-06-01&end_date=2024-09-30"
          );
          const periodResult = await periodResponse.json();

          if (periodResult.success) {
            const tbody = document.getElementById("monthlyBody");
            tbody.innerHTML = "";

            let totalVisits = 0,
              totalDistance = 0,
              totalEmission = 0,
              totalAiCare = 0;

            periodResult.data.forEach((month) => {
              const row = document.createElement("tr");
              row.innerHTML = `
                            <td>${month.year}/${month.month}</td>
                            <td>${month.physical_visits.toLocaleString()}</td>
                            <td>${month.total_distance.toLocaleString(
                              undefined,
                              { maximumFractionDigits: 0 }
                            )}</td>
                            <td>${month.total_carbon_emission.toLocaleString(
                              undefined,
                              { maximumFractionDigits: 2 }
                            )}</td>
                            <td>${(month.total_carbon_emission / 1000).toFixed(
                              2
                            )}</td>
                            <td>${month.ai_care_count.toLocaleString()}</td>
                        `;
              tbody.appendChild(row);

              totalVisits += month.physical_visits;
              totalDistance += month.total_distance;
              totalEmission += month.total_carbon_emission;
              totalAiCare += month.ai_care_count;
            });

            const totalRow = document.createElement("tr");
            totalRow.className = "highlight";
            totalRow.innerHTML = `
                        <td><strong>ç¸½è¨ˆ</strong></td>
                        <td><strong>${totalVisits.toLocaleString()}</strong></td>
                        <td><strong>${totalDistance.toLocaleString(undefined, {
                          maximumFractionDigits: 0,
                        })}</strong></td>
                        <td><strong>${totalEmission.toLocaleString(undefined, {
                          maximumFractionDigits: 2,
                        })}</strong></td>
                        <td><strong>${(totalEmission / 1000).toFixed(
                          2
                        )}</strong></td>
                        <td><strong>${totalAiCare.toLocaleString()}</strong></td>
                    `;
            tbody.appendChild(totalRow);
          }

          const transportResponse = await fetch(
            "/carbon/api/transport-distribution?start_date=2024-06-01&end_date=2024-09-30"
          );
          const transportResult = await transportResponse.json();

          if (transportResult.success) {
            const tbody = document.getElementById("transportBody");
            tbody.innerHTML = "";

            const totalCount = transportResult.data.reduce(
              (sum, item) => sum + item.count,
              0
            );

            transportResult.data.forEach((item) => {
              const row = document.createElement("tr");
              const percentage = ((item.count / totalCount) * 100).toFixed(1);
              row.innerHTML = `
                            <td>${item.transport_type}</td>
                            <td>${item.count.toLocaleString()}</td>
                            <td>${percentage}%</td>
                            <td>${item.total_distance.toLocaleString(
                              undefined,
                              { maximumFractionDigits: 0 }
                            )}</td>
                            <td>${item.total_emission.toLocaleString(
                              undefined,
                              { maximumFractionDigits: 2 }
                            )}</td>
                        `;
              tbody.appendChild(row);
            });
          }
        } catch (error) {
          console.error("Error loading statistics:", error);
        }
      }

      loadStatistics();

      function exportAllData() {
        if (confirm("ç¢ºå®šè¦åŒ¯å‡ºæ‰€æœ‰è¨ªè¦–è¨˜éŒ„å—ï¼Ÿ\né€™å¯èƒ½éœ€è¦ä¸€äº›æ™‚é–“...")) {
          window.location.href = "/carbon/api/export/excel";
        }
      }
    </script>

    <!-- PWA Service Worker Registration -->
    <script src="/static/pwa-register.js"></script>
  </body>
</html>
