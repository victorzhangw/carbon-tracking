<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>è¨ªè¦–è¨˜éŒ„ - ç¢³æ’æ”¾è¿½è¹¤ç³»çµ±</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="ç¤¾å·¥è¨ªè¦–ç¢³æ’æ”¾è¿½è¹¤èˆ‡ç®¡ç†ç³»çµ±" />
    <meta name="theme-color" content="#689F38" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <link rel="manifest" href="/static/manifest.json" />
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Microsoft JhengHei", Arial, sans-serif;
        background: linear-gradient(135deg, #f9fbe7 0%, #f1f8e9 100%);
      }

      .navbar {
        background: linear-gradient(135deg, #689f38 0%, #7cb342 100%);
        color: white;
        padding: 10px 20px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .navbar h1 {
        font-size: 1.2em;
      }
      .navbar a {
        color: white;
        text-decoration: none;
        margin-left: 15px;
        opacity: 0.9;
        font-size: 0.9em;
      }
      .navbar a:hover {
        opacity: 1;
      }

      .container {
        max-width: 1600px;
        margin: 15px auto;
        padding: 0 15px;
      }

      .toolbar {
        background: white;
        border-radius: 8px;
        padding: 12px 15px;
        margin-bottom: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        font-size: 0.9em;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
      }

      .btn-primary {
        background: #8bc34a;
        color: white;
      }
      .btn-primary:hover {
        background: #7cb342;
      }

      .table-card {
        background: white;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        overflow-x: auto;
        margin-bottom: 12px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85em;
      }
      th {
        background: #f1f8e9;
        padding: 6px 8px;
        text-align: left;
        font-weight: 600;
        color: #558b2f;
        border-bottom: 2px solid #dcedc8;
        font-size: 0.85em;
      }
      td {
        padding: 6px 8px;
        border-bottom: 1px solid #f1f8e9;
        line-height: 1.3;
      }
      tr:hover {
        background: #f9fbe7;
      }

      .badge {
        padding: 3px 6px;
        border-radius: 3px;
        font-size: 0.8em;
        font-weight: 500;
      }
      .badge-motorcycle {
        background: #dcedc8;
        color: #33691e;
      }
      .badge-car {
        background: #c5e1a5;
        color: #558b2f;
      }
      .badge-transit {
        background: #aed581;
        color: #33691e;
      }

      .pagination {
        background: white;
        border-radius: 8px;
        padding: 12px 15px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .pagination-info {
        color: #666;
        font-size: 0.9em;
      }

      .pagination-controls {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .page-btn {
        padding: 6px 12px;
        border: 1px solid #dcedc8;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
        color: #558b2f;
      }

      .page-btn:hover:not(:disabled) {
        background: #f1f8e9;
      }

      .page-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .page-btn.active {
        background: #8bc34a;
        color: white;
        border-color: #8bc34a;
      }

      .loading {
        text-align: center;
        padding: 30px;
        color: #666;
      }

      .search-bar {
        background: white;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      }

      .search-row {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 1fr;
        gap: 10px;
        margin-bottom: 10px;
      }

      .search-input,
      .search-select {
        padding: 8px 10px;
        border: 1px solid #dcedc8;
        border-radius: 4px;
        font-size: 0.9em;
        font-family: inherit;
      }

      .search-input:focus,
      .search-select:focus {
        outline: none;
        border-color: #8bc34a;
        box-shadow: 0 0 0 2px rgba(139, 195, 74, 0.1);
      }

      .search-buttons {
        display: flex;
        gap: 8px;
      }

      .btn-search {
        background: #8bc34a;
        color: white;
        border: none;
        padding: 8px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
      }

      .btn-search:hover {
        background: #7cb342;
      }

      .btn-clear {
        background: #bdbdbd;
        color: white;
        border: none;
        padding: 8px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
      }

      .btn-clear:hover {
        background: #9e9e9e;
      }

      .search-result-info {
        color: #666;
        font-size: 0.9em;
        margin-top: 8px;
      }

      @media (max-width: 768px) {
        .search-row {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="navbar">
      <h1>ğŸ“ è¨ªè¦–è¨˜éŒ„</h1>
      <div>
        <a href="/carbon/">â† é¦–é </a>
        <a href="/carbon/dashboard">å„€è¡¨æ¿</a>
        <a href="/carbon/add-visit">æ–°å¢è¨˜éŒ„</a>
      </div>
    </div>

    <div class="container">
      <!-- æœå°‹åˆ— -->
      <div class="search-bar">
        <div class="search-row">
          <input
            type="text"
            id="searchKeyword"
            class="search-input"
            placeholder="ğŸ” æœå°‹ç¤¾å·¥å§“åã€å·¥è™Ÿæˆ–é•·è€…ç·¨è™Ÿ..."
          />
          <select id="filterWorker" class="search-select">
            <option value="">æ‰€æœ‰ç¤¾å·¥</option>
          </select>
          <input type="date" id="filterStartDate" class="search-input" />
          <input type="date" id="filterEndDate" class="search-input" />
        </div>
        <div class="search-row">
          <select id="filterTransport" class="search-select">
            <option value="">æ‰€æœ‰äº¤é€šå·¥å…·</option>
            <option value="æ©Ÿè»Š">ğŸï¸ æ©Ÿè»Š</option>
            <option value="æ±½è»Š">ğŸš— æ±½è»Š</option>
            <option value="å¤§çœ¾é‹è¼¸">ğŸšŒ å¤§çœ¾é‹è¼¸</option>
          </select>
          <div class="search-buttons">
            <button class="btn-search" onclick="searchRecords()">
              ğŸ” æœå°‹
            </button>
            <button class="btn-clear" onclick="clearSearch()">âœ– æ¸…é™¤</button>
          </div>
        </div>
        <div class="search-result-info" id="searchInfo" style="display: none">
          æ‰¾åˆ° <strong id="searchCount">0</strong> ç­†ç¬¦åˆçš„è¨˜éŒ„
        </div>
      </div>

      <div class="toolbar">
        <div><strong>ç¸½è¨˜éŒ„æ•¸ï¼š</strong><span id="totalCount">-</span></div>
        <div>
          <button
            class="btn btn-primary"
            onclick="exportExcel()"
            style="margin-right: 8px"
          >
            ğŸ“Š åŒ¯å‡º Excel
          </button>
          <button
            class="btn btn-primary"
            onclick="exportCSV()"
            style="margin-right: 8px"
          >
            ğŸ“„ åŒ¯å‡º CSV
          </button>
          <a href="/carbon/add-visit" class="btn btn-primary">â• æ–°å¢è¨˜éŒ„</a>
        </div>
      </div>

      <div class="table-card">
        <div id="loading" class="loading">è¼‰å…¥ä¸­...</div>
        <table id="recordsTable" style="display: none">
          <thead>
            <tr>
              <th>æ—¥æœŸ</th>
              <th>ç¤¾å·¥</th>
              <th>é•·è€…ç·¨è™Ÿ</th>
              <th>è¨ªè¦–é¡å‹</th>
              <th>äº¤é€šå·¥å…·</th>
              <th>é‡Œç¨‹(km)</th>
              <th>ç¢³æ’æ”¾(kg)</th>
              <th>å‚™è¨»</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="recordsBody"></tbody>
        </table>
      </div>

      <div class="pagination" id="pagination" style="display: none">
        <div class="pagination-info">
          é¡¯ç¤ºç¬¬ <span id="startRecord">1</span> -
          <span id="endRecord">50</span> ç­†ï¼Œ å…±
          <span id="totalRecords">0</span> ç­†
        </div>
        <div class="pagination-controls">
          <button class="page-btn" id="firstBtn" onclick="goToPage(1)">
            ç¬¬ä¸€é 
          </button>
          <button class="page-btn" id="prevBtn" onclick="previousPage()">
            ä¸Šä¸€é 
          </button>
          <span id="pageNumbers"></span>
          <button class="page-btn" id="nextBtn" onclick="nextPage()">
            ä¸‹ä¸€é 
          </button>
          <button class="page-btn" id="lastBtn" onclick="goToLastPage()">
            æœ€å¾Œé 
          </button>
        </div>
      </div>
    </div>

    <script>
      let allRecords = [];
      let currentPage = 1;
      const recordsPerPage = 50;
      let isSearching = false;

      async function loadRecords() {
        try {
          const response = await fetch("/carbon/api/visit-records?limit=1000");
          const result = await response.json();

          if (result.success) {
            allRecords = result.data;
            document.getElementById("totalCount").textContent =
              allRecords.length.toLocaleString();
            document.getElementById("totalRecords").textContent =
              allRecords.length.toLocaleString();

            displayPage(1);

            document.getElementById("loading").style.display = "none";
            document.getElementById("recordsTable").style.display = "table";
            document.getElementById("pagination").style.display = "flex";

            // è¼‰å…¥ç¤¾å·¥åˆ—è¡¨åˆ°ç¯©é¸ä¸‹æ‹‰é¸å–®
            loadWorkerList();
          }
        } catch (error) {
          console.error("Error loading records:", error);
          document.getElementById("loading").textContent = "è¼‰å…¥å¤±æ•—";
        }
      }

      async function loadWorkerList() {
        try {
          const response = await fetch("/carbon/api/social-workers");
          const result = await response.json();

          if (result.success) {
            const select = document.getElementById("filterWorker");
            result.data.forEach((worker) => {
              const option = document.createElement("option");
              option.value = worker.id;
              option.textContent = `${worker.name} (${worker.id})`;
              select.appendChild(option);
            });
          }
        } catch (error) {
          console.error("Error loading workers:", error);
        }
      }

      async function searchRecords() {
        const keyword = document.getElementById("searchKeyword").value.trim();
        const workerId = document.getElementById("filterWorker").value;
        const startDate = document.getElementById("filterStartDate").value;
        const endDate = document.getElementById("filterEndDate").value;
        const transportType = document
          .getElementById("filterTransport")
          .value.replace(/[ğŸï¸ğŸš—ğŸšŒ]\s*/, "");

        // å»ºç«‹æŸ¥è©¢åƒæ•¸
        const params = new URLSearchParams();
        params.append("limit", "1000");

        if (keyword) params.append("keyword", keyword);
        if (workerId) params.append("worker_id", workerId);
        if (startDate) params.append("start_date", startDate);
        if (endDate) params.append("end_date", endDate);
        if (transportType) params.append("transport_type", transportType);

        try {
          document.getElementById("loading").style.display = "block";
          document.getElementById("recordsTable").style.display = "none";

          const response = await fetch(
            `/carbon/api/visit-records?${params.toString()}`
          );
          const result = await response.json();

          if (result.success) {
            allRecords = result.data;
            isSearching = true;

            // é¡¯ç¤ºæœå°‹çµæœè³‡è¨Š
            document.getElementById("searchCount").textContent =
              allRecords.length.toLocaleString();
            document.getElementById("searchInfo").style.display = "block";

            displayPage(1);

            document.getElementById("loading").style.display = "none";
            document.getElementById("recordsTable").style.display = "table";
            document.getElementById("pagination").style.display = "flex";
          }
        } catch (error) {
          console.error("Error searching records:", error);
          document.getElementById("loading").textContent = "æœå°‹å¤±æ•—";
        }
      }

      function clearSearch() {
        // æ¸…é™¤æ‰€æœ‰æœå°‹æ¬„ä½
        document.getElementById("searchKeyword").value = "";
        document.getElementById("filterWorker").value = "";
        document.getElementById("filterStartDate").value = "";
        document.getElementById("filterEndDate").value = "";
        document.getElementById("filterTransport").value = "";

        // éš±è—æœå°‹çµæœè³‡è¨Š
        document.getElementById("searchInfo").style.display = "none";

        // é‡æ–°è¼‰å…¥æ‰€æœ‰è¨˜éŒ„
        isSearching = false;
        loadRecords();
      }

      // æ”¯æ´ Enter éµæœå°‹
      document
        .getElementById("searchKeyword")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            searchRecords();
          }
        });

      function exportExcel() {
        const params = getSearchParams();
        const url = `/carbon/api/export/excel?${params.toString()}`;
        window.location.href = url;
      }

      function exportCSV() {
        const params = getSearchParams();
        const url = `/carbon/api/export/csv?${params.toString()}`;
        window.location.href = url;
      }

      function getSearchParams() {
        const params = new URLSearchParams();

        const keyword = document.getElementById("searchKeyword").value.trim();
        const workerId = document.getElementById("filterWorker").value;
        const startDate = document.getElementById("filterStartDate").value;
        const endDate = document.getElementById("filterEndDate").value;
        const transportType = document
          .getElementById("filterTransport")
          .value.replace(/[ğŸï¸ğŸš—ğŸšŒ]\s*/, "");

        if (keyword) params.append("keyword", keyword);
        if (workerId) params.append("worker_id", workerId);
        if (startDate) params.append("start_date", startDate);
        if (endDate) params.append("end_date", endDate);
        if (transportType) params.append("transport_type", transportType);

        return params;
      }

      function displayPage(page) {
        currentPage = page;
        const startIndex = (page - 1) * recordsPerPage;
        const endIndex = Math.min(
          startIndex + recordsPerPage,
          allRecords.length
        );

        const tbody = document.getElementById("recordsBody");
        tbody.innerHTML = "";

        for (let i = startIndex; i < endIndex; i++) {
          const record = allRecords[i];
          const row = document.createElement("tr");
          const transportBadge = getTransportBadge(record.transport_type);

          row.innerHTML = `
                    <td>${record.visit_date}</td>
                    <td>${
                      record.social_worker_name
                    }<br><small style="color: #999;">${
            record.social_worker_id
          }</small></td>
                    <td>${record.elder_id}</td>
                    <td>${record.visit_type}</td>
                    <td>${transportBadge}</td>
                    <td>${record.distance.toFixed(1)}</td>
                    <td>${
                      record.carbon_emission
                        ? record.carbon_emission.toFixed(3)
                        : "-"
                    }</td>
                    <td>${record.notes || "-"}</td>
                    <td>
                      <button onclick="editRecord(${
                        record.id
                      })" style="background:#8BC34A;color:white;border:none;padding:4px 8px;border-radius:3px;cursor:pointer;margin-right:4px;">âœï¸</button>
                      <button onclick="deleteRecord(${
                        record.id
                      })" style="background:#F44336;color:white;border:none;padding:4px 8px;border-radius:3px;cursor:pointer;">ğŸ—‘ï¸</button>
                    </td>
                `;
          tbody.appendChild(row);
        }

        // æ›´æ–°åˆ†é è³‡è¨Š
        document.getElementById("startRecord").textContent = (
          startIndex + 1
        ).toLocaleString();
        document.getElementById("endRecord").textContent =
          endIndex.toLocaleString();

        updatePaginationControls();
      }

      function updatePaginationControls() {
        const totalPages = Math.ceil(allRecords.length / recordsPerPage);

        // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
        document.getElementById("firstBtn").disabled = currentPage === 1;
        document.getElementById("prevBtn").disabled = currentPage === 1;
        document.getElementById("nextBtn").disabled =
          currentPage === totalPages;
        document.getElementById("lastBtn").disabled =
          currentPage === totalPages;

        // ç”Ÿæˆé ç¢¼æŒ‰éˆ•
        const pageNumbers = document.getElementById("pageNumbers");
        pageNumbers.innerHTML = "";

        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, currentPage + 2);

        for (let i = startPage; i <= endPage; i++) {
          const btn = document.createElement("button");
          btn.className = "page-btn" + (i === currentPage ? " active" : "");
          btn.textContent = i;
          btn.onclick = () => goToPage(i);
          pageNumbers.appendChild(btn);
        }
      }

      function goToPage(page) {
        displayPage(page);
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      function previousPage() {
        if (currentPage > 1) {
          goToPage(currentPage - 1);
        }
      }

      function nextPage() {
        const totalPages = Math.ceil(allRecords.length / recordsPerPage);
        if (currentPage < totalPages) {
          goToPage(currentPage + 1);
        }
      }

      function goToLastPage() {
        const totalPages = Math.ceil(allRecords.length / recordsPerPage);
        goToPage(totalPages);
      }

      function getTransportBadge(type) {
        const badges = {
          æ©Ÿè»Š: '<span class="badge badge-motorcycle">ğŸï¸ æ©Ÿè»Š</span>',
          æ±½è»Š: '<span class="badge badge-car">ğŸš— æ±½è»Š</span>',
          å¤§çœ¾é‹è¼¸: '<span class="badge badge-transit">ğŸšŒ å¤§çœ¾é‹è¼¸</span>',
        };
        return badges[type] || type;
      }

      function editRecord(id) {
        window.location.href = `/carbon/edit-visit?id=${id}`;
      }

      async function deleteRecord(id) {
        if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜éŒ„å—ï¼Ÿ\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼")) {
          return;
        }

        try {
          const response = await fetch(`/carbon/api/visit-records/${id}`, {
            method: "DELETE",
          });

          const result = await response.json();

          if (result.success) {
            alert("âœ“ è¨˜éŒ„å·²åˆªé™¤");
            loadRecords(); // é‡æ–°è¼‰å…¥åˆ—è¡¨
          } else {
            alert("âœ— åˆªé™¤å¤±æ•—ï¼š" + result.error);
          }
        } catch (error) {
          alert("âœ— ç™¼ç”ŸéŒ¯èª¤ï¼š" + error.message);
        }
      }

      loadRecords();
    </script>

    <!-- PWA Service Worker Registration -->
    <script src="/static/pwa-register.js"></script>
  </body>
</html>
