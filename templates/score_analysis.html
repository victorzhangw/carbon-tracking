<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å°è©±è©•åˆ†åˆ†æ</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/score_report.css') }}"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
          "Microsoft JhengHei", sans-serif;
        background: #e8e8e8;
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      .header {
        background: white;
        padding: 30px;
        border-radius: 12px;
        margin-bottom: 30px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      }

      .header h1 {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 12px;
        color: #1a1a1a;
      }

      .header p {
        font-size: 16px;
        color: #6c757d;
        line-height: 1.6;
      }

      .back-link {
        display: inline-block;
        margin-bottom: 20px;
        color: #0d6efd;
        text-decoration: none;
        font-size: 14px;
      }

      .back-link:hover {
        text-decoration: underline;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: white;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      }

      .stat-card-icon {
        font-size: 32px;
        margin-bottom: 12px;
      }

      .stat-card-label {
        font-size: 14px;
        color: #6c757d;
        margin-bottom: 8px;
      }

      .stat-card-value {
        font-size: 36px;
        font-weight: bold;
        color: #333;
      }

      .history-section {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        margin-bottom: 30px;
      }

      .history-section h2 {
        font-size: 24px;
        margin-bottom: 20px;
        color: #333;
      }

      .history-table {
        width: 100%;
        border-collapse: collapse;
      }

      .history-table th {
        background: #f8f9fa;
        padding: 12px;
        text-align: left;
        font-size: 14px;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
      }

      .history-table td {
        padding: 12px;
        border-bottom: 1px solid #dee2e6;
        font-size: 14px;
        color: #333;
      }

      .history-table tr:hover {
        background: #f8f9fa;
      }

      .grade-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-weight: 600;
        font-size: 12px;
      }

      .grade-S {
        background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
        color: #8b6914;
      }

      .grade-A {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .grade-B {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
      }

      .grade-C {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        color: white;
      }

      .grade-D {
        background: #e0e0e0;
        color: #666;
      }

      .chart-section {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      }

      .chart-section h2 {
        font-size: 24px;
        margin-bottom: 20px;
        color: #333;
      }

      .chart-container {
        width: 100%;
        max-width: 800px;
        margin: 0 auto;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #6c757d;
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
      }

      .empty-state-icon {
        font-size: 64px;
        margin-bottom: 16px;
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .btn-primary {
        background: #0d6efd;
        color: white;
      }

      .btn-primary:hover {
        background: #0b5ed7;
        transform: translateY(-2px);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <a href="/voice-testing" class="back-link">â† è¿”å›èªéŸ³æ¸¬è©¦è¨“ç·´æ¨¡çµ„</a>

      <div class="header">
        <h1>ğŸ“Š å°è©±è©•åˆ†åˆ†æ</h1>
        <p>
          æŸ¥çœ‹æ‚¨çš„å°è©±è©•åˆ†æ­·å²ã€è¶¨å‹¢åˆ†æå’Œè©³ç´°çµ±è¨ˆè³‡è¨Šã€‚
          äº†è§£æ‚¨åœ¨æƒ…ç·’è¡¨é”ã€èªéŸ³å“è³ªã€æ–‡å­—å…§å®¹ç­‰æ–¹é¢çš„è¡¨ç¾ã€‚
        </p>
      </div>

      <!-- çµ±è¨ˆå¡ç‰‡ -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-card-icon">ğŸ“ˆ</div>
          <div class="stat-card-label">ç¸½å°è©±æ¬¡æ•¸</div>
          <div class="stat-card-value" id="totalSessions">--</div>
        </div>

        <div class="stat-card">
          <div class="stat-card-icon">â­</div>
          <div class="stat-card-label">å¹³å‡è©•åˆ†</div>
          <div class="stat-card-value" id="avgScore">--</div>
        </div>

        <div class="stat-card">
          <div class="stat-card-icon">ğŸ†</div>
          <div class="stat-card-label">æœ€ä½³è©•åˆ†</div>
          <div class="stat-card-value" id="bestScore">--</div>
        </div>

        <div class="stat-card">
          <div class="stat-card-icon">ğŸ“Š</div>
          <div class="stat-card-label">æœ€å·®è©•åˆ†</div>
          <div class="stat-card-value" id="worstScore">--</div>
        </div>
      </div>

      <!-- è©•åˆ†æ­·å² -->
      <div class="history-section">
        <h2>ğŸ“‹ è©•åˆ†æ­·å²è¨˜éŒ„</h2>
        <div id="historyContent">
          <div class="loading">è¼‰å…¥ä¸­...</div>
        </div>
      </div>

      <!-- è¶¨å‹¢åœ–è¡¨ -->
      <div class="chart-section">
        <h2>ğŸ“ˆ è©•åˆ†è¶¨å‹¢</h2>
        <div class="chart-container">
          <canvas id="trendChart"></canvas>
        </div>
      </div>
    </div>

    <script>
      // è¼‰å…¥è©•åˆ†æ­·å²
      async function loadScoreHistory() {
        try {
          const response = await fetch(
            "/api/score-history?user_id=default&limit=20"
          );
          const result = await response.json();

          if (result.status === "success") {
            // æ›´æ–°çµ±è¨ˆå¡ç‰‡
            document.getElementById("totalSessions").textContent =
              result.statistics.total_sessions || 0;
            document.getElementById("avgScore").textContent = (
              result.statistics.average_score || 0
            ).toFixed(1);
            document.getElementById("bestScore").textContent = (
              result.statistics.best_score || 0
            ).toFixed(1);
            document.getElementById("worstScore").textContent = (
              result.statistics.worst_score || 0
            ).toFixed(1);

            // æ¸²æŸ“æ­·å²è¨˜éŒ„è¡¨æ ¼
            renderHistoryTable(result.records);

            // ç¹ªè£½è¶¨å‹¢åœ–
            drawTrendChart(result.records);
          } else {
            showError("è¼‰å…¥å¤±æ•—");
          }
        } catch (error) {
          console.error("è¼‰å…¥è©•åˆ†æ­·å²å¤±æ•—:", error);
          showError("è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
        }
      }

      // æ¸²æŸ“æ­·å²è¨˜éŒ„è¡¨æ ¼
      function renderHistoryTable(records) {
        const container = document.getElementById("historyContent");

        if (!records || records.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ“­</div>
              <p>é‚„æ²’æœ‰è©•åˆ†è¨˜éŒ„</p>
              <p style="font-size: 14px; margin-top: 8px;">
                å‰å¾€ <a href="/emotion-analysis">æƒ…ç·’è­˜åˆ¥ç³»çµ±</a> é–‹å§‹å°è©±
              </p>
            </div>
          `;
          return;
        }

        let tableHTML = `
          <table class="history-table">
            <thead>
              <tr>
                <th>æ—¥æœŸæ™‚é–“</th>
                <th>ç­‰ç´š</th>
                <th>ç¶œåˆè©•åˆ†</th>
                <th>æƒ…ç·’</th>
                <th>èªéŸ³</th>
                <th>æ–‡å­—</th>
                <th>å°è©±è¼ªæ•¸</th>
                <th>æŒçºŒæ™‚é–“</th>
              </tr>
            </thead>
            <tbody>
        `;

        records.forEach((record) => {
          const date = new Date(record.created_at);
          const dateStr = date.toLocaleString("zh-TW", {
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
          });

          const duration = formatDuration(record.duration);

          tableHTML += `
            <tr>
              <td>${dateStr}</td>
              <td>
                <span class="grade-badge grade-${record.grade}">
                  ${record.grade} - ${record.title}
                </span>
              </td>
              <td><strong>${record.overall_score.toFixed(1)}</strong></td>
              <td>${record.emotion_score.toFixed(1)}</td>
              <td>${record.voice_score.toFixed(1)}</td>
              <td>${record.content_score.toFixed(1)}</td>
              <td>${record.conversation_count}</td>
              <td>${duration}</td>
            </tr>
          `;
        });

        tableHTML += `
            </tbody>
          </table>
        `;

        container.innerHTML = tableHTML;
      }

      // ç¹ªè£½è¶¨å‹¢åœ–
      function drawTrendChart(records) {
        const canvas = document.getElementById("trendChart");
        if (!canvas || !records || records.length === 0) return;

        const ctx = canvas.getContext("2d");
        canvas.width = 800;
        canvas.height = 400;

        const padding = 60;
        const chartWidth = canvas.width - padding * 2;
        const chartHeight = canvas.height - padding * 2;

        // æ¸…ç©ºç•«å¸ƒ
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // åè½‰è¨˜éŒ„é †åºï¼ˆå¾èˆŠåˆ°æ–°ï¼‰
        const sortedRecords = [...records].reverse();

        // æº–å‚™æ•¸æ“š
        const maxScore = 100;
        const dataPoints = sortedRecords.map((record, index) => ({
          x: padding + (chartWidth / (sortedRecords.length - 1 || 1)) * index,
          overall:
            padding +
            chartHeight -
            (record.overall_score / maxScore) * chartHeight,
          emotion:
            padding +
            chartHeight -
            (record.emotion_score / maxScore) * chartHeight,
          voice:
            padding +
            chartHeight -
            (record.voice_score / maxScore) * chartHeight,
          content:
            padding +
            chartHeight -
            (record.content_score / maxScore) * chartHeight,
        }));

        // ç¹ªè£½ç¶²æ ¼ç·š
        ctx.strokeStyle = "#e0e0e0";
        ctx.lineWidth = 1;
        for (let i = 0; i <= 5; i++) {
          const y = padding + (chartHeight / 5) * i;
          ctx.beginPath();
          ctx.moveTo(padding, y);
          ctx.lineTo(padding + chartWidth, y);
          ctx.stroke();

          // Y è»¸æ¨™ç±¤
          ctx.fillStyle = "#666";
          ctx.font = "12px Arial";
          ctx.textAlign = "right";
          ctx.fillText((100 - i * 20).toString(), padding - 10, y + 4);
        }

        // ç¹ªè£½ç·šæ¢
        const lines = [
          { key: "overall", color: "#667eea", label: "ç¶œåˆè©•åˆ†" },
          { key: "emotion", color: "#f39c12", label: "æƒ…ç·’è¡¨é”" },
          { key: "voice", color: "#e74c3c", label: "èªéŸ³å“è³ª" },
          { key: "content", color: "#3498db", label: "æ–‡å­—å…§å®¹" },
        ];

        lines.forEach((line) => {
          ctx.strokeStyle = line.color;
          ctx.lineWidth = 2;
          ctx.beginPath();

          dataPoints.forEach((point, index) => {
            if (index === 0) {
              ctx.moveTo(point.x, point[line.key]);
            } else {
              ctx.lineTo(point.x, point[line.key]);
            }
          });

          ctx.stroke();

          // ç¹ªè£½æ•¸æ“šé»
          dataPoints.forEach((point) => {
            ctx.beginPath();
            ctx.arc(point.x, point[line.key], 4, 0, Math.PI * 2);
            ctx.fillStyle = line.color;
            ctx.fill();
          });
        });

        // ç¹ªè£½ X è»¸
        ctx.strokeStyle = "#333";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(padding, padding + chartHeight);
        ctx.lineTo(padding + chartWidth, padding + chartHeight);
        ctx.stroke();

        // ç¹ªè£½ Y è»¸
        ctx.beginPath();
        ctx.moveTo(padding, padding);
        ctx.lineTo(padding, padding + chartHeight);
        ctx.stroke();

        // ç¹ªè£½åœ–ä¾‹
        const legendX = padding + 20;
        const legendY = padding + 20;
        lines.forEach((line, index) => {
          const y = legendY + index * 25;

          // ç·šæ¢
          ctx.strokeStyle = line.color;
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.moveTo(legendX, y);
          ctx.lineTo(legendX + 30, y);
          ctx.stroke();

          // æ–‡å­—
          ctx.fillStyle = "#333";
          ctx.font = "14px Arial";
          ctx.textAlign = "left";
          ctx.fillText(line.label, legendX + 40, y + 4);
        });

        // X è»¸æ¨™ç±¤
        ctx.fillStyle = "#666";
        ctx.font = "12px Arial";
        ctx.textAlign = "center";
        ctx.fillText("å°è©±æ¬¡æ•¸", canvas.width / 2, canvas.height - 20);

        // Y è»¸æ¨™ç±¤
        ctx.save();
        ctx.translate(20, canvas.height / 2);
        ctx.rotate(-Math.PI / 2);
        ctx.textAlign = "center";
        ctx.fillText("è©•åˆ†", 0, 0);
        ctx.restore();
      }

      // æ ¼å¼åŒ–æŒçºŒæ™‚é–“
      function formatDuration(seconds) {
        const minutes = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${minutes}åˆ†${secs}ç§’`;
      }

      // é¡¯ç¤ºéŒ¯èª¤
      function showError(message) {
        document.getElementById("historyContent").innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">âŒ</div>
            <p>${message}</p>
          </div>
        `;
      }

      // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
      window.addEventListener("DOMContentLoaded", () => {
        loadScoreHistory();
      });
    </script>
  </body>
</html>
