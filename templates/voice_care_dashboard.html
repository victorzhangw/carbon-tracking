<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>定期關懷統計儀表板</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
          "Microsoft JhengHei", sans-serif;
        background: #f8f9fa;
        color: #212529;
        line-height: 1.5;
      }

      /* 導航欄 */
      .navbar {
        background: white;
        border-bottom: 1px solid #dee2e6;
        padding: 0 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        height: 60px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      .nav-brand {
        font-size: 18px;
        font-weight: 600;
        color: #212529;
      }

      .nav-links {
        display: flex;
        gap: 8px;
      }

      .nav-link {
        padding: 8px 16px;
        color: #6c757d;
        text-decoration: none;
        border-radius: 4px;
        font-size: 14px;
        transition: all 0.2s;
      }

      .nav-link:hover {
        background: #f8f9fa;
        color: #212529;
      }

      .nav-link.active {
        background: #e7f1ff;
        color: #0d6efd;
        font-weight: 500;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      /* 頂部工具欄 */
      .toolbar {
        background: white;
        padding: 16px 20px;
        border-radius: 4px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      }

      .toolbar h1 {
        font-size: 20px;
        font-weight: 600;
      }

      .toolbar-actions {
        display: flex;
        gap: 10px;
      }

      .btn {
        padding: 8px 16px;
        border: 1px solid #dee2e6;
        background: white;
        color: #495057;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
      }

      .btn:hover {
        background: #f8f9fa;
      }

      /* 統計卡片網格 */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }

      .stat-card {
        background: white;
        padding: 20px;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      }

      .stat-label {
        font-size: 13px;
        color: #6c757d;
        margin-bottom: 8px;
      }

      .stat-value {
        font-size: 32px;
        font-weight: 600;
        color: #212529;
        margin-bottom: 4px;
      }

      .stat-change {
        font-size: 13px;
        color: #28a745;
      }

      .stat-change.negative {
        color: #dc3545;
      }

      /* 圖表容器 */
      .chart-container {
        background: white;
        padding: 20px;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        margin-bottom: 20px;
      }

      .chart-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 16px;
        color: #212529;
      }

      /* 表格樣式 */
      table {
        width: 100%;
        border-collapse: collapse;
      }

      thead {
        background: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
      }

      th {
        padding: 12px 16px;
        text-align: left;
        font-size: 13px;
        font-weight: 600;
        color: #495057;
      }

      td {
        padding: 12px 16px;
        font-size: 14px;
        border-bottom: 1px solid #f1f3f5;
      }

      tbody tr:hover {
        background: #f8f9fa;
      }

      /* 進度條 */
      .progress-bar {
        width: 100%;
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: #0d6efd;
        transition: width 0.3s;
      }

      /* 兩欄布局 */
      .two-column {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      @media (max-width: 1024px) {
        .two-column {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- 導航欄 -->
      <div class="navbar">
        <div class="nav-brand">智慧語音關懷系統</div>
        <div class="nav-links">
          <a href="/api/voice-care/schedules-page" class="nav-link">排程管理</a>
          <a href="/api/voice-care/dashboard" class="nav-link active"
            >效果統計</a
          >
          <a href="/portal" class="nav-link">返回首頁</a>
        </div>
      </div>

      <!-- 頂部工具欄 -->
      <div class="toolbar">
        <h1>定期關懷效果統計分析</h1>
        <div class="toolbar-actions">
          <button class="btn" onclick="refreshData()">重新整理</button>
        </div>
      </div>

      <!-- 統計卡片 -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">總關懷次數</div>
          <div class="stat-value" id="totalCalls">0</div>
          <div class="stat-change">較上月 +0%</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">接聽率</div>
          <div class="stat-value" id="answerRate">0%</div>
          <div class="stat-change">較上月 +0%</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">平均滿意度</div>
          <div class="stat-value" id="satisfaction">0.0</div>
          <div class="stat-change">較上月 +0.0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">待處理排程</div>
          <div class="stat-value" id="pendingSchedules">0</div>
          <div class="stat-change">需要處理</div>
        </div>
      </div>

      <!-- 兩欄布局 -->
      <div class="two-column">
        <!-- 語言分布 -->
        <div class="chart-container">
          <div class="chart-title">語言使用分布</div>
          <table>
            <thead>
              <tr>
                <th>語言</th>
                <th>次數</th>
                <th>佔比</th>
                <th>進度</th>
              </tr>
            </thead>
            <tbody id="languageStats">
              <tr>
                <td
                  colspan="4"
                  style="text-align: center; padding: 40px; color: #6c757d"
                >
                  載入中...
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- 最近關懷記錄 -->
        <div class="chart-container">
          <div class="chart-title">最近關懷記錄</div>
          <table>
            <thead>
              <tr>
                <th>用戶</th>
                <th>時間</th>
                <th>語言</th>
                <th>狀態</th>
              </tr>
            </thead>
            <tbody id="recentRecords">
              <tr>
                <td
                  colspan="4"
                  style="text-align: center; padding: 40px; color: #6c757d"
                >
                  載入中...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- 每日統計 -->
      <div class="chart-container">
        <div class="chart-title">每日關懷統計（最近7天）</div>
        <table>
          <thead>
            <tr>
              <th>日期</th>
              <th>總次數</th>
              <th>已完成</th>
              <th>失敗</th>
              <th>接聽率</th>
            </tr>
          </thead>
          <tbody id="dailyStats">
            <tr>
              <td
                colspan="5"
                style="text-align: center; padding: 40px; color: #6c757d"
              >
                載入中...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <script>
      // 初始化
      async function init() {
        await loadStatistics();
      }

      // 載入統計數據
      async function loadStatistics() {
        try {
          const response = await fetch("/api/voice-care/statistics");
          const data = await response.json();

          if (data.success) {
            renderStatistics(data);
          }
        } catch (error) {
          console.error("載入統計失敗:", error);
        }
      }

      // 渲染統計數據
      function renderStatistics(data) {
        // 更新統計卡片
        document.getElementById("totalCalls").textContent =
          data.total_calls || 0;
        document.getElementById("answerRate").textContent =
          ((data.answer_rate || 0) * 100).toFixed(1) + "%";
        document.getElementById("satisfaction").textContent = (
          data.satisfaction_score || 0
        ).toFixed(1);
        document.getElementById("pendingSchedules").textContent =
          data.pending_schedules || 0;

        // 語言分布
        renderLanguageStats(data.language_distribution || {});

        // 最近記錄
        renderRecentRecords(data.recent_records || []);

        // 每日統計
        renderDailyStats(data.daily_stats || []);
      }

      // 渲染語言統計
      function renderLanguageStats(distribution) {
        const tbody = document.getElementById("languageStats");
        const total = Object.values(distribution).reduce((a, b) => a + b, 0);

        if (total === 0) {
          tbody.innerHTML =
            '<tr><td colspan="4" style="text-align: center; padding: 40px; color: #6c757d;">暫無數據</td></tr>';
          return;
        }

        const langNames = {
          mandarin: "國語",
          minan: "閩南語",
          both: "雙語",
        };

        tbody.innerHTML = Object.entries(distribution)
          .map(([lang, count]) => {
            const percentage = ((count / total) * 100).toFixed(1);
            return `
                    <tr>
                        <td>${langNames[lang] || lang}</td>
                        <td>${count}</td>
                        <td>${percentage}%</td>
                        <td>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${percentage}%"></div>
                            </div>
                        </td>
                    </tr>
                `;
          })
          .join("");
      }

      // 渲染最近記錄
      function renderRecentRecords(records) {
        const tbody = document.getElementById("recentRecords");

        if (records.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="4" style="text-align: center; padding: 40px; color: #6c757d;">暫無數據</td></tr>';
          return;
        }

        tbody.innerHTML = records
          .slice(0, 5)
          .map(
            (record) => `
                <tr>
                    <td>${record.user_name || "-"}</td>
                    <td>${formatTime(record.sent_at)}</td>
                    <td>${getLanguageName(record.language)}</td>
                    <td>${getStatusBadge(record.status)}</td>
                </tr>
            `
          )
          .join("");
      }

      // 渲染每日統計
      function renderDailyStats(stats) {
        const tbody = document.getElementById("dailyStats");

        if (stats.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #6c757d;">暫無數據</td></tr>';
          return;
        }

        tbody.innerHTML = stats
          .map((stat) => {
            const answerRate =
              stat.total > 0
                ? ((stat.answered / stat.total) * 100).toFixed(1)
                : 0;
            return `
                    <tr>
                        <td>${formatDate(stat.date)}</td>
                        <td>${stat.total}</td>
                        <td>${stat.completed}</td>
                        <td>${stat.failed}</td>
                        <td>${answerRate}%</td>
                    </tr>
                `;
          })
          .join("");
      }

      // 工具函數
      function formatDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString("zh-TW", {
          month: "2-digit",
          day: "2-digit",
        });
      }

      function formatTime(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleString("zh-TW", {
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      function getLanguageName(lang) {
        const map = {
          mandarin: "國語",
          minan: "閩南語",
          both: "雙語",
        };
        return map[lang] || lang;
      }

      function getStatusBadge(status) {
        const map = {
          completed: '<span style="color: #28a745;">已完成</span>',
          failed: '<span style="color: #dc3545;">失敗</span>',
          pending: '<span style="color: #ffc107;">待處理</span>',
        };
        return map[status] || status;
      }

      function refreshData() {
        loadStatistics();
      }

      // 初始化
      init();
    </script>
  </body>
</html>
