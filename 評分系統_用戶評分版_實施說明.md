# 評分系統 - 用戶評分版實施說明

## 🎯 改進目標

將評分系統從**自動評分**改為**用戶手動評分**，並添加用戶登入功能。

### 主要改進

1. **重新設計評分 Modal**

   - 統計資訊移到頂部（對話輪數/總字數/持續時間）
   - 評分改為用戶手動輸入（Slider 1-100）
   - 改進建議改為用戶輸入文字框

2. **添加用戶登入功能**
   - 簡單的登入頁面
   - 用戶身份驗證
   - 記錄評分者資訊

## ✅ 已完成的實施

### 1. 新版評分 Modal

**文件**: `templates/score_report_modal_v2.html`

#### 結構調整

```
┌─────────────────────────────────────┐
│  📝 對話評分表                       │
├─────────────────────────────────────┤
│  📊 對話統計（頂部）                 │
│  ┌─────┬─────┬─────┐               │
│  │💬輪數│📝字數│⏱️時間│               │
│  └─────┴─────┴─────┘               │
├─────────────────────────────────────┤
│  ⭐ 請為本次對話評分                 │
│                                     │
│  😊 情緒表達: [====●====] 50        │
│  🎤 語音品質: [====●====] 50        │
│  📝 文字內容: [====●====] 50        │
│                                     │
│  綜合評分: 50 (C - 尚可)            │
├─────────────────────────────────────┤
│  💡 改進建議                         │
│  [文字輸入框]                        │
├─────────────────────────────────────┤
│  [取消]  [提交評分]                  │
└─────────────────────────────────────┘
```

#### 特色功能

1. **統計資訊卡片**（頂部）

   - 漸變背景
   - 圖標 + 數值顯示
   - 響應式網格布局

2. **評分滑桿**

   - 範圍 1-100
   - 彩色漸變軌道（紅 → 黃 → 綠 → 藍）
   - 即時顯示分數
   - 自動計算綜合評分

3. **改進建議輸入**

   - 多行文字框
   - 提示文字
   - 選填欄位

4. **綜合評分顯示**
   - 自動計算平均分
   - 動態等級（A+/A/B/C/D/F）
   - 漸變背景

### 2. 登入頁面

**文件**: `templates/login.html`

#### 功能特點

1. **標準登入表單**

   - 用戶名稱輸入
   - 密碼輸入
   - 登入按鈕

2. **快速登入**（測試用）

   - 管理員
   - 張小明
   - 李小華
   - 訪客

3. **UI 設計**
   - 漸變背景
   - 卡片式布局
   - 響應式設計
   - 錯誤提示

### 3. 前端整合

**文件**: `templates/emotion_analysis.html`

#### 新增功能

1. **登入檢查**

```javascript
function checkLoginStatus() {
  const currentUser = localStorage.getItem("currentUser");
  if (!currentUser) {
    window.location.href =
      "/login?return=" + encodeURIComponent(window.location.pathname);
    return false;
  }
  // 顯示用戶資訊
  return true;
}
```

2. **用戶資訊顯示**

   - 右上角顯示用戶名稱
   - 登出按鈕

3. **評分 Modal 觸發**

```javascript
endSessionBtn.addEventListener("click", () => {
  if (confirm("確定要結束對話嗎？將開啟評分表單。")) {
    showScoreModalForInput();
  }
});
```

4. **評分提交**

```javascript
async function submitScoreReport() {
  const scores = {
    emotion: parseInt(document.getElementById("emotionScoreSlider").value),
    voice: parseInt(document.getElementById("voiceScoreSlider").value),
    content: parseInt(document.getElementById("contentScoreSlider").value),
    overall: Math.round((emotion + voice + content) / 3)
  };

  const feedback = document.getElementById("feedbackText").value;

  // 提交到後端
  await fetch("/api/submit-user-score", {
    method: "POST",
    body: JSON.stringify({
      session_id, user_id, scores, feedback, ...
    })
  });
}
```

### 4. 後端 API

**文件**: `routes/main.py`

#### 新增路由

1. **登入頁面**

```python
@main.route('/login')
def login_page():
    return render_template('login.html')
```

2. **登入 API**

```python
@main.route('/api/login', methods=['POST'])
def api_login():
    # 驗證用戶名稱和密碼
    # 返回用戶資訊
```

3. **提交評分 API**

```python
@main.route('/api/submit-user-score', methods=['POST'])
def submit_user_score():
    # 接收用戶評分
    # 保存到資料庫
    # 返回成功訊息
```

## 📊 資料結構

### 用戶評分記錄

```json
{
  "session_id": "uuid",
  "user_id": "user_123",
  "user_name": "張小明",
  "scores": {
    "emotion": 85,
    "voice": 90,
    "content": 80,
    "overall": 85
  },
  "feedback": "AI 回應很自然，但有時候會重複...",
  "statistics": {
    "conversation_count": 10,
    "total_words": 500,
    "duration": 300
  },
  "grade": "A",
  "title": "良好",
  "stars": 4,
  "created_at": "2024-01-01T12:00:00"
}
```

## 🎨 UI 設計

### 配色方案

- **主色**: `#667eea` (紫藍色)
- **次色**: `#764ba2` (紫色)
- **成功**: `#28a745` (綠色)
- **警告**: `#ffc107` (黃色)
- **錯誤**: `#dc3545` (紅色)

### 評分滑桿漸變

```css
background: linear-gradient(
  to right,
  #ff6b6b 0%,
  /* 紅色 (低分) */ #ffd93d 25%,
  /* 黃色 */ #6bcf7f 50%,
  /* 綠色 (中等) */ #4ecdc4 75%,
  /* 青色 */ #667eea 100% /* 藍色 (高分) */
);
```

## 🔄 使用流程

### 完整流程

```
1. 訪問 /emotion-analysis
   ↓
2. 檢查登入狀態
   ↓ (未登入)
3. 跳轉到 /login
   ↓
4. 輸入用戶名稱/密碼 或 快速登入
   ↓
5. 登入成功，返回 /emotion-analysis
   ↓
6. 顯示用戶資訊（右上角）
   ↓
7. 開始對話（錄音、AI 回應）
   ↓
8. 點擊「結束對話」按鈕
   ↓
9. 顯示評分 Modal
   ↓
10. 查看統計資訊（頂部）
    ↓
11. 調整評分滑桿（1-100）
    ↓
12. 輸入改進建議（選填）
    ↓
13. 點擊「提交評分」
    ↓
14. 保存到資料庫
    ↓
15. 顯示成功訊息
    ↓
16. 關閉 Modal，重置對話
```

## 🧪 測試步驟

### 1. 測試登入功能

```bash
# 啟動應用
python app.py

# 訪問登入頁面
http://localhost:5000/login

# 測試快速登入
點擊「管理員」或其他快速登入按鈕

# 驗證
- 應該跳轉到 /emotion-analysis
- 右上角顯示用戶名稱
- localStorage 中有 currentUser
```

### 2. 測試評分功能

```bash
# 1. 登入後訪問 emotion-analysis
# 2. 進行至少一輪對話
# 3. 點擊「結束對話」按鈕
# 4. 驗證 Modal 顯示:
   - 統計資訊正確（輪數/字數/時間）
   - 滑桿可以拖動
   - 分數即時更新
   - 綜合評分自動計算
# 5. 調整評分並提交
# 6. 驗證:
   - 顯示成功訊息
   - Modal 關閉
   - 對話重置
```

### 3. 測試資料保存

```python
# 查詢資料庫
import sqlite3
conn = sqlite3.connect('data/databases/emotion_analysis.db')
cursor = conn.cursor()

# 查看評分記錄
cursor.execute("SELECT * FROM score_records ORDER BY created_at DESC LIMIT 5")
records = cursor.fetchall()
print(records)
```

## 📝 資料庫結構

### score_records 表（需要更新）

```sql
CREATE TABLE IF NOT EXISTS score_records (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    session_id TEXT UNIQUE NOT NULL,
    user_id TEXT NOT NULL,
    user_name TEXT,
    emotion_score REAL NOT NULL,
    voice_score REAL NOT NULL,
    content_score REAL NOT NULL,
    overall_score REAL NOT NULL,
    grade TEXT,
    title TEXT,
    stars INTEGER,
    feedback TEXT,  -- 新增：用戶反饋
    conversation_count INTEGER,
    total_words INTEGER,
    duration INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 🚀 部署步驟

### 1. 更新文件

```bash
# 確認以下文件已更新:
- templates/score_report_modal_v2.html  (新)
- templates/login.html                  (新)
- templates/emotion_analysis.html       (修改)
- routes/main.py                        (修改)
```

### 2. 更新資料庫

```python
# 運行資料庫遷移（如果需要）
python -c "from services.score_database import score_db; score_db._init_database()"
```

### 3. 重啟應用

```bash
# 停止現有應用
# 重新啟動
python app.py
```

### 4. 測試

```bash
# 訪問登入頁面
http://localhost:5000/login

# 快速登入測試
# 進行對話測試
# 提交評分測試
```

## 💡 使用建議

### 1. 評分標準

建議為用戶提供評分參考：

- **90-100 分**: 非常滿意，超出預期
- **80-89 分**: 滿意，符合預期
- **70-79 分**: 尚可，有改進空間
- **60-69 分**: 不太滿意，需要改進
- **60 分以下**: 不滿意，需要大幅改進

### 2. 改進建議範例

提供一些範例幫助用戶填寫：

- "AI 的回應速度可以更快一些"
- "希望能支援更多語言"
- "語音識別在嘈雜環境下不夠準確"
- "TTS 語音可以更自然一些"
- "希望能記住更長的對話歷史"

### 3. 用戶管理

建議添加：

- 用戶註冊功能
- 密碼重置功能
- 用戶資料編輯
- 評分歷史查看

## 🎉 總結

### 實施完成 ✅

1. ✅ 重新設計評分 Modal（統計在頂部）
2. ✅ 評分改為用戶手動輸入（Slider）
3. ✅ 改進建議改為文字輸入
4. ✅ 添加登入頁面
5. ✅ 添加登入檢查
6. ✅ 添加用戶資訊顯示
7. ✅ 添加評分提交 API
8. ✅ 整合前後端功能

### 效果

- 用戶可以根據實際體驗評分
- 評分更加主觀和真實
- 可以收集用戶反饋
- 知道是誰在使用系統

### 下一步

可以考慮：

1. 添加用戶註冊功能
2. 實現評分歷史查看
3. 添加評分統計分析
4. 實現用戶資料管理
5. 添加評分趨勢圖表

現在評分系統已經是一個完整的用戶評分系統了！🎊
