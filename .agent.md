# AI Customer Service Voice Clone System - Developer Guide

## Project Overview

This is a comprehensive AI-powered customer service system with voice cloning capabilities, built using Flask and integrating multiple AI services for speech recognition, natural language processing, and text-to-speech synthesis.

### Core Technologies

- **Backend**: Python Flask with modular blueprint architecture
- **AI Services**: DeepSeek AI for conversation analysis, GPT-SoVITS v4 for voice cloning
- **Speech Processing**: SpeechRecognition, GPT-SoVITS v4 (replaced F5-TTS)
- **Database**: SQLite with comprehensive user/staff management and voice model storage
- **Frontend**: Vue.js application for web interface + HTML demo pages
- **Authentication**: JWT-based authentication with role-based access control

### Key Features

- Real-time speech-to-text transcription
- AI-powered sentiment analysis and response generation
- Voice cloning and synthesis using GPT-SoVITS
- Staff management with audio file organization
- Multi-language support (Chinese, English, Japanese, Korean, Cantonese)
- Docker containerization support

## Project Structure

### Core Application Files

- `app.py` - Main Flask application entry point with blueprint registration
- `config.py` - Configuration settings including API keys and directory paths
- `database.py` - SQLite database operations and schema management
- `auth.py` - JWT authentication and authorization decorators
- `utils.py` - Utility functions for file handling and JSON processing

### Modular Architecture

#### Routes (`routes/`)

- `main.py` - Core API endpoints for audio processing and legacy TTS
- `staff.py` - Staff management CRUD operations
- `audio.py` - Audio file management and metadata
- `auth.py` - Authentication endpoints (login, registration)
- `voice_clone.py` - Complete voice cloning workflow endpoints

#### Services (`services/`)

- `ai.py` - DeepSeek AI integration for conversation analysis
- `speech.py` - Speech recognition and transcription
- `tts.py` - Legacy text-to-speech synthesis (deprecated)
- `gpt_sovits_service.py` - Complete GPT-SoVITS voice cloning service

#### Voice Cloning System

- `voice_clone_service.py` - Advanced voice cloning service with quality assessment
- `simple_voice_api.py` - Simplified voice API for basic operations
- `voice_config.py` - Voice system configuration and language support
- `GPT-SoVITS-v4-20250422fix/` - Complete GPT-SoVITS implementation

### Frontend

- `webpage/ai-customer-service-frontend/` - Vue.js application
- `templates/` - Flask HTML templates for basic interface

## Voice Cloning Workflow

### Complete GPT-SoVITS Integration

The system now implements a complete voice cloning workflow using GPT-SoVITS v4:

1. **Reading Text Generation** (`/voice_clone/generate_reading_text`)

   - Generates ~60 seconds of reading material
   - Optimized for voice model training
   - Includes pronunciation guidelines

2. **Voice Sample Processing** (`/voice_clone/upload_voice_sample`)

   - Accepts WAV format audio files
   - Performs automatic audio slicing and noise reduction
   - Extracts text features, SSL features, and semantic tokens
   - Sets up TTS inference environment

3. **Voice Model Management**

   - Database storage for voice models and generation history
   - Quality assessment and status tracking
   - Staff-specific voice model organization

4. **AI-Powered Voice Response** (`/voice_clone/generate_response_voice`)
   - Integrates DeepSeek AI analysis with voice synthesis
   - Generates natural responses using cloned voice
   - Supports sentiment-aware voice generation

### API Endpoints

- `GET /voice_clone/demo` - Interactive demo interface
- `GET /voice_clone/generate_reading_text` - Generate training text
- `POST /voice_clone/upload_voice_sample` - Process voice samples
- `POST /voice_clone/generate_response_voice` - AI + voice synthesis
- `POST /voice_clone/test_voice_generation` - Test voice quality
- `GET /voice_clone/voice_models` - List all voice models

## Development Guidelines

### Code Organization

- Follow Flask blueprint pattern for route organization
- Use service layer pattern for business logic separation
- Implement proper error handling with try-catch blocks
- Use decorators for authentication and authorization

### Database Conventions

- SQLite database with proper foreign key relationships
- Use parameterized queries to prevent SQL injection
- Implement proper transaction handling for data consistency

### API Design Patterns

- RESTful API endpoints with consistent naming
- JSON request/response format
- Proper HTTP status codes for different scenarios
- Include error messages in Chinese for user-facing responses

### File Management

- Organize audio files by staff codes in separate directories
- Use secure filename generation with UUIDs
- Implement file type validation for security
- Support multiple audio formats (.wav, .mp3, .ogg, .flac, .m4a)

### Voice Processing Best Practices

- Validate audio duration (1-300 seconds)
- Implement quality assessment for voice samples
- Use appropriate sample rates and formats
- Handle multiple language support properly

## Configuration Management

### Environment Variables

- Store sensitive API keys in `config.py` (should be moved to environment variables in production)
- Configure service URLs and ports centrally
- Maintain separate configurations for development and production

### Directory Structure

```
audio_uploads/          # Uploaded audio files organized by staff code
mockvoice/             # Reference voice samples
genvoice/              # Generated voice outputs
static/audio/          # Static audio assets
temp/                  # Temporary processing files
```

## API Integration

### DeepSeek AI Configuration

- Model: `Pro/deepseek-ai/DeepSeek-V3`
- Base URL: `https://api.siliconflow.cn`
- Specialized for social work counseling with elderly care knowledge
- Response format: JSON with sentiment analysis and professional advice

### GPT-SoVITS Integration

- Local service on port 9880
- Supports multiple languages and voice styles
- Quality assessment and voice matching capabilities
- Batch processing support for multiple audio files

## Security Considerations

### Authentication & Authorization

- JWT tokens with configurable expiration (8 hours access, 30 days refresh)
- Role-based access control with permission decorators
- Secure password hashing using bcrypt
- Input validation and sanitization

### File Security

- Secure filename generation to prevent path traversal
- File type validation based on extensions
- Size limits for uploaded files (50MB max)
- Directory traversal protection in file serving endpoints

## Testing & Development

### Local Development Setup

1. Install Python dependencies: `pip install -r requirements.txt`
2. Initialize database: Run `database.py` to create tables
3. Start GPT-SoVITS service: Use provided batch files
4. Configure API keys in `config.py`
5. Run Flask application: `python app.py`

### Voice System Setup

- Follow `VOICE_CLONE_SETUP.md` for detailed installation
- Ensure GPT-SoVITS models are properly downloaded
- Configure audio processing parameters in `voice_config.py`

### Frontend Development

- Vue.js application in `webpage/ai-customer-service-frontend/`
- Use `npm install` and `npm run serve` for development
- API integration configured for local Flask backend

## Deployment Considerations

### Production Checklist

- [ ] Change JWT secret key from default value
- [ ] Move API keys to environment variables
- [ ] Configure proper CORS settings
- [ ] Set up proper logging and monitoring
- [ ] Implement rate limiting for API endpoints
- [ ] Configure reverse proxy (nginx configuration provided)
- [ ] Set up SSL/TLS certificates

### Docker Support

- `config/deployment/Dockerfile.voice-api` for voice service containerization
- `docker-compose-gpt-sovits.yml` for complete stack deployment
- `config/deployment/nginx-voice.conf` for reverse proxy configuration

## Troubleshooting

### Common Issues

- **Audio Processing Errors**: Check file format and duration limits
- **Voice Cloning Failures**: Verify GPT-SoVITS service is running on port 9880
- **Database Errors**: Ensure proper table initialization and foreign key constraints
- **Authentication Issues**: Verify JWT token format and expiration

### Debugging Tools

- Enable Flask debug mode for development
- Use provided test scripts: `test-voice-api.py`, `test-voice-clone.py`
- Check service logs for API integration issues
- Validate audio file quality using provided assessment tools

## Performance Optimization

### Audio Processing

- Implement async processing for large audio files
- Use appropriate compression for generated audio
- Cache frequently used voice models
- Optimize file I/O operations

### Database Optimization

- Use proper indexing for frequently queried fields
- Implement connection pooling for high-traffic scenarios
- Consider pagination for large result sets
- Regular database maintenance and cleanup

## Maintenance Tasks

### Regular Maintenance

- Clean up temporary audio files
- Monitor disk space usage in audio directories
- Update AI model weights periodically
- Review and rotate API keys
- Backup database and critical audio samples

### Monitoring

- Track API response times and error rates
- Monitor voice synthesis quality metrics
- Log user interaction patterns for improvement
- Track resource usage (CPU, memory, disk)
