<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PWA åŠŸèƒ½æ¸¬è©¦</title>
    <style>
      body {
        font-family: "Microsoft JhengHei", Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background: #f1f8e9;
      }
      h1 {
        color: #689f38;
      }
      .test-section {
        background: white;
        padding: 20px;
        margin: 15px 0;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .test-item {
        padding: 10px;
        margin: 10px 0;
        border-left: 4px solid #8bc34a;
        background: #f9fbe7;
      }
      .status {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 4px;
        font-weight: bold;
        margin-left: 10px;
      }
      .status.success {
        background: #c5e1a5;
        color: #33691e;
      }
      .status.error {
        background: #ffcdd2;
        color: #b71c1c;
      }
      .status.pending {
        background: #ffe082;
        color: #f57f17;
      }
      button {
        background: #8bc34a;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #7cb342;
      }
      pre {
        background: #263238;
        color: #aedd94;
        padding: 15px;
        border-radius: 4px;
        overflow-x: auto;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ§ª PWA åŠŸèƒ½æ¸¬è©¦</h1>

    <div class="test-section">
      <h2>1. Service Worker ç‹€æ…‹</h2>
      <div class="test-item">
        <strong>è¨»å†Šç‹€æ…‹ï¼š</strong>
        <span id="sw-status" class="status pending">æª¢æŸ¥ä¸­...</span>
      </div>
      <div class="test-item">
        <strong>Service Worker ç‹€æ…‹ï¼š</strong>
        <span id="sw-state" class="status pending">æª¢æŸ¥ä¸­...</span>
      </div>
      <button onclick="checkServiceWorker()">é‡æ–°æª¢æŸ¥</button>
      <button onclick="unregisterServiceWorker()">å–æ¶ˆè¨»å†Š</button>
    </div>

    <div class="test-section">
      <h2>2. Manifest æª¢æŸ¥</h2>
      <div class="test-item">
        <strong>Manifest è¼‰å…¥ï¼š</strong>
        <span id="manifest-status" class="status pending">æª¢æŸ¥ä¸­...</span>
      </div>
      <div id="manifest-details"></div>
      <button onclick="checkManifest()">æª¢æŸ¥ Manifest</button>
    </div>

    <div class="test-section">
      <h2>3. å¿«å–ç‹€æ…‹</h2>
      <div class="test-item">
        <strong>å¿«å–æ•¸é‡ï¼š</strong>
        <span id="cache-count">-</span>
      </div>
      <div id="cache-details"></div>
      <button onclick="checkCaches()">æª¢æŸ¥å¿«å–</button>
      <button onclick="clearAllCaches()">æ¸…é™¤æ‰€æœ‰å¿«å–</button>
    </div>

    <div class="test-section">
      <h2>4. å®‰è£ç‹€æ…‹</h2>
      <div class="test-item">
        <strong>é‹è¡Œæ¨¡å¼ï¼š</strong>
        <span id="display-mode">-</span>
      </div>
      <div class="test-item">
        <strong>å¯å®‰è£ï¼š</strong>
        <span id="installable">-</span>
      </div>
      <button onclick="installPWA()" id="install-btn" style="display: none">
        å®‰è£ PWA
      </button>
    </div>

    <div class="test-section">
      <h2>5. ç¶²è·¯ç‹€æ…‹</h2>
      <div class="test-item">
        <strong>é€£ç·šç‹€æ…‹ï¼š</strong>
        <span id="online-status">-</span>
      </div>
      <button onclick="testOffline()">æ¸¬è©¦é›¢ç·šåŠŸèƒ½</button>
    </div>

    <div class="test-section">
      <h2>6. æ¸¬è©¦çµæœ</h2>
      <pre id="test-results">ç­‰å¾…æ¸¬è©¦...</pre>
    </div>

    <script>
      let deferredPrompt;
      let testResults = [];

      // åˆå§‹åŒ–æ¸¬è©¦
      window.addEventListener("load", () => {
        runAllTests();
      });

      async function runAllTests() {
        testResults = [];
        log("ğŸš€ é–‹å§‹ PWA åŠŸèƒ½æ¸¬è©¦...\n");

        await checkServiceWorker();
        await checkManifest();
        await checkCaches();
        checkDisplayMode();
        checkOnlineStatus();

        log("\nâœ… æ¸¬è©¦å®Œæˆï¼");
      }

      async function checkServiceWorker() {
        log("æª¢æŸ¥ Service Worker...");

        if ("serviceWorker" in navigator) {
          try {
            const registration = await navigator.serviceWorker.getRegistration(
              "/carbon/"
            );

            if (registration) {
              document.getElementById("sw-status").textContent = "å·²è¨»å†Š";
              document.getElementById("sw-status").className = "status success";

              const state = registration.active
                ? registration.active.state
                : "æœªå•Ÿå‹•";
              document.getElementById("sw-state").textContent = state;
              document.getElementById("sw-state").className =
                state === "activated" ? "status success" : "status error";

              log(`âœ“ Service Worker å·²è¨»å†Šï¼Œç‹€æ…‹ï¼š${state}`);
            } else {
              document.getElementById("sw-status").textContent = "æœªè¨»å†Š";
              document.getElementById("sw-status").className = "status error";
              log("âœ— Service Worker æœªè¨»å†Š");
            }
          } catch (error) {
            log(`âœ— æª¢æŸ¥å¤±æ•—ï¼š${error.message}`);
          }
        } else {
          log("âœ— ç€è¦½å™¨ä¸æ”¯æ´ Service Worker");
        }
      }

      async function checkManifest() {
        log("æª¢æŸ¥ Manifest...");

        try {
          const response = await fetch("/static/manifest.json");
          const manifest = await response.json();

          document.getElementById("manifest-status").textContent = "å·²è¼‰å…¥";
          document.getElementById("manifest-status").className =
            "status success";

          const details = document.getElementById("manifest-details");
          details.innerHTML = `
                    <div class="test-item">
                        <strong>åç¨±ï¼š</strong>${manifest.name}<br>
                        <strong>ç°¡ç¨±ï¼š</strong>${manifest.short_name}<br>
                        <strong>ä¸»é¡Œè‰²ï¼š</strong><span style="background:${manifest.theme_color};padding:2px 10px;color:white;">${manifest.theme_color}</span><br>
                        <strong>åœ–ç¤ºæ•¸é‡ï¼š</strong>${manifest.icons.length}
                    </div>
                `;

          log(`âœ“ Manifest å·²è¼‰å…¥ï¼š${manifest.name}`);
        } catch (error) {
          document.getElementById("manifest-status").textContent = "è¼‰å…¥å¤±æ•—";
          document.getElementById("manifest-status").className = "status error";
          log(`âœ— Manifest è¼‰å…¥å¤±æ•—ï¼š${error.message}`);
        }
      }

      async function checkCaches() {
        log("æª¢æŸ¥å¿«å–...");

        if ("caches" in window) {
          try {
            const cacheNames = await caches.keys();
            document.getElementById("cache-count").textContent =
              cacheNames.length;

            const details = document.getElementById("cache-details");
            let html = "";

            for (const cacheName of cacheNames) {
              const cache = await caches.open(cacheName);
              const keys = await cache.keys();
              html += `
                            <div class="test-item">
                                <strong>${cacheName}</strong><br>
                                å¿«å–é …ç›®ï¼š${keys.length} å€‹
                            </div>
                        `;
            }

            details.innerHTML = html;
            log(`âœ“ æ‰¾åˆ° ${cacheNames.length} å€‹å¿«å–`);
          } catch (error) {
            log(`âœ— æª¢æŸ¥å¿«å–å¤±æ•—ï¼š${error.message}`);
          }
        } else {
          log("âœ— ç€è¦½å™¨ä¸æ”¯æ´ Cache API");
        }
      }

      function checkDisplayMode() {
        log("æª¢æŸ¥é¡¯ç¤ºæ¨¡å¼...");

        const isStandalone =
          window.matchMedia("(display-mode: standalone)").matches ||
          window.navigator.standalone === true;

        const mode = isStandalone ? "ç¨ç«‹æ¨¡å¼ï¼ˆå·²å®‰è£ï¼‰" : "ç€è¦½å™¨æ¨¡å¼";
        document.getElementById("display-mode").textContent = mode;
        log(`âœ“ é‹è¡Œæ¨¡å¼ï¼š${mode}`);
      }

      function checkOnlineStatus() {
        log("æª¢æŸ¥ç¶²è·¯ç‹€æ…‹...");

        const status = navigator.onLine ? "ç·šä¸Š" : "é›¢ç·š";
        document.getElementById("online-status").textContent = status;
        log(`âœ“ ç¶²è·¯ç‹€æ…‹ï¼š${status}`);
      }

      async function unregisterServiceWorker() {
        if ("serviceWorker" in navigator) {
          const registration = await navigator.serviceWorker.getRegistration(
            "/carbon/"
          );
          if (registration) {
            await registration.unregister();
            log("âœ“ Service Worker å·²å–æ¶ˆè¨»å†Š");
            alert("Service Worker å·²å–æ¶ˆè¨»å†Šï¼Œè«‹é‡æ–°æ•´ç†é é¢");
          }
        }
      }

      async function clearAllCaches() {
        if ("caches" in window) {
          const cacheNames = await caches.keys();
          await Promise.all(cacheNames.map((name) => caches.delete(name)));
          log("âœ“ æ‰€æœ‰å¿«å–å·²æ¸…é™¤");
          alert("æ‰€æœ‰å¿«å–å·²æ¸…é™¤");
          await checkCaches();
        }
      }

      async function testOffline() {
        log("æ¸¬è©¦é›¢ç·šåŠŸèƒ½...");
        alert(
          "è«‹é–‹å•Ÿé–‹ç™¼è€…å·¥å…· > Network > å‹¾é¸ Offlineï¼Œç„¶å¾Œé‡æ–°æ•´ç†é é¢æ¸¬è©¦é›¢ç·šåŠŸèƒ½"
        );
      }

      // å®‰è£æç¤º
      window.addEventListener("beforeinstallprompt", (e) => {
        e.preventDefault();
        deferredPrompt = e;
        document.getElementById("installable").textContent = "æ˜¯";
        document.getElementById("install-btn").style.display = "inline-block";
        log("âœ“ PWA å¯ä»¥å®‰è£");
      });

      async function installPWA() {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice;
          log(`å®‰è£çµæœï¼š${outcome}`);
          deferredPrompt = null;
        }
      }

      function log(message) {
        testResults.push(message);
        document.getElementById("test-results").textContent =
          testResults.join("\n");
      }

      // ç¶²è·¯ç‹€æ…‹ç›£è½
      window.addEventListener("online", () => {
        document.getElementById("online-status").textContent = "ç·šä¸Š";
        log("âœ“ ç¶²è·¯å·²é€£ç·š");
      });

      window.addEventListener("offline", () => {
        document.getElementById("online-status").textContent = "é›¢ç·š";
        log("âš  ç¶²è·¯å·²æ–·ç·š");
      });
    </script>
  </body>
</html>
